---
title: "Soundgen analysis of vocalizations"
author: "r"
date: "`r Sys.Date()`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float: yes
    df_print: paged
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: '3'
  html_notebook:
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This is an RMarkdown accompanying paper 'Exploring the sound structure of novel vocalizations' submitted for Evolang 2024. Here we provide the script for similarity analysis of sound signal.

Cite: Fuchs, S., Kadavá, Š., Pouw, W., Walker, B., Fay, N., Winter, B. & Cwiek, A.(2024) Exploring the sound structure of novel vocalizations. Proceedings of the 15th International Conference on the Evolution of Language (EvoLang XV)

First we set up our folders
```{r folders, message=FALSE, warning=FALSE}

# packages
library(soundgen) # sound analysis
library(readr)    # data wrangling
library(tidyr)
library(dplyr)


# get current working directory
curfolder   <- dirname(getwd())
audio_orig <- "../01_XDF_processing/data/Data_processed/Data_trials/Audio_48/"
processed_folder <- paste0(curfolder, "/03_TS_processing/TS_acoustics/")

# sanity check
#print(curfolder)

```

Then we gather all wav files
```{r wav files and other, message=FALSE, warning=FALSE}

# list all .wav files in the folder and its subdirectories
wav_files <- list.files(audio_orig, 
                        pattern = "\\.wav$", 
                        full.names = TRUE, 
                        recursive = TRUE)

```


# Extracting features from wav files

We use package 'soundgen' to extract a package of features for sound signal
More info here: https://www.rdocumentation.org/packages/soundgen/versions/2.6.0 or here: https://cogsci.se/soundgen/acoustic_analysis.html

We will extract all the features for a audiofile and save it as csv
```{r}

# This function extracts summary features from the analyze output
extract_features <- function(file, analyze_result) {
  features <- analyze_result$detailed
  # Add the filename as the first column
  df_features <- cbind(File = file, features)
  return(df_features)
}

# Loop over the .wav files in the directory and extract summary features
for (file in wav_files) {
  print(paste("Analyzing file:", file))
  tryCatch({
    # Read and analyze the audio file
    features <- analyze(file, windowLength = 20, step=10, pitchCeiling = 1000)
    
    # Extract features
    features_df <- extract_features(file, features)
    
    # Extract the base filename without the extension and path
    base_filename <- tools::file_path_sans_ext(basename(file))
    
    # Remove the specific substring from the base filename
    cleaned_filename <- gsub("Mic_nominal_srate48000_|pr_|trial_", "", base_filename)
    
    # Create the full path for the output CSV file, with 'soundgen_' prefix
    csv_filename <- paste0(processed_folder, "/soundgen_", cleaned_filename, ".csv")
    
    # Write the features to a CSV file
    write.csv(features_df, csv_filename, row.names = FALSE)
    
    print(paste("Saved features to:", csv_filename))
    
  }, warning = function(w) {
    print(paste("Warning while processing file:", file))
    print(w)
  }, error = function(e) {
    print(paste("Error while processing file:", file))
    print(e)
  })
}

```
