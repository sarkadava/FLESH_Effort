<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.552">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Processing I: Motion tracking and balance</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
        <div class="quarto-navbar-tools tools-end">
    <a href="https://bsky.app/profile/sarkadava.bsky.social" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-butterfly"></i></a>
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://code.com">
            Source Code
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://bugs.com">
            Report a Bug
            </a>
          </li>
      </ul>
    </div>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../01_XDF_processing/xdf_workflow.html">Processing</a></li><li class="breadcrumb-item"><a href="../03_TS_processing/01_TS_processing_motion.html">Processing I: Motion tracking and balance</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Processing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_XDF_processing/xdf_workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pre-Processing I: from XDF to raw files</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_MotionTracking_processing/01_Video_preparation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Motion tracking I: Preparation of videos</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_MotionTracking_processing/02_Track_OpenPose.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Motion tracking II: 2D pose estimation via OpenPose</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_MotionTracking_processing/03_Track_pose2sim.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Motion tracking III: Triangulation via Pose2sim</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_MotionTracking_processing/04_Track_InverseKinDyn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Motion tracking IV: Modeling inverse kinematics and dynamics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_TS_processing/01_TS_processing_motion.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Processing I: Motion tracking and balance</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_TS_processing/02_TS_processing_acoustics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Processing II: Acoustics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_TS_processing/03_TS_merging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Processing III: Merging multimodal data</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Time Series Annotation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_TS_movementAnnotation/01_Classify_preparation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Movement annotation I: Preparing training data and data for classifier</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_TS_movementAnnotation/02_MovementClassifier.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Movement annotation II: Training movement classifier, and annotating timeseries data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_TS_movementAnnotation/03_InterAgreement.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Movement annotation III: Computing interrater agreement between manual and automatic annotation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../05_finalMerge/TS_mergeAnnotations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Final merge</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../06_ConceptSimilarity/ConceptNet_similarity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Computing concept similarity using ConceptNet word embeddings</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../07_TS_featureExtraction/TS_extraction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Extraction of effort-related features</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../08_Analysis_XGBoost/01_PCA_featureDimensions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exploratory Analysis I: Using PCA to identify effort dimensions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../08_Analysis_XGBoost/02_XGBoost_effortIndicators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exploratory Analysis II: Identifying effort-related features contributing to misunderstanding resolution</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../09_Analysis_Modeling/Modelling_syntheticData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statistical Analysis: Modelling the Effect of Communicative Attempt (H1) and Answer Similarity (H2) on Effort</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#sec-procmot" id="toc-sec-procmot" class="nav-link active" data-scroll-target="#sec-procmot">Overview</a></li>
  <li><a href="#motion-processing---kinematics" id="toc-motion-processing---kinematics" class="nav-link" data-scroll-target="#motion-processing---kinematics">Motion processing - kinematics</a></li>
  <li><a href="#motion-processing---inverse-kinematics" id="toc-motion-processing---inverse-kinematics" class="nav-link" data-scroll-target="#motion-processing---inverse-kinematics">Motion processing - inverse kinematics</a></li>
  <li><a href="#motion-processing---inverse-dynamics" id="toc-motion-processing---inverse-dynamics" class="nav-link" data-scroll-target="#motion-processing---inverse-dynamics">Motion processing - inverse dynamics</a></li>
  <li><a href="#balance-board-ground-reaction-forces---processing" id="toc-balance-board-ground-reaction-forces---processing" class="nav-link" data-scroll-target="#balance-board-ground-reaction-forces---processing">Balance Board (Ground reaction forces) - processing</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../01_XDF_processing/xdf_workflow.html">Processing</a></li><li class="breadcrumb-item"><a href="../03_TS_processing/01_TS_processing_motion.html">Processing I: Motion tracking and balance</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Processing I: Motion tracking and balance</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="sec-procmot" class="level1">
<h1>Overview</h1>
<p>In the previous notebook, we have ran pose estimation on the trial videos using <a href="../02_MotionTracking_processing/02_Track_OpenPose.html#sec-openpose">OpenPose</a>, and triangulated the coordinates to get 3D coordinates for each trial using <a href="../02_MotionTracking_processing/03_Track_pose2sim.html#sec-pose2sim">Pose2sim</a>. Furthermore, we have performed inverse kinematics and dynamics to extract joint angles and moments using <a href="../02_MotionTracking_processing/04_Track_InverseKinDyn.html#sec-opensim">OpenSim</a>.</p>
<p>In this script, we will clean the 3D coordinates and joint angle data, and extract further information (such as speed, acceleration, etc.).</p>
<div id="5b577280" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code to load packages and prepare the environment</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>curfolder <span class="op">=</span> os.getcwd()</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># files to work with</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>MTfolder <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">..</span><span class="ch">\\</span><span class="st">02_MotionTracking_processing</span><span class="ch">\\</span><span class="st">projectdata</span><span class="ch">\\</span><span class="st">'</span> <span class="co">## FLAGGED CHANGE</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>BBfolder <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">..</span><span class="ch">\\</span><span class="st">01_XDF_processing</span><span class="ch">\\</span><span class="st">data</span><span class="ch">\\</span><span class="st">Data_processed</span><span class="ch">\\</span><span class="st">Data_trials</span><span class="ch">\\</span><span class="st">'</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># folders to save the processed data</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>MTfolder_processed <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">TS_motiontracking</span><span class="ch">\\</span><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="motion-processing---kinematics" class="level1">
<h1>Motion processing - kinematics</h1>
<p>Here we use the keypoint coordinates estimated via OpenPose and triangulated via Pose2Sim. While Pose2sim does provide in-built filter, it is not particularly strong and the data can be still noisy.</p>
<p>To decide on the smoothing strength, we can use a custom function <code>check_smooth_strength</code> to check the effect of different smoothing strengths on the data.</p>
<div id="4c853311" class="cell">
<details class="code-fold">
<summary>Code to prepare files to process</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>MTtotrack <span class="op">=</span> glob.glob(MTfolder <span class="op">+</span> <span class="st">'*/P*/*'</span>, recursive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># get rid of all the folders that are not the ones we want to track, like .sto files</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">## FLAG! why not do glob.glob(MTfolder + '*/P*/*butterworth*.csv', recursive=True)</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>MTtotrack <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> MTtotrack <span class="cf">if</span> <span class="st">'sto'</span> <span class="kw">not</span> <span class="kw">in</span> x]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>MTtotrack <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> MTtotrack <span class="cf">if</span> <span class="st">'txt'</span> <span class="kw">not</span> <span class="kw">in</span> x]</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>MTtotrack <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> MTtotrack <span class="cf">if</span> <span class="st">'xml'</span> <span class="kw">not</span> <span class="kw">in</span> x]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>MTtotrack <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> MTtotrack <span class="cf">if</span> <span class="st">'opensim'</span> <span class="kw">not</span> <span class="kw">in</span> x]</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>MTtotrack <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> MTtotrack <span class="cf">if</span> <span class="st">'Results'</span> <span class="kw">not</span> <span class="kw">in</span> x]</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>MTtotrack <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> MTtotrack <span class="cf">if</span> <span class="st">'toml'</span> <span class="kw">not</span> <span class="kw">in</span> x]</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(MTtotrack[<span class="dv">1</span>:<span class="dv">10</span>])</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>MTfiles_all <span class="op">=</span> []</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> folder <span class="kw">in</span> MTtotrack:</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># last element is trialid</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    trialid <span class="op">=</span> folder.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get all csv files in the folder</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    csvfiles <span class="op">=</span> glob.glob(folder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">**</span><span class="ch">\\</span><span class="st">*.csv'</span>, recursive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># keep only the ones that have butterworth in the name - those are filtered with native Pose2sim function</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    csvfiles <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> csvfiles <span class="cf">if</span> <span class="st">'butterworth'</span> <span class="kw">in</span> x]</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    butterfile <span class="op">=</span> csvfiles[<span class="dv">0</span>]</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># append to list with trialid</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    MTfiles_all.append([trialid, butterfile])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="e5e990b7" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function to check different smoothing windows and orders</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_smooth_strength(df, windows, orders, keytoplot):</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># prepare new df</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    df_smooth <span class="op">=</span> pd.DataFrame()</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> win <span class="kw">in</span> windows:</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="bu">ord</span> <span class="kw">in</span> orders:</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>            df_smooth[keytoplot <span class="op">+</span> <span class="st">'_savgol'</span> <span class="op">+</span> <span class="bu">str</span>(win) <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">ord</span>)] <span class="op">=</span> scipy.signal.savgol_filter(df[keytoplot], win, <span class="bu">ord</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make R_Hand_x from df_sample a list</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    keytoplot_unsmoothed <span class="op">=</span> df[keytoplot].tolist()</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load these values into df_smooth as a new column</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    df_smooth[keytoplot] <span class="op">=</span> keytoplot_unsmoothed</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot keytoplot in all strngths</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    colstoplot <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> df_smooth.columns <span class="cf">if</span> keytoplot <span class="kw">in</span> x]</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    plt.figure()</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> colstoplot:</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        plt.plot(df_smooth[col], label<span class="op">=</span>col)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here we can see a timeseries of vertical dimension of the left knee (note that pose2sim gave us y and z dimensions flipped, we will deal with this in a second). Each color represents the timeseries in different smoothed version, pink one is the raw signal (which is smoothed only with the Butterworth 10Hz cut-off filter). The first number in the legend corresponds to window length and the second number to polynomial order.</p>
<div id="e1e2bb9a" class="cell" data-execution_count="6">
<div class="cell-output cell-output-stdout">
<pre><code>e:\FLESH_ContinuousBodilyEffort\03_TS_processing\..\02_MotionTracking_processing\projectdata\Session_0_1\P0\0_1_24_p0\pose-3d\0_1_24_p0_0-342_filt_butterworth.trc.csv</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_TS_processing_motion_files/figure-html/cell-5-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here we can see different setting options for wrist.</p>
<div id="a80aea38" class="cell" data-execution_count="8">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_TS_processing_motion_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Legs seem to be more noisy than arms. One reason could be that legs are more commonly covered by clothes, which can make the pose estimation more prone to errors. Also, legs often stay without movement, making them more sensitive to noise.</p>
<p>For that reason, we opt for different smoothing strengths for leg-related keypoints than for upper body.</p>
<p>For lower body positional data, we will use 2nd polynomial Savitzky-Golay filter with window of 816 ms.</p>
<p>For upper body positional data, 3rd order Savitzky-Golay filter with window of 400 ms seems to be a good choice. We will use it both for raw coordinates as well as for the derivatives.</p>
<p>Further, we obtain the first, second and third derivative of the timeseries, namely speed, acceleration, and jerk. For derivatives, we will use 3rd order Savitzky-Golay filter with window of 400 ms for both.</p>
<p>Lastly, to be able to work with timeseries that represent bigger segment of body than a single joint, we aggregate the kinematic derivatives for each body group (i.e., head, upperbody, arms, lowerbody) by computing euclidian sum over every derivative belonging to the group. This gives us, for instance, a measure for arm speed that represents a sum of speeds of all keypoints associated with the arm (i.e., wrist, elbow, shoulder, index)</p>
<div id="058d4b5c" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code with functions for processing kinematic data</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function to get euclidian sum of associated keypoints</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> aggregate_keypoints(df, measurement, finalcolname, use):</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use <span class="op">==</span> <span class="st">'kinematics'</span>:</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># group keypoints that belong together</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        lowerbodycols <span class="op">=</span> [<span class="st">'RHip'</span>, <span class="st">'LHip'</span>]</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        legcols <span class="op">=</span> [<span class="st">'RKnee'</span>, <span class="st">'RAnkle'</span>, <span class="st">'LAnkle'</span>, <span class="st">'LKnee'</span>, <span class="st">'RHeel'</span>, <span class="st">'LHeel'</span>]</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        headcols <span class="op">=</span> [<span class="st">'Head'</span>, <span class="st">'Neck'</span>, <span class="st">'Nose'</span>]</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        armcols <span class="op">=</span> [<span class="st">'RShoulder'</span>, <span class="st">'RElbow'</span>, <span class="st">'RWrist'</span>, <span class="st">'LShoulder'</span>, <span class="st">'LElbow'</span>, <span class="st">'LWrist'</span>, <span class="st">'RIndex'</span>, <span class="st">'LIndex'</span>]</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        groups <span class="op">=</span> [lowerbodycols, legcols, headcols, armcols]</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> use <span class="op">==</span> <span class="st">'angles'</span>:</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        pelviscols <span class="op">=</span> [<span class="st">'pelvis'</span>]</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        spinecols <span class="op">=</span> [<span class="st">'L5_S1'</span>, <span class="st">'L4_L5'</span>, <span class="st">'L3_L4'</span>, <span class="st">'L2_L3'</span>, <span class="st">'L1_L2'</span>, <span class="st">'L1_T12'</span>]</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        lowerbodycols <span class="op">=</span> [<span class="st">'pelvis'</span>, <span class="st">'hip'</span>]</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        legcols <span class="op">=</span> [<span class="st">'knee'</span>, <span class="st">'ankle'</span>, <span class="st">'subtalar'</span>]</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        headcols <span class="op">=</span> [<span class="st">'neck'</span>]</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        armcols <span class="op">=</span> [<span class="st">'arm'</span>, <span class="st">'elbow'</span>, <span class="st">'wrist'</span>, <span class="st">'pro_sup'</span>]</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        groups <span class="op">=</span> [lowerbodycols, legcols, headcols, armcols, pelviscols, spinecols]</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make subdf only with speed</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    subdf <span class="op">=</span> df[[x <span class="cf">for</span> x <span class="kw">in</span> df.columns <span class="cf">if</span> measurement <span class="kw">in</span> x]]</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># loop through each joint group</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> group <span class="kw">in</span> groups:</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get cols</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        cols <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> subdf.columns <span class="cf">if</span> <span class="bu">any</span>(y <span class="kw">in</span> x <span class="cf">for</span> y <span class="kw">in</span> group)]</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        subdf_temp <span class="op">=</span> subdf[cols]</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> index, row <span class="kw">in</span> subdf_temp.iterrows():</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>            <span class="co"># get all values of that row</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>            values <span class="op">=</span> row.values</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>            <span class="co"># calculate euclidian sum</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>            euclidian_sum <span class="op">=</span> np.sqrt(np.<span class="bu">sum</span>(np.square(values))) <span class="co">## FLAGGED: possibly normalize</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>            <span class="co"># get a name for new col</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> group <span class="op">==</span> lowerbodycols:</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>                colname <span class="op">=</span> <span class="st">'lowerbody'</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> group <span class="op">==</span> legcols:</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>                colname <span class="op">=</span> <span class="st">'leg'</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> group <span class="op">==</span> headcols:</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>                colname <span class="op">=</span> <span class="st">'head'</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> group <span class="op">==</span> armcols:</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>                colname <span class="op">=</span> <span class="st">'arm'</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> group <span class="op">==</span> pelviscols:</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>                colname <span class="op">=</span> <span class="st">'pelvis'</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> group <span class="op">==</span> spinecols:</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>                colname <span class="op">=</span> <span class="st">'spine'</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>            df.loc[index, colname <span class="op">+</span> finalcolname] <span class="op">=</span> euclidian_sum</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a><span class="co"># get kinematic derivatives</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_derivatives(df, sr, upperbodycols, lowerbodycols, use):</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>    mtcols <span class="op">=</span> df.columns</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> use <span class="op">==</span> <span class="st">'kinematics'</span>:</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get rid of cols that are not x, y or z</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>        mtcols <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> mtcols <span class="cf">if</span> <span class="st">'_x'</span> <span class="kw">in</span> x <span class="kw">or</span> <span class="st">'_y'</span> <span class="kw">in</span> x <span class="kw">or</span> <span class="st">'_z'</span> <span class="kw">in</span> x]</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># prepare cols for speed</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>        cols <span class="op">=</span> [x.split(<span class="st">'_'</span>)[<span class="dv">0</span>] <span class="cf">for</span> x <span class="kw">in</span> mtcols]</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>        colsforspeed <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(cols))</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for each unique colname (cols), calculate speed </span></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> colsforspeed:</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>            <span class="co"># get x and y columns</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> df[col <span class="op">+</span> <span class="st">'_x'</span>]</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> df[col <span class="op">+</span> <span class="st">'_y'</span>]</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>            z <span class="op">=</span> df[col <span class="op">+</span> <span class="st">'_z'</span>] <span class="co"># note that y and z are flipped</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>            <span class="co"># calculate speed</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>            speed <span class="op">=</span> np.insert(np.sqrt(np.diff(x)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> np.diff(y)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> np.diff(z)<span class="op">**</span><span class="dv">2</span>),<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>            <span class="co"># multiply the values by sr, because now we have values in m/(s/sr)</span></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>            speed <span class="op">=</span> speed<span class="op">*</span>sr</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>            <span class="co"># smooth</span></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>            speed <span class="op">=</span> scipy.signal.savgol_filter(speed, <span class="dv">25</span>, <span class="dv">3</span>)</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>            <span class="co"># if the col contains wrist, we will alco calculate the vertical velocity (z dimension)</span></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'Wrist'</span> <span class="kw">in</span> col:</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>                verticvel <span class="op">=</span> np.insert(np.diff(z), <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>                verticvel <span class="op">=</span> verticvel<span class="op">*</span>sr</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>                verticvel <span class="op">=</span> scipy.signal.savgol_filter(verticvel, <span class="dv">25</span>, <span class="dv">3</span>)</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>            <span class="co"># derive acceleration   </span></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>            acceleration <span class="op">=</span> np.insert(np.diff(speed), <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>            acceleration <span class="op">=</span> scipy.signal.savgol_filter(acceleration, <span class="dv">25</span>, <span class="dv">3</span>)</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>            <span class="co"># derive jerk</span></span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>            jerk <span class="op">=</span> np.insert(np.diff(acceleration), <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>            jerk <span class="op">=</span> scipy.signal.savgol_filter(jerk, <span class="dv">25</span>, <span class="dv">3</span>)</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>            <span class="co"># new_data</span></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>            new_data <span class="op">=</span> pd.DataFrame({col <span class="op">+</span> <span class="st">'_speed'</span>: speed, col <span class="op">+</span> <span class="st">'_acc'</span>: acceleration, col <span class="op">+</span> <span class="st">'_jerk'</span>: jerk})</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> pd.concat([df, new_data], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> use <span class="op">==</span> <span class="st">'angles'</span>:</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get rid of cols that are not angles (so skip time)</span></span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>        mtcols <span class="op">=</span> mtcols[<span class="dv">1</span>:]</span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>        <span class="co"># derive speed</span></span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> mtcols:</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>            speed <span class="op">=</span> np.insert(np.diff(df[col]), <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>            speed <span class="op">=</span> speed<span class="op">*</span>sr</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>            speed <span class="op">=</span> scipy.signal.savgol_filter(speed, <span class="dv">35</span>, <span class="dv">1</span>)</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>            <span class="co"># derive acceleration</span></span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>            acceleration <span class="op">=</span> np.insert(np.diff(speed), <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>            acceleration <span class="op">=</span> scipy.signal.savgol_filter(acceleration, <span class="dv">35</span>, <span class="dv">1</span>)</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>            <span class="co"># derive jerk</span></span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>            jerk <span class="op">=</span> np.insert(np.diff(acceleration), <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>            jerk <span class="op">=</span> scipy.signal.savgol_filter(jerk, <span class="dv">35</span>, <span class="dv">1</span>)</span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>            <span class="co"># new_data</span></span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>            new_data <span class="op">=</span> pd.DataFrame({col <span class="op">+</span> <span class="st">'_speed'</span>: speed, col <span class="op">+</span> <span class="st">'_acc'</span>: acceleration, col <span class="op">+</span> <span class="st">'_jerk'</span>: jerk})</span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> pd.concat([df, new_data], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="62d1e028" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># upper body cols</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>upperbodycols <span class="op">=</span> [<span class="st">'Head'</span>, <span class="st">'Neck'</span>, <span class="st">'RShoulder'</span>, <span class="st">'RElbow'</span>, <span class="st">'RWrist'</span>, <span class="st">'LShoulder'</span>, <span class="st">'LElbow'</span>, <span class="st">'LWrist'</span>, <span class="st">'Nose'</span>, <span class="st">'RIndex'</span>, <span class="st">'LIndex'</span>]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># lower body cols</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>lowerbodycols <span class="op">=</span> [<span class="st">'RHip'</span>, <span class="st">'RKnee'</span>, <span class="st">'RAnkle'</span>, <span class="st">'RHeel'</span>, <span class="st">'LHip'</span>, <span class="st">'LKnee'</span>, <span class="st">'LAnkle'</span>, <span class="st">'LHeel'</span>]</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> folder <span class="kw">in</span> MTtotrack:</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># last element is trialid</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    trialid <span class="op">=</span> folder.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'working on:'</span> <span class="op">+</span> trialid)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get all csv files in the folder</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    csvfiles <span class="op">=</span> glob.glob(folder <span class="op">+</span> <span class="st">'/**/*.csv'</span>, recursive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># keep only the ones that have butterworth in the name</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    csvfiles <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> csvfiles <span class="cf">if</span> <span class="st">'butterworth'</span> <span class="kw">in</span> x]</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    butterfile <span class="op">=</span> csvfiles[<span class="dv">0</span>]</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load it</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    mt <span class="op">=</span> pd.read_csv(butterfile)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the mt is missing 0 ms timepoint, so we need to create a row that copies the first row of mt and time = 0</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    padrow <span class="op">=</span> mt.iloc[<span class="dv">0</span>].copy()</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    padrow[<span class="st">'Time'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># concatenate it to the beginning of mt </span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    mt <span class="op">=</span> pd.concat([pd.DataFrame(padrow).T, mt], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># keep only cols of interest</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    colstokeep <span class="op">=</span> [<span class="st">"Time"</span>, <span class="st">"RHip"</span>, <span class="st">"RKnee"</span>, <span class="st">"RAnkle"</span>, <span class="st">"RHeel"</span>, <span class="st">"LHip"</span>, <span class="st">"LKnee"</span>, <span class="st">"LAnkle"</span>, <span class="st">"LHeel"</span>, <span class="st">"Neck"</span>, <span class="st">"Head"</span>, <span class="st">"Nose"</span>, <span class="st">"RShoulder"</span>, <span class="st">"RElbow"</span>, <span class="st">"RWrist"</span>, <span class="st">"RIndex"</span>, <span class="st">"LShoulder"</span>, <span class="st">"LElbow"</span>, <span class="st">"LWrist"</span>,</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"LIndex"</span>,</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    mt <span class="op">=</span> mt[[col <span class="cf">for</span> col <span class="kw">in</span> mt.columns <span class="cf">if</span> <span class="bu">any</span>(x <span class="kw">in</span> col <span class="cf">for</span> x <span class="kw">in</span> colstokeep)]]</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># flip y and z dimension as they are reversed from OpenPose/Pose2sim</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if col has _y in it, replace it by _temp</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    mt.columns <span class="op">=</span> [x.replace(<span class="st">'_y'</span>, <span class="st">'_temp'</span>) <span class="cf">for</span> x <span class="kw">in</span> mt.columns]</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># replace _z by _y</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    mt.columns <span class="op">=</span> [x.replace(<span class="st">'_z'</span>, <span class="st">'_y'</span>) <span class="cf">for</span> x <span class="kw">in</span> mt.columns]</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># replace _temp by _z</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    mt.columns <span class="op">=</span> [x.replace(<span class="st">'_temp'</span>, <span class="st">'_z'</span>) <span class="cf">for</span> x <span class="kw">in</span> mt.columns]</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">####### SMOOTHING ######</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># smooth all columns except time with savgol</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    mtcols <span class="op">=</span> mt.columns</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    colstosmooth <span class="op">=</span> mtcols[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    mt_smooth <span class="op">=</span> pd.DataFrame()</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> colstosmooth:</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>        colname <span class="op">=</span> col.split(<span class="st">'_'</span>)[<span class="dv">0</span>] <span class="co"># to get rid of _x, _y, _z</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> colname <span class="kw">in</span> upperbodycols:</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>            mt_smooth[col] <span class="op">=</span> scipy.signal.savgol_filter(mt[col], <span class="dv">25</span>, <span class="dv">3</span>)</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> colname <span class="kw">in</span> lowerbodycols:</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>            mt_smooth[col] <span class="op">=</span> scipy.signal.savgol_filter(mt[col], <span class="dv">51</span>, <span class="dv">2</span>)</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># And put them all to cms</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>    mt_smooth <span class="op">=</span> mt_smooth<span class="op">*</span><span class="dv">100</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add back time column</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    mt_smooth[<span class="st">'Time'</span>] <span class="op">=</span> mt[<span class="st">'Time'</span>]</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get sampling rate</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>    sr <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>np.mean(np.diff(mt[<span class="st">'Time'</span>]))</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">###### DERIVATIVES ######</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get kinematic derivatives</span></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>    mt_smooth <span class="op">=</span> get_derivatives(mt_smooth, sr, upperbodycols, lowerbodycols, <span class="st">'kinematics'</span>)</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">###### AGGREGATING ######</span></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># getting aggreagated sums for groups of cols</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>    mt_smooth <span class="op">=</span> aggregate_keypoints(mt_smooth, <span class="st">'speed'</span>, <span class="st">'_speedKin_sum'</span>, <span class="st">'kinematics'</span>)</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>    mt_smooth <span class="op">=</span> aggregate_keypoints(mt_smooth, <span class="st">'acc'</span>, <span class="st">'_accKin_sum'</span>, <span class="st">'kinematics'</span>)</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>    mt_smooth <span class="op">=</span> aggregate_keypoints(mt_smooth, <span class="st">'jerk'</span>, <span class="st">'_jerkKin_sum'</span>, <span class="st">'kinematics'</span>)</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add trialid</span></span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    mt_smooth[<span class="st">'TrialID'</span>] <span class="op">=</span> trialid</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert time to ms</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>    mt_smooth[<span class="st">'Time'</span>] <span class="op">=</span> mt_smooth[<span class="st">'Time'</span>]<span class="op">*</span><span class="dv">1000</span></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># write to csv</span></span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>    mt_smooth.to_csv(MTfolder_processed <span class="op">+</span> <span class="st">'/mt_'</span> <span class="op">+</span> trialid <span class="op">+</span> <span class="st">'.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is an example of the file</p>
<div id="61f86e62" class="cell" data-execution_count="23">
<div class="cell-output cell-output-display" data-execution_count="23">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">RHip_x</th>
<th data-quarto-table-cell-role="th">RHip_z</th>
<th data-quarto-table-cell-role="th">RHip_y</th>
<th data-quarto-table-cell-role="th">RKnee_x</th>
<th data-quarto-table-cell-role="th">RKnee_z</th>
<th data-quarto-table-cell-role="th">RKnee_y</th>
<th data-quarto-table-cell-role="th">RAnkle_x</th>
<th data-quarto-table-cell-role="th">RAnkle_z</th>
<th data-quarto-table-cell-role="th">RAnkle_y</th>
<th data-quarto-table-cell-role="th">RHeel_x</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">arm_speedKin_sum</th>
<th data-quarto-table-cell-role="th">lowerbody_accKin_sum</th>
<th data-quarto-table-cell-role="th">leg_accKin_sum</th>
<th data-quarto-table-cell-role="th">head_accKin_sum</th>
<th data-quarto-table-cell-role="th">arm_accKin_sum</th>
<th data-quarto-table-cell-role="th">lowerbody_jerkKin_sum</th>
<th data-quarto-table-cell-role="th">leg_jerkKin_sum</th>
<th data-quarto-table-cell-role="th">head_jerkKin_sum</th>
<th data-quarto-table-cell-role="th">arm_jerkKin_sum</th>
<th data-quarto-table-cell-role="th">TrialID</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>12.186808</td>
<td>23.129494</td>
<td>1.692073</td>
<td>15.110699</td>
<td>22.532687</td>
<td>-38.543548</td>
<td>16.437185</td>
<td>22.694474</td>
<td>-74.834063</td>
<td>18.996019</td>
<td>...</td>
<td>26.083522</td>
<td>0.225640</td>
<td>0.590822</td>
<td>0.161665</td>
<td>1.651498</td>
<td>0.022804</td>
<td>0.046088</td>
<td>0.092108</td>
<td>0.341816</td>
<td>0_2_31_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>12.195677</td>
<td>23.108011</td>
<td>1.675542</td>
<td>15.147758</td>
<td>22.574564</td>
<td>-38.544712</td>
<td>16.440867</td>
<td>22.691252</td>
<td>-74.855128</td>
<td>18.976731</td>
<td>...</td>
<td>23.961073</td>
<td>0.187954</td>
<td>0.502362</td>
<td>0.027073</td>
<td>1.414454</td>
<td>0.024985</td>
<td>0.058605</td>
<td>0.082632</td>
<td>0.300132</td>
<td>0_2_31_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>12.204523</td>
<td>23.086249</td>
<td>1.660162</td>
<td>15.183910</td>
<td>22.615387</td>
<td>-38.545741</td>
<td>16.444388</td>
<td>22.688281</td>
<td>-74.874888</td>
<td>18.957985</td>
<td>...</td>
<td>22.197559</td>
<td>0.154021</td>
<td>0.417187</td>
<td>0.100069</td>
<td>1.315854</td>
<td>0.028136</td>
<td>0.068901</td>
<td>0.072654</td>
<td>0.261180</td>
<td>0_2_31_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>12.213347</td>
<td>23.064209</td>
<td>1.645932</td>
<td>15.219154</td>
<td>22.655155</td>
<td>-38.546635</td>
<td>16.447747</td>
<td>22.685561</td>
<td>-74.893344</td>
<td>18.939780</td>
<td>...</td>
<td>20.747395</td>
<td>0.123840</td>
<td>0.335606</td>
<td>0.187785</td>
<td>1.297296</td>
<td>0.030733</td>
<td>0.076200</td>
<td>0.062197</td>
<td>0.224556</td>
<td>0_2_31_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>12.222149</td>
<td>23.041892</td>
<td>1.632852</td>
<td>15.253492</td>
<td>22.693868</td>
<td>-38.547393</td>
<td>16.450944</td>
<td>22.683094</td>
<td>-74.910496</td>
<td>18.922118</td>
<td>...</td>
<td>19.573630</td>
<td>0.097610</td>
<td>0.258204</td>
<td>0.252369</td>
<td>1.303122</td>
<td>0.032213</td>
<td>0.080447</td>
<td>0.051345</td>
<td>0.190306</td>
<td>0_2_31_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>12.230929</td>
<td>23.019295</td>
<td>1.620923</td>
<td>15.286921</td>
<td>22.731526</td>
<td>-38.548016</td>
<td>16.453979</td>
<td>22.680877</td>
<td>-74.926343</td>
<td>18.904998</td>
<td>...</td>
<td>18.646790</td>
<td>0.075868</td>
<td>0.186154</td>
<td>0.295498</td>
<td>1.297513</td>
<td>0.032427</td>
<td>0.081814</td>
<td>0.040245</td>
<td>0.159050</td>
<td>0_2_31_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>12.239686</td>
<td>22.996421</td>
<td>1.610143</td>
<td>15.319444</td>
<td>22.768130</td>
<td>-38.548503</td>
<td>16.456853</td>
<td>22.678913</td>
<td>-74.940886</td>
<td>18.888420</td>
<td>...</td>
<td>17.942303</td>
<td>0.059671</td>
<td>0.122439</td>
<td>0.319353</td>
<td>1.262916</td>
<td>0.031396</td>
<td>0.080561</td>
<td>0.029151</td>
<td>0.132192</td>
<td>0_2_31_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>12.248421</td>
<td>22.973268</td>
<td>1.600514</td>
<td>15.351059</td>
<td>22.803679</td>
<td>-38.548855</td>
<td>16.459565</td>
<td>22.677200</td>
<td>-74.954125</td>
<td>18.872383</td>
<td>...</td>
<td>17.436996</td>
<td>0.050448</td>
<td>0.077330</td>
<td>0.326231</td>
<td>1.193408</td>
<td>0.029216</td>
<td>0.076991</td>
<td>0.018637</td>
<td>0.112128</td>
<td>0_2_31_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>12.257134</td>
<td>22.949838</td>
<td>1.592035</td>
<td>15.381767</td>
<td>22.838172</td>
<td>-38.549072</td>
<td>16.462115</td>
<td>22.675738</td>
<td>-74.966060</td>
<td>18.856889</td>
<td>...</td>
<td>17.105498</td>
<td>0.048612</td>
<td>0.076136</td>
<td>0.318539</td>
<td>1.089850</td>
<td>0.026020</td>
<td>0.071432</td>
<td>0.010923</td>
<td>0.101805</td>
<td>0_2_31_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>12.265825</td>
<td>22.926129</td>
<td>1.584706</td>
<td>15.411567</td>
<td>22.871611</td>
<td>-38.549153</td>
<td>16.464503</td>
<td>22.674528</td>
<td>-74.976690</td>
<td>18.841937</td>
<td>...</td>
<td>16.917416</td>
<td>0.052072</td>
<td>0.111844</td>
<td>0.298855</td>
<td>0.957421</td>
<td>0.021964</td>
<td>0.064229</td>
<td>0.012538</td>
<td>0.102606</td>
<td>0_2_31_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>12.274493</td>
<td>22.902141</td>
<td>1.578528</td>
<td>15.440461</td>
<td>22.903995</td>
<td>-38.549099</td>
<td>16.466730</td>
<td>22.673569</td>
<td>-74.986016</td>
<td>18.827527</td>
<td>...</td>
<td>16.835927</td>
<td>0.057658</td>
<td>0.155242</td>
<td>0.270077</td>
<td>0.805033</td>
<td>0.017219</td>
<td>0.055746</td>
<td>0.020884</td>
<td>0.112358</td>
<td>0_2_31_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>12.283139</td>
<td>22.877876</td>
<td>1.573500</td>
<td>15.468446</td>
<td>22.935325</td>
<td>-38.548910</td>
<td>16.468795</td>
<td>22.672862</td>
<td>-74.994038</td>
<td>18.813659</td>
<td>...</td>
<td>16.817918</td>
<td>0.063030</td>
<td>0.196240</td>
<td>0.235745</td>
<td>0.646906</td>
<td>0.011987</td>
<td>0.046385</td>
<td>0.030254</td>
<td>0.126842</td>
<td>0_2_31_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>12.291763</td>
<td>22.853332</td>
<td>1.569622</td>
<td>15.495525</td>
<td>22.965599</td>
<td>-38.548585</td>
<td>16.470699</td>
<td>22.672407</td>
<td>-75.000755</td>
<td>18.800334</td>
<td>...</td>
<td>16.815337</td>
<td>0.066837</td>
<td>0.231722</td>
<td>0.200699</td>
<td>0.508104</td>
<td>0.006598</td>
<td>0.036625</td>
<td>0.039232</td>
<td>0.142296</td>
<td>0_2_31_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>12.300364</td>
<td>22.828510</td>
<td>1.566894</td>
<td>15.521696</td>
<td>22.994819</td>
<td>-38.548124</td>
<td>16.472440</td>
<td>22.672203</td>
<td>-75.006168</td>
<td>18.787550</td>
<td>...</td>
<td>14.656360</td>
<td>0.081540</td>
<td>0.284913</td>
<td>0.187160</td>
<td>0.383159</td>
<td>0.002108</td>
<td>0.025516</td>
<td>0.053032</td>
<td>0.173949</td>
<td>0_2_31_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>12.308943</td>
<td>22.803410</td>
<td>1.565317</td>
<td>15.546960</td>
<td>23.022984</td>
<td>-38.547529</td>
<td>16.474020</td>
<td>22.672250</td>
<td>-75.010277</td>
<td>18.775308</td>
<td>...</td>
<td>15.012604</td>
<td>0.080498</td>
<td>0.279402</td>
<td>0.182591</td>
<td>0.443300</td>
<td>0.007590</td>
<td>0.018007</td>
<td>0.059507</td>
<td>0.170806</td>
<td>0_2_31_p1</td>
</tr>
</tbody>
</table>

<p>15 rows  128 columns</p>
</div>
</div>
</div>
</div>
<p>Lets check one file to see how the data looks like by plotting RWrist and its kinematics, and also the euclidian sum for the whole arm along with it (as dashed black line)</p>
<p>Note that aggregates will always be directionless (i.e., in positive numbers) as they are squared when computed.</p>
<div id="b0809c81" class="cell" data-execution_count="11">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_TS_processing_motion_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="motion-processing---inverse-kinematics" class="level1">
<h1>Motion processing - inverse kinematics</h1>
<p>In the previous notebook, we have extracted joint angles using OpenSim (<span class="citation" data-cites="seth_etal18">Seth et al. (<a href="#ref-seth_etal18" role="doc-biblioref">26. 7. 2018</a>)</span>). Now again, we clean the data, smooth them, and extract further information before saving it into csv file per trial</p>
<p>We can once again check what would be the proper filter</p>
<div id="4a719539" class="cell" data-execution_count="25">
<details class="code-fold">
<summary>Code to prepare environment</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get all mot files in the folder</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>mot_files <span class="op">=</span> glob.glob(MTfolder <span class="op">+</span> <span class="st">'*/P*/*/*.mot'</span>, recursive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>keypoints <span class="op">=</span> [<span class="st">'wrist'</span>, <span class="st">'pro_sup'</span>, <span class="st">'elbow'</span>, <span class="st">'arm'</span>, <span class="st">'neck'</span>, <span class="st">'subtalar'</span>, <span class="st">'ankle'</span>, <span class="st">'knee'</span>, <span class="st">'hip'</span>, <span class="st">'pelvis'</span>, <span class="st">'L5_S1'</span>, <span class="st">'L4_L5'</span>, <span class="st">'L3_L4'</span>, <span class="st">'L2_L3'</span>, <span class="st">'L1_L2'</span>, <span class="st">'L1_T12'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="1d259157" class="cell" data-execution_count="27">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_TS_processing_motion_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>And for legs</p>
<div id="02ca281b" class="cell" data-execution_count="28">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_TS_processing_motion_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We will apply a bit stronger filter of 1st order with span of 560 ms because the data are more noisy than the kinematics.</p>
<div id="6d669aec" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get all mot files in the folder</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>mot_files <span class="op">=</span> glob.glob(MTfolder <span class="op">+</span> <span class="st">'*/P*/*/*.mot'</span>, recursive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>keypoints <span class="op">=</span> [<span class="st">'wrist'</span>, <span class="st">'pro_sup'</span>, <span class="st">'elbow'</span>, <span class="st">'arm'</span>, <span class="st">'neck'</span>, <span class="st">'subtalar'</span>, <span class="st">'ankle'</span>, <span class="st">'knee'</span>, <span class="st">'hip'</span>, <span class="st">'pelvis'</span>, <span class="st">'L5_S1'</span>, <span class="st">'L4_L5'</span>, <span class="st">'L3_L4'</span>, <span class="st">'L2_L3'</span>, <span class="st">'L1_L2'</span>, <span class="st">'L1_T12'</span>]</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> mot <span class="kw">in</span> mot_files:</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get trialid</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    trialid <span class="op">=</span> mot.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'working on '</span> <span class="op">+</span> trialid)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get rid of the first element before _</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    trialid <span class="op">=</span> <span class="st">'_'</span>.join(trialid.split(<span class="st">'_'</span>)[<span class="dv">1</span>:])</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load it</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    mot_df <span class="op">=</span> pd.read_csv(mot, sep<span class="op">=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, skiprows<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pad 0 ms row</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    padrow <span class="op">=</span> mot_df.iloc[<span class="dv">0</span>].copy()</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    padrow[<span class="st">'time'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># concatenate it to the beginning of mot_df</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    mot_df <span class="op">=</span> pd.concat([pd.DataFrame(padrow).T, mot_df], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get the sr</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    sr <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>np.mean(np.diff(mot_df[<span class="st">'time'</span>]))</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">##### SMOOTHING ######</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># smooth all columns except the firts time (time) and last (trialid)</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    colstosmooth <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> mot_df.columns <span class="cf">if</span> <span class="st">'time'</span> <span class="kw">not</span> <span class="kw">in</span> x]</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># smooth</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> colstosmooth:</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        mot_df[col] <span class="op">=</span> scipy.signal.savgol_filter(mot_df[col], <span class="dv">35</span>, <span class="dv">1</span>)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># convert to radians</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        mot_df[col] <span class="op">=</span> np.deg2rad(mot_df[col])</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># keep only columns you might use</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    coi <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> mot_df.columns <span class="cf">if</span> <span class="bu">any</span>(y <span class="kw">in</span> x <span class="cf">for</span> y <span class="kw">in</span> keypoints) <span class="kw">or</span> <span class="st">'time'</span> <span class="kw">in</span> x <span class="kw">or</span> <span class="st">'TrialID'</span> <span class="kw">in</span> x]</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    mot_df2 <span class="op">=</span> mot_df[coi]</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">##### DERIVATIVES ######</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get derivatives</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    mot_df2 <span class="op">=</span> get_derivatives(mot_df2, sr, [], [], <span class="st">'angles'</span>)</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">#### AGGREGATING #####</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># aggregate data</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    mot_df2 <span class="op">=</span> aggregate_keypoints(mot_df2, <span class="st">'speed'</span>, <span class="st">'_angSpeed_sum'</span>, <span class="st">'angles'</span>)</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    mot_df2 <span class="op">=</span> aggregate_keypoints(mot_df2, <span class="st">'acc'</span>, <span class="st">'_angAcc_sum'</span>, <span class="st">'angles'</span>)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>    mot_df2 <span class="op">=</span> aggregate_keypoints(mot_df2, <span class="st">'jerk'</span>, <span class="st">'_angJerk_sum'</span>, <span class="st">'angles'</span>)</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add time and trialid</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>    mot_df2[<span class="st">'time'</span>] <span class="op">=</span> mot_df[<span class="st">'time'</span>]</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert time to ms</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>    mot_df2[<span class="st">'time'</span>] <span class="op">=</span> mot_df2[<span class="st">'time'</span>]<span class="op">*</span><span class="dv">1000</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>    mot_df2[<span class="st">'TrialID'</span>] <span class="op">=</span> trialid</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># write to csv</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>    mot_df2.to_csv(MTfolder_processed <span class="op">+</span> <span class="st">'/ik_'</span> <span class="op">+</span> trialid <span class="op">+</span> <span class="st">'.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is an example file</p>
<div id="c2269871" class="cell" data-execution_count="30">
<div class="cell-output cell-output-display" data-execution_count="30">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">time</th>
<th data-quarto-table-cell-role="th">pelvis_tilt</th>
<th data-quarto-table-cell-role="th">pelvis_list</th>
<th data-quarto-table-cell-role="th">pelvis_rotation</th>
<th data-quarto-table-cell-role="th">pelvis_tx</th>
<th data-quarto-table-cell-role="th">pelvis_ty</th>
<th data-quarto-table-cell-role="th">pelvis_tz</th>
<th data-quarto-table-cell-role="th">hip_flexion_r</th>
<th data-quarto-table-cell-role="th">hip_adduction_r</th>
<th data-quarto-table-cell-role="th">hip_rotation_r</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">arm_angAcc_sum</th>
<th data-quarto-table-cell-role="th">pelvis_angAcc_sum</th>
<th data-quarto-table-cell-role="th">spine_angAcc_sum</th>
<th data-quarto-table-cell-role="th">lowerbody_angJerk_sum</th>
<th data-quarto-table-cell-role="th">leg_angJerk_sum</th>
<th data-quarto-table-cell-role="th">head_angJerk_sum</th>
<th data-quarto-table-cell-role="th">arm_angJerk_sum</th>
<th data-quarto-table-cell-role="th">pelvis_angJerk_sum</th>
<th data-quarto-table-cell-role="th">spine_angJerk_sum</th>
<th data-quarto-table-cell-role="th">TrialID</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.000</td>
<td>-0.494779</td>
<td>1.465690</td>
<td>-1.092904</td>
<td>0.003865</td>
<td>0.002655</td>
<td>0.002283</td>
<td>0.088633</td>
<td>0.017501</td>
<td>-0.290667</td>
<td>...</td>
<td>0.030528</td>
<td>0.016054</td>
<td>0.002946</td>
<td>0.000372</td>
<td>0.000162</td>
<td>0.000206</td>
<td>0.000611</td>
<td>0.000305</td>
<td>0.000047</td>
<td>0_1_13_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>16.667</td>
<td>-0.491722</td>
<td>1.464707</td>
<td>-1.094887</td>
<td>0.003866</td>
<td>0.002649</td>
<td>0.002285</td>
<td>0.087100</td>
<td>0.017773</td>
<td>-0.290882</td>
<td>...</td>
<td>0.030335</td>
<td>0.016026</td>
<td>0.002918</td>
<td>0.000340</td>
<td>0.000164</td>
<td>0.000205</td>
<td>0.000585</td>
<td>0.000274</td>
<td>0.000046</td>
<td>0_1_13_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>33.333</td>
<td>-0.488665</td>
<td>1.463725</td>
<td>-1.096871</td>
<td>0.003868</td>
<td>0.002642</td>
<td>0.002288</td>
<td>0.085566</td>
<td>0.018045</td>
<td>-0.291098</td>
<td>...</td>
<td>0.030151</td>
<td>0.015998</td>
<td>0.002890</td>
<td>0.000309</td>
<td>0.000168</td>
<td>0.000204</td>
<td>0.000562</td>
<td>0.000243</td>
<td>0.000044</td>
<td>0_1_13_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>50.000</td>
<td>-0.485609</td>
<td>1.462742</td>
<td>-1.098855</td>
<td>0.003870</td>
<td>0.002636</td>
<td>0.002290</td>
<td>0.084033</td>
<td>0.018318</td>
<td>-0.291313</td>
<td>...</td>
<td>0.029977</td>
<td>0.015971</td>
<td>0.002863</td>
<td>0.000281</td>
<td>0.000172</td>
<td>0.000204</td>
<td>0.000542</td>
<td>0.000214</td>
<td>0.000043</td>
<td>0_1_13_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>66.667</td>
<td>-0.482552</td>
<td>1.461759</td>
<td>-1.100839</td>
<td>0.003872</td>
<td>0.002630</td>
<td>0.002293</td>
<td>0.082500</td>
<td>0.018590</td>
<td>-0.291528</td>
<td>...</td>
<td>0.029813</td>
<td>0.015944</td>
<td>0.002837</td>
<td>0.000256</td>
<td>0.000178</td>
<td>0.000203</td>
<td>0.000526</td>
<td>0.000186</td>
<td>0.000043</td>
<td>0_1_13_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>83.333</td>
<td>-0.479495</td>
<td>1.460777</td>
<td>-1.102823</td>
<td>0.003874</td>
<td>0.002623</td>
<td>0.002295</td>
<td>0.080967</td>
<td>0.018862</td>
<td>-0.291743</td>
<td>...</td>
<td>0.029658</td>
<td>0.015919</td>
<td>0.002811</td>
<td>0.000235</td>
<td>0.000185</td>
<td>0.000202</td>
<td>0.000514</td>
<td>0.000160</td>
<td>0.000042</td>
<td>0_1_13_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>100.000</td>
<td>-0.476438</td>
<td>1.459794</td>
<td>-1.104807</td>
<td>0.003876</td>
<td>0.002617</td>
<td>0.002298</td>
<td>0.079434</td>
<td>0.019134</td>
<td>-0.291958</td>
<td>...</td>
<td>0.029514</td>
<td>0.015894</td>
<td>0.002786</td>
<td>0.000219</td>
<td>0.000194</td>
<td>0.000202</td>
<td>0.000505</td>
<td>0.000136</td>
<td>0.000042</td>
<td>0_1_13_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>116.667</td>
<td>-0.473381</td>
<td>1.458812</td>
<td>-1.106791</td>
<td>0.003878</td>
<td>0.002610</td>
<td>0.002300</td>
<td>0.077901</td>
<td>0.019407</td>
<td>-0.292173</td>
<td>...</td>
<td>0.029380</td>
<td>0.015870</td>
<td>0.002761</td>
<td>0.000209</td>
<td>0.000202</td>
<td>0.000201</td>
<td>0.000502</td>
<td>0.000118</td>
<td>0.000043</td>
<td>0_1_13_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>133.333</td>
<td>-0.470325</td>
<td>1.457829</td>
<td>-1.108775</td>
<td>0.003880</td>
<td>0.002604</td>
<td>0.002303</td>
<td>0.076367</td>
<td>0.019679</td>
<td>-0.292388</td>
<td>...</td>
<td>0.029256</td>
<td>0.015847</td>
<td>0.002737</td>
<td>0.000206</td>
<td>0.000212</td>
<td>0.000200</td>
<td>0.000502</td>
<td>0.000108</td>
<td>0.000043</td>
<td>0_1_13_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>150.000</td>
<td>-0.467268</td>
<td>1.456846</td>
<td>-1.110759</td>
<td>0.003882</td>
<td>0.002598</td>
<td>0.002305</td>
<td>0.074834</td>
<td>0.019951</td>
<td>-0.292603</td>
<td>...</td>
<td>0.029142</td>
<td>0.015824</td>
<td>0.002714</td>
<td>0.000211</td>
<td>0.000223</td>
<td>0.000200</td>
<td>0.000507</td>
<td>0.000107</td>
<td>0.000044</td>
<td>0_1_13_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>166.667</td>
<td>-0.464211</td>
<td>1.455864</td>
<td>-1.112743</td>
<td>0.003883</td>
<td>0.002591</td>
<td>0.002308</td>
<td>0.073301</td>
<td>0.020223</td>
<td>-0.292818</td>
<td>...</td>
<td>0.029039</td>
<td>0.015802</td>
<td>0.002691</td>
<td>0.000223</td>
<td>0.000233</td>
<td>0.000199</td>
<td>0.000517</td>
<td>0.000116</td>
<td>0.000046</td>
<td>0_1_13_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>183.333</td>
<td>-0.461154</td>
<td>1.454881</td>
<td>-1.114727</td>
<td>0.003885</td>
<td>0.002585</td>
<td>0.002310</td>
<td>0.071768</td>
<td>0.020496</td>
<td>-0.293033</td>
<td>...</td>
<td>0.028947</td>
<td>0.015782</td>
<td>0.002669</td>
<td>0.000240</td>
<td>0.000245</td>
<td>0.000198</td>
<td>0.000530</td>
<td>0.000132</td>
<td>0.000048</td>
<td>0_1_13_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>200.000</td>
<td>-0.458098</td>
<td>1.453899</td>
<td>-1.116711</td>
<td>0.003887</td>
<td>0.002578</td>
<td>0.002313</td>
<td>0.070235</td>
<td>0.020768</td>
<td>-0.293248</td>
<td>...</td>
<td>0.028866</td>
<td>0.015761</td>
<td>0.002648</td>
<td>0.000262</td>
<td>0.000257</td>
<td>0.000198</td>
<td>0.000548</td>
<td>0.000155</td>
<td>0.000050</td>
<td>0_1_13_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>216.667</td>
<td>-0.455041</td>
<td>1.452916</td>
<td>-1.118695</td>
<td>0.003889</td>
<td>0.002572</td>
<td>0.002316</td>
<td>0.068701</td>
<td>0.021040</td>
<td>-0.293463</td>
<td>...</td>
<td>0.028796</td>
<td>0.015742</td>
<td>0.002628</td>
<td>0.000288</td>
<td>0.000269</td>
<td>0.000197</td>
<td>0.000569</td>
<td>0.000181</td>
<td>0.000052</td>
<td>0_1_13_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>233.333</td>
<td>-0.451984</td>
<td>1.451933</td>
<td>-1.120679</td>
<td>0.003891</td>
<td>0.002565</td>
<td>0.002318</td>
<td>0.067168</td>
<td>0.021312</td>
<td>-0.293678</td>
<td>...</td>
<td>0.028737</td>
<td>0.015724</td>
<td>0.002608</td>
<td>0.000317</td>
<td>0.000281</td>
<td>0.000196</td>
<td>0.000592</td>
<td>0.000208</td>
<td>0.000054</td>
<td>0_1_13_p1</td>
</tr>
</tbody>
</table>

<p>15 rows  240 columns</p>
</div>
</div>
</div>
</div>
<p>Here we can see the joint angle speed next to kinematic speed.</p>
<div id="7914718f" class="cell" data-execution_count="31">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_TS_processing_motion_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="motion-processing---inverse-dynamics" class="level1">
<h1>Motion processing - inverse dynamics</h1>
<p>Now we do exactly the same also for inverse dynamics data (joint torques/moments).</p>
<div id="0b386067" class="cell" data-execution_count="32">
<details class="code-fold">
<summary>Code to prepare environment</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in MTfolders, find all sto files</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>sto_files <span class="op">=</span> glob.glob(MTfolder <span class="op">+</span> <span class="st">'*/P*/*/*.sto'</span>, recursive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>sto_files <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> sto_files <span class="cf">if</span> <span class="st">'ID'</span> <span class="kw">in</span> x]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Lets once again check the different smoothing strengths</p>
<div id="badd1217" class="cell" data-execution_count="33">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_TS_processing_motion_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>And for legs</p>
<div id="eff5f0e6" class="cell" data-execution_count="35">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_TS_processing_motion_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We will again reuse 1st order Savitzky-Golay filter with window of 560 ms for the moments and their first derivate (torque/moment change).</p>
<div id="0e79718e" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># in MTfolders, find all sto files</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>sto_files <span class="op">=</span> glob.glob(MTfolder <span class="op">+</span> <span class="st">'*/P*/*/*.sto'</span>, recursive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>sto_files <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> sto_files <span class="cf">if</span> <span class="st">'ID'</span> <span class="kw">in</span> x]</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sto <span class="kw">in</span> sto_files:</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># from the filename, get the trialid</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    trialid <span class="op">=</span> sto.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    trialid <span class="op">=</span> <span class="st">'_'</span>.join(trialid.split(<span class="st">'_'</span>)[:<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    trialid <span class="op">=</span> <span class="st">'_'</span>.join(trialid.split(<span class="st">'_'</span>)[<span class="dv">1</span>:])</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'working on '</span> <span class="op">+</span> trialid)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load it</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    id_df <span class="op">=</span> pd.read_csv(sto, sep<span class="op">=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, skiprows<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pad 0 ms row</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    padrow <span class="op">=</span> id_df.iloc[<span class="dv">0</span>].copy()</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    padrow[<span class="st">'time'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># concatenate it to the beginning of id_df</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    id_df <span class="op">=</span> pd.concat([pd.DataFrame(padrow).T, id_df], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">##### SMOOTHING #####</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># smooth all columns except the firts time (time) and last (trialid)</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    colstosmooth <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> id_df.columns <span class="cf">if</span> <span class="st">'time'</span> <span class="kw">not</span> <span class="kw">in</span> x]</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    colstosmooth <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> colstosmooth <span class="cf">if</span> <span class="st">'TrialID'</span> <span class="kw">not</span> <span class="kw">in</span> x]</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># smooth</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> colstosmooth:</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        id_df[col] <span class="op">=</span> scipy.signal.savgol_filter(id_df[col], <span class="dv">35</span>, <span class="dv">1</span>)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">##### AGGREGATING #####</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get aggregated euclidian sum for each joint group</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    id_df <span class="op">=</span> aggregate_keypoints(id_df, <span class="st">'moment'</span>, <span class="st">'_moment_sum'</span>, <span class="st">'angles'</span>)</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">#### TORQUE CHANGE #####</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for each moment col, we will also calculate the change </span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    torquestodiff <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> id_df.columns <span class="cf">if</span> <span class="st">'moment'</span> <span class="kw">in</span> x]</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> torquestodiff:</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>        torquechange <span class="op">=</span> np.<span class="bu">abs</span>(np.insert(np.diff(id_df[col]), <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        torquechange_smoothed <span class="op">=</span> scipy.signal.savgol_filter(torquechange, <span class="dv">35</span>, <span class="dv">1</span>)</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># new data</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        new_data <span class="op">=</span> pd.DataFrame({col <span class="op">+</span> <span class="st">'_change'</span>: torquechange_smoothed})</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>        id_df <span class="op">=</span> pd.concat([id_df, new_data], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert time to ms</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>    id_df[<span class="st">'time'</span>] <span class="op">=</span> id_df[<span class="st">'time'</span>]<span class="op">*</span><span class="dv">1000</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># add trialid</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>    id_df[<span class="st">'TrialID'</span>] <span class="op">=</span> trialid</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># write to csv</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>    id_df.to_csv(MTfolder_processed <span class="op">+</span> <span class="st">'/id_'</span> <span class="op">+</span> trialid <span class="op">+</span> <span class="st">'.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is an example file</p>
<div id="10dfc677" class="cell" data-execution_count="37">
<div class="cell-output cell-output-display" data-execution_count="37">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">time</th>
<th data-quarto-table-cell-role="th">pelvis_tilt_moment</th>
<th data-quarto-table-cell-role="th">pelvis_list_moment</th>
<th data-quarto-table-cell-role="th">pelvis_rotation_moment</th>
<th data-quarto-table-cell-role="th">pelvis_tx_force</th>
<th data-quarto-table-cell-role="th">pelvis_ty_force</th>
<th data-quarto-table-cell-role="th">pelvis_tz_force</th>
<th data-quarto-table-cell-role="th">hip_flexion_r_moment</th>
<th data-quarto-table-cell-role="th">hip_adduction_r_moment</th>
<th data-quarto-table-cell-role="th">hip_rotation_r_moment</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">wrist_dev_r_moment_change</th>
<th data-quarto-table-cell-role="th">wrist_flex_l_moment_change</th>
<th data-quarto-table-cell-role="th">wrist_dev_l_moment_change</th>
<th data-quarto-table-cell-role="th">lowerbody_moment_sum_change</th>
<th data-quarto-table-cell-role="th">leg_moment_sum_change</th>
<th data-quarto-table-cell-role="th">head_moment_sum_change</th>
<th data-quarto-table-cell-role="th">arm_moment_sum_change</th>
<th data-quarto-table-cell-role="th">pelvis_moment_sum_change</th>
<th data-quarto-table-cell-role="th">spine_moment_sum_change</th>
<th data-quarto-table-cell-role="th">TrialID</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.000</td>
<td>0.491035</td>
<td>55.218816</td>
<td>1.864887</td>
<td>8.991912</td>
<td>613.897817</td>
<td>8.243875</td>
<td>-42.179898</td>
<td>0.803486</td>
<td>1.159189</td>
<td>...</td>
<td>-0.000400</td>
<td>-0.000851</td>
<td>0.001524</td>
<td>0.251383</td>
<td>0.003900</td>
<td>0.047152</td>
<td>-0.023827</td>
<td>0.255015</td>
<td>-0.017313</td>
<td>0_2_96_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>16.547</td>
<td>0.568692</td>
<td>54.981085</td>
<td>1.960780</td>
<td>8.479003</td>
<td>613.965803</td>
<td>7.845832</td>
<td>-42.124053</td>
<td>0.736541</td>
<td>1.167199</td>
<td>...</td>
<td>-0.000327</td>
<td>-0.000700</td>
<td>0.001662</td>
<td>0.245041</td>
<td>0.004395</td>
<td>0.047129</td>
<td>-0.020931</td>
<td>0.248606</td>
<td>-0.012716</td>
<td>0_2_96_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>33.213</td>
<td>0.646350</td>
<td>54.743353</td>
<td>2.056672</td>
<td>7.966094</td>
<td>614.033789</td>
<td>7.447790</td>
<td>-42.068208</td>
<td>0.669597</td>
<td>1.175208</td>
<td>...</td>
<td>-0.000254</td>
<td>-0.000549</td>
<td>0.001800</td>
<td>0.238700</td>
<td>0.004890</td>
<td>0.047106</td>
<td>-0.018034</td>
<td>0.242197</td>
<td>-0.008119</td>
<td>0_2_96_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>49.879</td>
<td>0.724007</td>
<td>54.505622</td>
<td>2.152564</td>
<td>7.453185</td>
<td>614.101775</td>
<td>7.049747</td>
<td>-42.012363</td>
<td>0.602652</td>
<td>1.183218</td>
<td>...</td>
<td>-0.000181</td>
<td>-0.000397</td>
<td>0.001938</td>
<td>0.232359</td>
<td>0.005385</td>
<td>0.047083</td>
<td>-0.015137</td>
<td>0.235789</td>
<td>-0.003522</td>
<td>0_2_96_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>66.545</td>
<td>0.801664</td>
<td>54.267891</td>
<td>2.248457</td>
<td>6.940276</td>
<td>614.169761</td>
<td>6.651704</td>
<td>-41.956518</td>
<td>0.535708</td>
<td>1.191228</td>
<td>...</td>
<td>-0.000108</td>
<td>-0.000246</td>
<td>0.002076</td>
<td>0.226018</td>
<td>0.005880</td>
<td>0.047061</td>
<td>-0.012240</td>
<td>0.229380</td>
<td>0.001075</td>
<td>0_2_96_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>83.211</td>
<td>0.879322</td>
<td>54.030159</td>
<td>2.344349</td>
<td>6.427368</td>
<td>614.237747</td>
<td>6.253662</td>
<td>-41.900673</td>
<td>0.468764</td>
<td>1.199237</td>
<td>...</td>
<td>-0.000035</td>
<td>-0.000094</td>
<td>0.002214</td>
<td>0.219677</td>
<td>0.006375</td>
<td>0.047038</td>
<td>-0.009343</td>
<td>0.222971</td>
<td>0.005673</td>
<td>0_2_96_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>99.877</td>
<td>0.956979</td>
<td>53.792428</td>
<td>2.440241</td>
<td>5.914459</td>
<td>614.305733</td>
<td>5.855619</td>
<td>-41.844828</td>
<td>0.401819</td>
<td>1.207247</td>
<td>...</td>
<td>0.000038</td>
<td>0.000057</td>
<td>0.002351</td>
<td>0.213336</td>
<td>0.006870</td>
<td>0.047015</td>
<td>-0.006446</td>
<td>0.216562</td>
<td>0.010270</td>
<td>0_2_96_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>116.543</td>
<td>1.034636</td>
<td>53.554696</td>
<td>2.536133</td>
<td>5.401550</td>
<td>614.373719</td>
<td>5.457576</td>
<td>-41.788983</td>
<td>0.334875</td>
<td>1.215257</td>
<td>...</td>
<td>0.000111</td>
<td>0.000209</td>
<td>0.002489</td>
<td>0.206995</td>
<td>0.007365</td>
<td>0.046993</td>
<td>-0.003549</td>
<td>0.210153</td>
<td>0.014867</td>
<td>0_2_96_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>133.209</td>
<td>1.112294</td>
<td>53.316965</td>
<td>2.632026</td>
<td>4.888641</td>
<td>614.441705</td>
<td>5.059533</td>
<td>-41.733138</td>
<td>0.267930</td>
<td>1.223266</td>
<td>...</td>
<td>0.000184</td>
<td>0.000360</td>
<td>0.002627</td>
<td>0.200654</td>
<td>0.007860</td>
<td>0.046970</td>
<td>-0.000653</td>
<td>0.203744</td>
<td>0.019464</td>
<td>0_2_96_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>149.875</td>
<td>1.189951</td>
<td>53.079233</td>
<td>2.727918</td>
<td>4.375732</td>
<td>614.509691</td>
<td>4.661491</td>
<td>-41.677293</td>
<td>0.200986</td>
<td>1.231276</td>
<td>...</td>
<td>0.000257</td>
<td>0.000512</td>
<td>0.002765</td>
<td>0.194313</td>
<td>0.008355</td>
<td>0.046947</td>
<td>0.002244</td>
<td>0.197335</td>
<td>0.024061</td>
<td>0_2_96_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>166.541</td>
<td>1.267609</td>
<td>52.841502</td>
<td>2.823810</td>
<td>3.862823</td>
<td>614.577677</td>
<td>4.263448</td>
<td>-41.621448</td>
<td>0.134041</td>
<td>1.239286</td>
<td>...</td>
<td>0.000330</td>
<td>0.000663</td>
<td>0.002903</td>
<td>0.187972</td>
<td>0.008850</td>
<td>0.046924</td>
<td>0.005141</td>
<td>0.190927</td>
<td>0.028658</td>
<td>0_2_96_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>183.207</td>
<td>1.345266</td>
<td>52.603770</td>
<td>2.919703</td>
<td>3.349915</td>
<td>614.645663</td>
<td>3.865405</td>
<td>-41.565603</td>
<td>0.067097</td>
<td>1.247295</td>
<td>...</td>
<td>0.000403</td>
<td>0.000815</td>
<td>0.003041</td>
<td>0.181630</td>
<td>0.009345</td>
<td>0.046902</td>
<td>0.008038</td>
<td>0.184518</td>
<td>0.033256</td>
<td>0_2_96_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>199.873</td>
<td>1.422923</td>
<td>52.366039</td>
<td>3.015595</td>
<td>2.837006</td>
<td>614.713649</td>
<td>3.467363</td>
<td>-41.509758</td>
<td>0.000152</td>
<td>1.255305</td>
<td>...</td>
<td>0.000476</td>
<td>0.000966</td>
<td>0.003179</td>
<td>0.175289</td>
<td>0.009840</td>
<td>0.046879</td>
<td>0.010935</td>
<td>0.178109</td>
<td>0.037853</td>
<td>0_2_96_p1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>216.539</td>
<td>1.500581</td>
<td>52.128307</td>
<td>3.111487</td>
<td>2.324097</td>
<td>614.781635</td>
<td>3.069320</td>
<td>-41.453913</td>
<td>-0.066792</td>
<td>1.263315</td>
<td>...</td>
<td>0.000549</td>
<td>0.001118</td>
<td>0.003317</td>
<td>0.168948</td>
<td>0.010335</td>
<td>0.046856</td>
<td>0.013832</td>
<td>0.171700</td>
<td>0.042450</td>
<td>0_2_96_p1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>233.205</td>
<td>1.578238</td>
<td>51.890576</td>
<td>3.207380</td>
<td>1.811188</td>
<td>614.849621</td>
<td>2.671277</td>
<td>-41.398068</td>
<td>-0.133737</td>
<td>1.271324</td>
<td>...</td>
<td>0.000622</td>
<td>0.001269</td>
<td>0.003455</td>
<td>0.162607</td>
<td>0.010830</td>
<td>0.046833</td>
<td>0.016729</td>
<td>0.165291</td>
<td>0.047047</td>
<td>0_2_96_p1</td>
</tr>
</tbody>
</table>

<p>15 rows  131 columns</p>
</div>
</div>
</div>
</div>
<p>Now we can check by ploting the joint moment change against kinematic acceleration</p>
<div id="eafa2947" class="cell" data-execution_count="38">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_TS_processing_motion_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="balance-board-ground-reaction-forces---processing" class="level1">
<h1>Balance Board (Ground reaction forces) - processing</h1>
<p>Lastly, we need to process the balance board data. We apply 5th order Savitzky-Golay filter to windows of 102 ms. To have a measure for postural adjustments, we compute the change in 2D magnitude (L2 norm of the center of pressure x and y) in center of pressure. The code is adaptation from <span class="citation" data-cites="pouw_etal23">Pouw et al. (<a href="#ref-pouw_etal23" role="doc-biblioref">2023</a>)</span>.</p>
<div id="3064166f" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>BB_files <span class="op">=</span> glob.glob(BBfolder <span class="op">+</span> <span class="st">'*BalanceBoard*.csv'</span>, recursive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bb <span class="kw">in</span> BB_files:</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get trialid</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    trialid <span class="op">=</span> bb.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get the first, second, fourth, nineth elements</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    trialid <span class="op">=</span> <span class="st">'_'</span>.join(trialid.split(<span class="st">'_'</span>)[:<span class="dv">2</span>] <span class="op">+</span> trialid.split(<span class="st">'_'</span>)[<span class="dv">3</span>:<span class="dv">4</span>] <span class="op">+</span> trialid.split(<span class="st">'_'</span>)[<span class="dv">8</span>:<span class="dv">9</span>])</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'working on '</span> <span class="op">+</span> trialid)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># because we are going to merge on bb, we will store also more information</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    fileinfo <span class="op">=</span> bb.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if second element is 1, we will store last three elements</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> fileinfo.split(<span class="st">'_'</span>)[<span class="dv">1</span>] <span class="op">==</span> <span class="st">'1'</span>:</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if there is not 'corrected' in the name, we will store last three elements</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'corrected'</span> <span class="kw">not</span> <span class="kw">in</span> fileinfo:</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>            info <span class="op">=</span> <span class="st">'_'</span>.join(fileinfo.split(<span class="st">'_'</span>)[<span class="op">-</span><span class="dv">3</span>:])</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>            info <span class="op">=</span> <span class="st">'_'</span>.join(fileinfo.split(<span class="st">'_'</span>)[<span class="op">-</span><span class="dv">4</span>:])</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> fileinfo.split(<span class="st">'_'</span>)[<span class="dv">1</span>] <span class="op">==</span> <span class="st">'2'</span>:</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># otherwise we store last four elements (5 when corrected)</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'corrected'</span> <span class="kw">not</span> <span class="kw">in</span> fileinfo:</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>            info <span class="op">=</span> <span class="st">'_'</span>.join(fileinfo.split(<span class="st">'_'</span>)[<span class="op">-</span><span class="dv">4</span>:])</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>            info <span class="op">=</span> <span class="st">'_'</span>.join(fileinfo.split(<span class="st">'_'</span>)[<span class="op">-</span><span class="dv">5</span>:])</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the balanceboard data</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    df_bb <span class="op">=</span> pd.read_csv(bb)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rename columns</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    df_bb.columns <span class="op">=</span> [<span class="st">'time_s'</span>, <span class="st">'left_back'</span>, <span class="st">'right_forward'</span>, <span class="st">'right_back'</span>, <span class="st">'left_forward'</span>]</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate sampling rate</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    bbsamp <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> np.mean(np.diff(df_bb[<span class="st">'time_s'</span>] <span class="op">-</span> <span class="bu">min</span>(df_bb[<span class="st">'time_s'</span>])))</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply Savitzky-Golay filter to smooth the data</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> df_bb.columns[<span class="dv">1</span>:]:</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        df_bb[col] <span class="op">=</span> scipy.signal.savgol_filter(df_bb[col], <span class="dv">51</span>, <span class="dv">5</span>) <span class="co"># window of 102 ms</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate COPX and COPY</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    COPX <span class="op">=</span> (df_bb[<span class="st">'right_forward'</span>] <span class="op">+</span> df_bb[<span class="st">'right_back'</span>]) <span class="op">-</span> (df_bb[<span class="st">'left_forward'</span>] <span class="op">+</span> df_bb[<span class="st">'left_back'</span>])</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    COPY <span class="op">=</span> (df_bb[<span class="st">'right_forward'</span>] <span class="op">+</span> df_bb[<span class="st">'left_forward'</span>]) <span class="op">-</span> (df_bb[<span class="st">'left_back'</span>] <span class="op">+</span> df_bb[<span class="st">'right_back'</span>])</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate COPXc and COPYc </span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    df_bb[<span class="st">'COPXc'</span>] <span class="op">=</span> scipy.signal.savgol_filter(np.insert(np.diff(COPX), <span class="dv">0</span>, <span class="dv">0</span>), <span class="dv">51</span>, <span class="dv">5</span>) </span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    df_bb[<span class="st">'COPYc'</span>] <span class="op">=</span> scipy.signal.savgol_filter(np.insert(np.diff(COPY), <span class="dv">0</span>, <span class="dv">0</span>), <span class="dv">51</span>, <span class="dv">5</span>)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate COPc</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    df_bb[<span class="st">'COPc'</span>] <span class="op">=</span> np.sqrt(df_bb[<span class="st">'COPXc'</span>]<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> df_bb[<span class="st">'COPYc'</span>]<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># restart the time so that starts from 0</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    df_bb[<span class="st">'time_s'</span>] <span class="op">=</span> df_bb[<span class="st">'time_s'</span>] <span class="op">-</span> <span class="bu">min</span>(df_bb[<span class="st">'time_s'</span>])</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert to ms</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    df_bb[<span class="st">'time_s'</span>] <span class="op">=</span> df_bb[<span class="st">'time_s'</span>]<span class="op">*</span><span class="dv">1000</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rename time_s to time</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>    df_bb.rename(columns<span class="op">=</span>{<span class="st">'time_s'</span>: <span class="st">'time'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add trialid</span></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>    df_bb[<span class="st">'TrialID'</span>] <span class="op">=</span> trialid</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add info</span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>    df_bb[<span class="st">'FileInfo'</span>] <span class="op">=</span> info</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write as csv to MTfolder_processed</span></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>    df_bb.to_csv(MTfolder_processed <span class="op">+</span> <span class="st">'/bb_'</span> <span class="op">+</span> trialid <span class="op">+</span> <span class="st">'.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is an example of a file</p>
<div id="4d3c377b" class="cell" data-execution_count="40">
<div class="cell-output cell-output-display" data-execution_count="40">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">time</th>
<th data-quarto-table-cell-role="th">left_back</th>
<th data-quarto-table-cell-role="th">right_forward</th>
<th data-quarto-table-cell-role="th">right_back</th>
<th data-quarto-table-cell-role="th">left_forward</th>
<th data-quarto-table-cell-role="th">COPXc</th>
<th data-quarto-table-cell-role="th">COPYc</th>
<th data-quarto-table-cell-role="th">COPc</th>
<th data-quarto-table-cell-role="th">TrialID</th>
<th data-quarto-table-cell-role="th">FileInfo</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.000000</td>
<td>1.171571</td>
<td>0.723754</td>
<td>1.447923</td>
<td>1.408978</td>
<td>-0.000137</td>
<td>-0.000089</td>
<td>0.000164</td>
<td>0_2_20_p1</td>
<td>p1_glimlach_combinatie_c1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2.000053</td>
<td>1.170970</td>
<td>0.722923</td>
<td>1.446523</td>
<td>1.407724</td>
<td>-0.000254</td>
<td>-0.000015</td>
<td>0.000255</td>
<td>0_2_20_p1</td>
<td>p1_glimlach_combinatie_c1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>4.000105</td>
<td>1.170294</td>
<td>0.722047</td>
<td>1.445160</td>
<td>1.406567</td>
<td>-0.000338</td>
<td>0.000051</td>
<td>0.000342</td>
<td>0_2_20_p1</td>
<td>p1_glimlach_combinatie_c1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>6.000158</td>
<td>1.169555</td>
<td>0.721139</td>
<td>1.443832</td>
<td>1.405492</td>
<td>-0.000394</td>
<td>0.000109</td>
<td>0.000408</td>
<td>0_2_20_p1</td>
<td>p1_glimlach_combinatie_c1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>8.000211</td>
<td>1.168764</td>
<td>0.720209</td>
<td>1.442540</td>
<td>1.404488</td>
<td>-0.000425</td>
<td>0.000159</td>
<td>0.000454</td>
<td>0_2_20_p1</td>
<td>p1_glimlach_combinatie_c1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>10.000264</td>
<td>1.167931</td>
<td>0.719268</td>
<td>1.441284</td>
<td>1.403544</td>
<td>-0.000437</td>
<td>0.000201</td>
<td>0.000481</td>
<td>0_2_20_p1</td>
<td>p1_glimlach_combinatie_c1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>12.000316</td>
<td>1.167069</td>
<td>0.718325</td>
<td>1.440065</td>
<td>1.402653</td>
<td>-0.000432</td>
<td>0.000236</td>
<td>0.000492</td>
<td>0_2_20_p1</td>
<td>p1_glimlach_combinatie_c1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>14.000369</td>
<td>1.166187</td>
<td>0.717390</td>
<td>1.438886</td>
<td>1.401807</td>
<td>-0.000413</td>
<td>0.000264</td>
<td>0.000491</td>
<td>0_2_20_p1</td>
<td>p1_glimlach_combinatie_c1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>16.000422</td>
<td>1.165295</td>
<td>0.716471</td>
<td>1.437750</td>
<td>1.401002</td>
<td>-0.000385</td>
<td>0.000286</td>
<td>0.000480</td>
<td>0_2_20_p1</td>
<td>p1_glimlach_combinatie_c1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>18.000475</td>
<td>1.164405</td>
<td>0.715577</td>
<td>1.436658</td>
<td>1.400234</td>
<td>-0.000349</td>
<td>0.000302</td>
<td>0.000461</td>
<td>0_2_20_p1</td>
<td>p1_glimlach_combinatie_c1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>20.000527</td>
<td>1.163525</td>
<td>0.714716</td>
<td>1.435614</td>
<td>1.399501</td>
<td>-0.000307</td>
<td>0.000311</td>
<td>0.000437</td>
<td>0_2_20_p1</td>
<td>p1_glimlach_combinatie_c1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>22.000580</td>
<td>1.162665</td>
<td>0.713894</td>
<td>1.434623</td>
<td>1.398801</td>
<td>-0.000262</td>
<td>0.000315</td>
<td>0.000410</td>
<td>0_2_20_p1</td>
<td>p1_glimlach_combinatie_c1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>24.000633</td>
<td>1.161834</td>
<td>0.713118</td>
<td>1.433687</td>
<td>1.398136</td>
<td>-0.000216</td>
<td>0.000314</td>
<td>0.000381</td>
<td>0_2_20_p1</td>
<td>p1_glimlach_combinatie_c1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>26.000685</td>
<td>1.161041</td>
<td>0.712394</td>
<td>1.432812</td>
<td>1.397506</td>
<td>-0.000170</td>
<td>0.000307</td>
<td>0.000351</td>
<td>0_2_20_p1</td>
<td>p1_glimlach_combinatie_c1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>28.000738</td>
<td>1.160293</td>
<td>0.711729</td>
<td>1.432002</td>
<td>1.396912</td>
<td>-0.000125</td>
<td>0.000296</td>
<td>0.000321</td>
<td>0_2_20_p1</td>
<td>p1_glimlach_combinatie_c1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Here is an example of a timeseries representing change in center of pressure (COPc)</p>
<div id="6cf7a364" class="cell" data-execution_count="41">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="01_TS_processing_motion_files/figure-html/cell-25-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="references" class="level1">
<h1>References</h1>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-pouw_etal23" class="csl-entry" role="listitem">
Pouw, Wim, Raphael Werner, Lara Burchardt, and Luc Selen. 2023. <span>The Human Voice Aligns with Whole-Body Kinetics.</span> November 28, 2023. <a href="https://doi.org/10.1101/2023.11.28.568991">https://doi.org/10.1101/2023.11.28.568991</a>.
</div>
<div id="ref-seth_etal18" class="csl-entry" role="listitem">
Seth, Ajay, Jennifer L. Hicks, Thomas K. Uchida, Ayman Habib, Christopher L. Dembia, James J. Dunne, Carmichael F. Ong, et al. 26. 7. 2018. <span><span>OpenSim</span>: <span>Simulating</span> Musculoskeletal Dynamics and Neuromuscular Control to Study Human and Animal Movement.</span> <em>PLOS Computational Biology</em> 14 (7): e1006223. <a href="https://doi.org/10.1371/journal.pcbi.1006223">https://doi.org/10.1371/journal.pcbi.1006223</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>