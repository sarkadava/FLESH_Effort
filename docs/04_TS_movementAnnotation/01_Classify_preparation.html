<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.552">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Movement annotation I: Preparing training data and data for classifier</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar floating nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
        <div class="quarto-navbar-tools tools-end">
    <a href="https://bsky.app/profile/sarkadava.bsky.social" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-bluesky"></i></a>
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://code.com">
            Source Code
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://bugs.com">
            Report a Bug
            </a>
          </li>
      </ul>
    </div>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../04_TS_movementAnnotation/01_Classify_preparation.html">Time Series Annotation</a></li><li class="breadcrumb-item"><a href="../04_TS_movementAnnotation/01_Classify_preparation.html">Movement annotation I: Preparing training data and data for classifier</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Processing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_XDF_processing/xdf_workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pre-Processing I: from XDF to raw files</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_MotionTracking_processing/01_Video_preparation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Motion tracking I: Preparation of videos</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_MotionTracking_processing/02_Track_OpenPose.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Motion tracking II: 2D pose estimation via OpenPose</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_MotionTracking_processing/03_Track_pose2sim.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Motion tracking III: Triangulation via Pose2sim</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_MotionTracking_processing/04_Track_InverseKinDyn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Motion tracking IV: Modeling inverse kinematics and dynamics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_TS_processing/01_TS_processing_motion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Processing I: Motion tracking and balance</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_TS_processing/02_TS_processing_acoustics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Processing II: Acoustics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_TS_processing/03_TS_merging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Processing III: Merging multimodal data</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Time Series Annotation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_TS_movementAnnotation/01_Classify_preparation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Movement annotation I: Preparing training data and data for classifier</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_TS_movementAnnotation/02_MovementClassifier.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Movement annotation II: Training movement classifier, and annotating timeseries data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_TS_movementAnnotation/03_InterAgreement.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Movement annotation III: Computing interrater agreement between manual and automatic annotation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../05_finalMerge/TS_mergeAnnotations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Final merge</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../06_ConceptSimilarity/ConceptNet_similarity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Computing concept similarity using ConceptNet word embeddings</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../07_TS_featureExtraction/TS_extraction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Extraction of effort-related features</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../08_Analysis_XGBoost/01_PCA_featureDimensions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exploratory Analysis I: Using PCA to identify effort dimensions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../08_Analysis_XGBoost/02_XGBoost_effortIndicators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exploratory Analysis II: Identifying effort-related features contributing to misunderstanding resolution</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../09_Analysis_Modeling/Modelling_syntheticData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statistical Analysis: Modelling the Effect of Communicative Attempt (H1) and Answer Similarity (H2) on Effort</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Summary</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../04_TS_movementAnnotation/01_Classify_preparation.html">Time Series Annotation</a></li><li class="breadcrumb-item"><a href="../04_TS_movementAnnotation/01_Classify_preparation.html">Movement annotation I: Preparing training data and data for classifier</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Movement annotation I: Preparing training data and data for classifier</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="sec-annoprep" class="level1">
<h1>Overview</h1>
<p>Since we have around 9000 trials in the final dataset, it is not feasible to manually annotate the movement onset and offset for each trial. Instead, we will use a simple logistic regression model to predict the movement onset and offset from all the movement features we have collected into the <a href="../03_TS_processing/03_TS_merging.html#sec-procmerge">merge dataset</a>.</p>
<p>We have annotated the movement onset and offset in <span class="citation" data-cites="wittenburg_etal06">Wittenburg et al. (<a href="#ref-wittenburg_etal06" role="doc-biblioref">2006</a>)</span> for a pilot data (dyad 0). Two annotators have independently annotated the movement onset and offset for four tiers: - upper body - lower body - arms - head</p>
<p>Parent tier ‘movement’ summarizes overal movement across all tiers.</p>
<p>Now, we will use these ground truth annotations to create a training set for the logistic regression model.</p>
<div id="cell-2" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code to prepare the environment</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xml.etree.ElementTree <span class="im">as</span> ET</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>curfolder <span class="op">=</span> os.getcwd()</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we store our timeseries data</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>processedfolder <span class="op">=</span> os.path.join(curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">..</span><span class="ch">\\</span><span class="st">03_TS_processing</span><span class="ch">\\</span><span class="st">TS_merged</span><span class="ch">\\</span><span class="st">'</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>processedfiles <span class="op">=</span> glob.glob(processedfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">merged*.csv'</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>processedfiles <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> processedfiles <span class="cf">if</span> <span class="st">'anno'</span> <span class="kw">not</span> <span class="kw">in</span> x]</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we will store the training data</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>datasetfolder <span class="op">=</span> os.path.join(curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">TrainingData</span><span class="ch">\\</span><span class="st">'</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we store the data ready to classify</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>chunked_folder <span class="op">=</span> os.path.join(curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">TS_forClassifying</span><span class="ch">\\</span><span class="st">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="preparing-manual-annotations" class="level1">
<h1>Preparing manual annotations</h1>
<p>Our annotators are annotating only movement, so first we need to also fill in the missing space by nomovement values .</p>
<div id="cell-5" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Custom functions</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to add no-movement annotations to the ELAN file</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_nomovement_annotations(xml_file_path, newfilepath):</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the XML file</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    tree <span class="op">=</span> ET.parse(xml_file_path)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    root <span class="op">=</span> tree.getroot()</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract all time slots</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    time_slots <span class="op">=</span> {}</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> time_slot <span class="kw">in</span> root.find(<span class="st">'TIME_ORDER'</span>).findall(<span class="st">'TIME_SLOT'</span>):</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        time_slots[time_slot.attrib[<span class="st">'TIME_SLOT_ID'</span>]] <span class="op">=</span> <span class="bu">int</span>(time_slot.attrib[<span class="st">'TIME_VALUE'</span>])</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort time slots by TIME_VALUE</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    sorted_time_slots <span class="op">=</span> <span class="bu">sorted</span>(time_slots.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>])</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    time_slot_ids <span class="op">=</span> [ts[<span class="dv">0</span>] <span class="cf">for</span> ts <span class="kw">in</span> sorted_time_slots]</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    time_values <span class="op">=</span> [ts[<span class="dv">1</span>] <span class="cf">for</span> ts <span class="kw">in</span> sorted_time_slots]</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop over all tiers</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> tier <span class="kw">in</span> root.findall(<span class="st">'TIER'</span>):</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        annotations <span class="op">=</span> tier.findall(<span class="st">'ANNOTATION/ALIGNABLE_ANNOTATION'</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> annotations:</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If no annotations exist, add a single 'nomovement' annotation covering the whole tier</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>            new_annotation <span class="op">=</span> ET.Element(<span class="st">'ANNOTATION'</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>            alignable_annotation <span class="op">=</span> ET.SubElement(new_annotation, <span class="st">'ALIGNABLE_ANNOTATION'</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>            alignable_annotation.<span class="bu">set</span>(<span class="st">'TIME_SLOT_REF1'</span>, time_slot_ids[<span class="dv">0</span>])</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>            alignable_annotation.<span class="bu">set</span>(<span class="st">'TIME_SLOT_REF2'</span>, time_slot_ids[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>            annotation_value <span class="op">=</span> ET.SubElement(alignable_annotation, <span class="st">'ANNOTATION_VALUE'</span>)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>            annotation_value.text <span class="op">=</span> <span class="st">'nomovement'</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>            tier.append(new_annotation)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Sort annotations by start time</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>            sorted_annotations <span class="op">=</span> <span class="bu">sorted</span>(annotations, key<span class="op">=</span><span class="kw">lambda</span> x: time_slots[x.attrib[<span class="st">'TIME_SLOT_REF1'</span>]])</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Handle the first annotation</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>            first_annotation <span class="op">=</span> sorted_annotations[<span class="dv">0</span>]</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>            first_start_time <span class="op">=</span> time_slots[first_annotation.attrib[<span class="st">'TIME_SLOT_REF1'</span>]]</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> first_start_time <span class="op">&gt;</span> time_values[<span class="dv">0</span>]:</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>                new_annotation <span class="op">=</span> ET.Element(<span class="st">'ANNOTATION'</span>)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>                alignable_annotation <span class="op">=</span> ET.SubElement(new_annotation, <span class="st">'ALIGNABLE_ANNOTATION'</span>)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>                alignable_annotation.<span class="bu">set</span>(<span class="st">'TIME_SLOT_REF1'</span>, time_slot_ids[<span class="dv">0</span>])</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>                alignable_annotation.<span class="bu">set</span>(<span class="st">'TIME_SLOT_REF2'</span>, first_annotation.attrib[<span class="st">'TIME_SLOT_REF1'</span>])</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>                annotation_value <span class="op">=</span> ET.SubElement(alignable_annotation, <span class="st">'ANNOTATION_VALUE'</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>                annotation_value.text <span class="op">=</span> <span class="st">'nomovement'</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>                tier.append(new_annotation)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Handle gaps between annotations</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(sorted_annotations) <span class="op">-</span> <span class="dv">1</span>):</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>                current_annotation <span class="op">=</span> sorted_annotations[i]</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>                next_annotation <span class="op">=</span> sorted_annotations[i <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>                current_end_time <span class="op">=</span> time_slots[current_annotation.attrib[<span class="st">'TIME_SLOT_REF2'</span>]]</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>                next_start_time <span class="op">=</span> time_slots[next_annotation.attrib[<span class="st">'TIME_SLOT_REF1'</span>]]</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> current_end_time <span class="op">&lt;</span> next_start_time:</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>                    new_annotation <span class="op">=</span> ET.Element(<span class="st">'ANNOTATION'</span>)</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>                    alignable_annotation <span class="op">=</span> ET.SubElement(new_annotation, <span class="st">'ALIGNABLE_ANNOTATION'</span>)</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>                    alignable_annotation.<span class="bu">set</span>(<span class="st">'TIME_SLOT_REF1'</span>, current_annotation.attrib[<span class="st">'TIME_SLOT_REF2'</span>])</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>                    alignable_annotation.<span class="bu">set</span>(<span class="st">'TIME_SLOT_REF2'</span>, next_annotation.attrib[<span class="st">'TIME_SLOT_REF1'</span>])</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>                    annotation_value <span class="op">=</span> ET.SubElement(alignable_annotation, <span class="st">'ANNOTATION_VALUE'</span>)</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>                    annotation_value.text <span class="op">=</span> <span class="st">'nomovement'</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>                    tier.append(new_annotation)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Handle the last annotation</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>            last_annotation <span class="op">=</span> sorted_annotations[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>            last_end_time <span class="op">=</span> time_slots[last_annotation.attrib[<span class="st">'TIME_SLOT_REF2'</span>]]</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> last_end_time <span class="op">&lt;</span> time_values[<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>                new_annotation <span class="op">=</span> ET.Element(<span class="st">'ANNOTATION'</span>)</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>                alignable_annotation <span class="op">=</span> ET.SubElement(new_annotation, <span class="st">'ALIGNABLE_ANNOTATION'</span>)</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>                alignable_annotation.<span class="bu">set</span>(<span class="st">'TIME_SLOT_REF1'</span>, last_annotation.attrib[<span class="st">'TIME_SLOT_REF2'</span>])</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>                alignable_annotation.<span class="bu">set</span>(<span class="st">'TIME_SLOT_REF2'</span>, time_slot_ids[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>                annotation_value <span class="op">=</span> ET.SubElement(alignable_annotation, <span class="st">'ANNOTATION_VALUE'</span>)</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>                annotation_value.text <span class="op">=</span> <span class="st">'nomovement'</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>                tier.append(new_annotation)</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the modified XML file as a new file</span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>    tree.write(newfilepath, encoding<span class="op">=</span><span class="st">'UTF-8'</span>, xml_declaration<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-6" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>manualanno_folder_r1 <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'/ManualAnno/R1/'</span>            <span class="co"># Annotator 1 (AC)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>manualanno_folder_r3 <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'/ManualAnno/R3/'</span>            <span class="co"># Annotator 2 (GR)</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>manualannofiles1 <span class="op">=</span> glob.glob(manualanno_folder_r1 <span class="op">+</span> <span class="st">'/*.eaf'</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># get rid of those with ELAN_tiers.eaf</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>manualannofiles1 <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> manualannofiles1 <span class="cf">if</span> <span class="st">'ELAN_tiers'</span> <span class="kw">not</span> <span class="kw">in</span> x]</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>manualannofiles3 <span class="op">=</span> glob.glob(manualanno_folder_r3 <span class="op">+</span> <span class="st">'/*.eaf'</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># get rid of those with ELAN_tiers.eaf</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>manualannofiles3 <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> manualannofiles3 <span class="cf">if</span> <span class="st">'ELAN_tiers'</span> <span class="kw">not</span> <span class="kw">in</span> x]</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> manualannofiles3:</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'working on '</span> <span class="op">+</span> <span class="bu">file</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># New filename is without third part of the name</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    newfile <span class="op">=</span> <span class="bu">file</span>.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> newfile.split(<span class="st">'_'</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'corrected'</span> <span class="kw">in</span> <span class="bu">file</span>:</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'c0'</span> <span class="kw">in</span> <span class="bu">file</span> <span class="kw">or</span> <span class="st">'c1'</span> <span class="kw">in</span> <span class="bu">file</span> <span class="kw">or</span> <span class="st">'c2'</span> <span class="kw">in</span> <span class="bu">file</span>:</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>            newfile <span class="op">=</span> <span class="st">'_'</span>.join(chunks[:<span class="op">-</span><span class="dv">4</span>])</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>            newfile <span class="op">=</span> <span class="st">'_'</span>.join(chunks[:<span class="op">-</span><span class="dv">3</span>])</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'c0'</span> <span class="kw">in</span> <span class="bu">file</span> <span class="kw">or</span> <span class="st">'c1'</span> <span class="kw">in</span> <span class="bu">file</span> <span class="kw">or</span> <span class="st">'c2'</span> <span class="kw">in</span> <span class="bu">file</span>:</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>            newfile <span class="op">=</span> <span class="st">'_'</span>.join(chunks[:<span class="op">-</span><span class="dv">3</span>])</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>            newfile <span class="op">=</span> <span class="st">'_'</span>.join(chunks[:<span class="op">-</span><span class="dv">2</span>]) </span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    newfile <span class="op">=</span> newfile.replace(<span class="st">'trial_'</span>, <span class="st">''</span>)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save it again</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    newfile <span class="op">=</span> manualanno_folder_r3 <span class="op">+</span> newfile <span class="op">+</span> <span class="st">'_ELAN_tiers.eaf'</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    add_nomovement_annotations(<span class="bu">file</span>, newfile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we need to get the manual annotation from ELAN to simple text file so that we can merge the timeseries we prepared in <strong>?@sec-procmerge</strong> with information about movement in the trial</p>
<div id="cell-8" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>Custom functions</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to parse elan file</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_eaf_file(eaf_file, rel_tiers):</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    tree <span class="op">=</span> ET.parse(eaf_file)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    root <span class="op">=</span> tree.getroot()</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    time_order <span class="op">=</span> root.find(<span class="st">'TIME_ORDER'</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    time_slots <span class="op">=</span> {time_slot.attrib[<span class="st">'TIME_SLOT_ID'</span>]: time_slot.attrib[<span class="st">'TIME_VALUE'</span>] <span class="cf">for</span> time_slot <span class="kw">in</span> time_order}</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    annotations <span class="op">=</span> []</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    relevant_tiers <span class="op">=</span> {rel_tiers}</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> tier <span class="kw">in</span> root.findall(<span class="st">'TIER'</span>):</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        tier_id <span class="op">=</span> tier.attrib[<span class="st">'TIER_ID'</span>]</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> tier_id <span class="kw">in</span> relevant_tiers:</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> annotation <span class="kw">in</span> tier.findall(<span class="st">'ANNOTATION/ALIGNABLE_ANNOTATION'</span>):</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Ensure required attributes are present</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="st">'TIME_SLOT_REF1'</span> <span class="kw">in</span> annotation.attrib <span class="kw">and</span> <span class="st">'TIME_SLOT_REF2'</span> <span class="kw">in</span> annotation.attrib:</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>                    ts_ref1 <span class="op">=</span> annotation.attrib[<span class="st">'TIME_SLOT_REF1'</span>]</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>                    ts_ref2 <span class="op">=</span> annotation.attrib[<span class="st">'TIME_SLOT_REF2'</span>]</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Get annotation ID if it exists, otherwise set to None</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>                    ann_id <span class="op">=</span> annotation.attrib.get(<span class="st">'ANNOTATION_ID'</span>, <span class="va">None</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>                    annotation_value <span class="op">=</span> annotation.find(<span class="st">'ANNOTATION_VALUE'</span>).text.strip()</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>                    annotations.append({</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'tier_id'</span>: tier_id,</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'annotation_id'</span>: ann_id,</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'start_time'</span>: time_slots[ts_ref1],</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'end_time'</span>: time_slots[ts_ref2],</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'annotation_value'</span>: annotation_value</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> annotations</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to load annotations into csv</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fillAnno(TSfile, ANNOfile, colname):</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    TSfile[colname] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> ANNOfile.iterrows():</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> row[<span class="dv">1</span>][<span class="dv">0</span>]</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        end <span class="op">=</span> row[<span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>        TSfile.loc[(TSfile[<span class="st">'time'</span>] <span class="op">&gt;=</span> start) <span class="op">&amp;</span> (TSfile[<span class="st">'time'</span>] <span class="op">&lt;=</span> end), colname] <span class="op">=</span> row[<span class="dv">1</span>][<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now we create text file for each tier separately, saving only the start time, end time and value (movement or nomovement) for each annotation file.</p>
<div id="cell-10" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># These are the manual annotations adapted with no-movement annotations</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>annofolder_manu <span class="op">=</span> os.path.join(curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">ManualAnno</span><span class="ch">\\</span><span class="st">R1</span><span class="ch">\\</span><span class="st">'</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>annofiles_manu <span class="op">=</span> glob.glob(annofolder_manu <span class="op">+</span> <span class="st">'*ELAN_tiers.eaf'</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">################</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">#### arms ######</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">################</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>arms_anno <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'/annotations_groundTruth/arms_annotations.txt'</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(arms_anno, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> annofiles_manu:</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'working on '</span> <span class="op">+</span> <span class="bu">file</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get the filename as the last element</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> <span class="bu">file</span>.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># replace _ELAN_tiers.eaf with ''</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> filename.replace(<span class="st">'_ELAN_tiers.eaf'</span>, <span class="st">''</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># parse the file</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        annotations <span class="op">=</span> parse_eaf_file(<span class="bu">file</span>, <span class="st">'arms'</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># write the annotations</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> annotation <span class="kw">in</span> annotations:</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>            f.write(<span class="ss">f"</span><span class="sc">{</span>annotation[<span class="st">'start_time'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>annotation[<span class="st">'end_time'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>annotation[<span class="st">'annotation_value'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>filename<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co">###################</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co">#### upper body####</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="co">###################</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>upperbody_anno <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'/annotations_groundTruth/upperbody_annotations.txt'</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(upperbody_anno, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> annofiles_manu:</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'working on '</span> <span class="op">+</span> <span class="bu">file</span>)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get the filename as the last element</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> <span class="bu">file</span>.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># replace _ELAN_tiers.eaf with ''</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> filename.replace(<span class="st">'_ELAN_tiers.eaf'</span>, <span class="st">''</span>)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># parse the file</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        annotations <span class="op">=</span> parse_eaf_file(<span class="bu">file</span>, <span class="st">'upper_body'</span>)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># write the annotations</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> annotation <span class="kw">in</span> annotations:</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>            f.write(<span class="ss">f"</span><span class="sc">{</span>annotation[<span class="st">'start_time'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>annotation[<span class="st">'end_time'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>annotation[<span class="st">'annotation_value'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>filename<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a><span class="co">###################</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a><span class="co">#### lower body####</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a><span class="co">###################</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>lowerbody_anno <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'/annotations_groundTruth/lowerbody_annotations.txt'</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(lowerbody_anno, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> annofiles_manu:</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'working on '</span> <span class="op">+</span> <span class="bu">file</span>)</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get the filename as the last element</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> <span class="bu">file</span>.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># replace _ELAN_tiers.eaf with ''</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> filename.replace(<span class="st">'_ELAN_tiers.eaf'</span>, <span class="st">''</span>)</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># parse the file</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>        annotations <span class="op">=</span> parse_eaf_file(<span class="bu">file</span>, <span class="st">'lower_body'</span>)</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># write the annotations</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> annotation <span class="kw">in</span> annotations:</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>            f.write(<span class="ss">f"</span><span class="sc">{</span>annotation[<span class="st">'start_time'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>annotation[<span class="st">'end_time'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>annotation[<span class="st">'annotation_value'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>filename<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a><span class="co">###################</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a><span class="co">##### head ########</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a><span class="co">###################</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>head_anno <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'/annotations_groundTruth/head_annotations.txt'</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(head_anno, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> annofiles_manu:</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'working on '</span> <span class="op">+</span> <span class="bu">file</span>)</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get the filename as the last element</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> <span class="bu">file</span>.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># replace _ELAN_tiers.eaf with ''</span></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> filename.replace(<span class="st">'_ELAN_tiers.eaf'</span>, <span class="st">''</span>)</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># parse the file</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>        annotations <span class="op">=</span> parse_eaf_file(<span class="bu">file</span>, <span class="st">'head_mov'</span>)</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># write the annotations</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> annotation <span class="kw">in</span> annotations:</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>            f.write(<span class="ss">f"</span><span class="sc">{</span>annotation[<span class="st">'start_time'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>annotation[<span class="st">'end_time'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>annotation[<span class="st">'annotation_value'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>filename<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="preparing-data-for-classifier" class="level1">
<h1>Preparing data for classifier</h1>
<p>In the following code, we merge the annotations with our merged files so that we can later sample from the data based on the annotations.</p>
<p>We will now also filter some superfluous information, as well as add some more such as:</p>
<ul>
<li>distance of LIndex to RIndex</li>
<li>distance of Wrist to Hip</li>
<li>distance of Head to Hip</li>
<li>distance of Head to Ankle</li>
</ul>
<div id="cell-12" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># These are the annotations per tier that we just created from manual annotations</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>arms_anno <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'/annotations_groundTruth/arms_annotations.txt'</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>upperbody_anno <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'/annotations_groundTruth/upperbody_annotations.txt'</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>lowerbody_anno <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'/annotations_groundTruth/lowerbody_annotations.txt'</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>head_anno <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'/annotations_groundTruth/head_annotations.txt'</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> processedfiles:</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TrialID</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    trialid <span class="op">=</span> <span class="bu">file</span>.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    trialid <span class="op">=</span> trialid.replace(<span class="st">'merged_'</span>, <span class="st">''</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'working on '</span> <span class="op">+</span> trialid)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the merged file</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> pd.read_csv(<span class="bu">file</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the annotations as df</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    arms <span class="op">=</span> pd.read_csv(arms_anno, sep<span class="op">=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    ub <span class="op">=</span> pd.read_csv(upperbody_anno, sep<span class="op">=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    lb <span class="op">=</span> pd.read_csv(lowerbody_anno, sep<span class="op">=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    head <span class="op">=</span> pd.read_csv(head_anno, sep<span class="op">=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    annos <span class="op">=</span> [arms, ub, lb, head]</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    practice <span class="op">=</span> <span class="va">False</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop over each tier and fill values into timeseries</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> anno_df <span class="kw">in</span> annos:</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the annotations for the trialid</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        anno_trial <span class="op">=</span> anno_df[anno_df[<span class="dv">3</span>] <span class="op">==</span> trialid] </span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> anno_trial.empty:</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'no annotations for '</span> <span class="op">+</span> trialid)  <span class="co"># This will be the case of practice trials that were not annotated</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>            practice <span class="op">=</span> <span class="va">True</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> anno_df.equals(arms):</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>                fillAnno(merged, anno_trial, <span class="st">'arms'</span>)</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> anno_df.equals(ub):</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>                fillAnno(merged, anno_trial, <span class="st">'upper_body'</span>)</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> anno_df.equals(lb):</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>                fillAnno(merged, anno_trial, <span class="st">'lower_body'</span>)</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> anno_df.equals(head):</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>                fillAnno(merged, anno_trial, <span class="st">'head_mov'</span>)</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">'something went wrong'</span>)</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> practice:</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> merged.copy()</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Now we will also add some features that might be relevant for the classifier</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">## RWrist to LWrist in all dimensions</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'wristDistance_x'</span>] <span class="op">=</span> df[<span class="st">'RWrist_x'</span>] <span class="op">-</span> df[<span class="st">'LWrist_x'</span>]</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'wristDistance_y'</span>] <span class="op">=</span> df[<span class="st">'RWrist_y'</span>] <span class="op">-</span> df[<span class="st">'LWrist_y'</span>]</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'wristDistance_z'</span>] <span class="op">=</span> df[<span class="st">'RWrist_z'</span>] <span class="op">-</span> df[<span class="st">'LWrist_z'</span>]</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">## RWrist to RHip</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'RwristRhipDistance_x'</span>] <span class="op">=</span> df[<span class="st">'RWrist_x'</span>] <span class="op">-</span> df[<span class="st">'RHip_x'</span>]</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'RwristRhipDistance_y'</span>] <span class="op">=</span> df[<span class="st">'RWrist_y'</span>] <span class="op">-</span> df[<span class="st">'RHip_y'</span>]</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'RwristRhipDistance_z'</span>] <span class="op">=</span> df[<span class="st">'RWrist_z'</span>] <span class="op">-</span> df[<span class="st">'RHip_z'</span>]</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>    <span class="co">## RWrist to LHip</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'RwristLhipDistance_x'</span>] <span class="op">=</span> df[<span class="st">'RWrist_x'</span>] <span class="op">-</span> df[<span class="st">'LHip_x'</span>]</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'RwristLhipDistance_y'</span>] <span class="op">=</span> df[<span class="st">'RWrist_y'</span>] <span class="op">-</span> df[<span class="st">'LHip_y'</span>]</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'RwristLhipDistance_z'</span>] <span class="op">=</span> df[<span class="st">'RWrist_z'</span>] <span class="op">-</span> df[<span class="st">'LHip_z'</span>]</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">## LWrist to LHip</span></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'LwristLhipDistance_x'</span>] <span class="op">=</span> df[<span class="st">'LWrist_x'</span>] <span class="op">-</span> df[<span class="st">'LHip_x'</span>]</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'LwristLhipDistance_y'</span>] <span class="op">=</span> df[<span class="st">'LWrist_y'</span>] <span class="op">-</span> df[<span class="st">'LHip_y'</span>]</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'LwristLhipDistance_z'</span>] <span class="op">=</span> df[<span class="st">'LWrist_z'</span>] <span class="op">-</span> df[<span class="st">'LHip_z'</span>]</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">## LWrist to RHip</span></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'LwristRhipDistance_x'</span>] <span class="op">=</span> df[<span class="st">'LWrist_x'</span>] <span class="op">-</span> df[<span class="st">'RHip_x'</span>]</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'LwristRhipDistance_y'</span>] <span class="op">=</span> df[<span class="st">'LWrist_y'</span>] <span class="op">-</span> df[<span class="st">'RHip_y'</span>]</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'LwristRhipDistance_z'</span>] <span class="op">=</span> df[<span class="st">'LWrist_z'</span>] <span class="op">-</span> df[<span class="st">'RHip_z'</span>]</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Head to RHip</span></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'HeadRhipDistance_x'</span>] <span class="op">=</span> df[<span class="st">'Head_x'</span>] <span class="op">-</span> df[<span class="st">'RHip_x'</span>]</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'HeadRhipDistance_y'</span>] <span class="op">=</span> df[<span class="st">'Head_y'</span>] <span class="op">-</span> df[<span class="st">'RHip_y'</span>]</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'HeadRhipDistance_z'</span>] <span class="op">=</span> df[<span class="st">'Head_z'</span>] <span class="op">-</span> df[<span class="st">'RHip_z'</span>]</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Head to RAnkle</span></span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'HeadRankleDistance_x'</span>] <span class="op">=</span> df[<span class="st">'Head_x'</span>] <span class="op">-</span> df[<span class="st">'RAnkle_x'</span>]</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'HeadRankleDistance_y'</span>] <span class="op">=</span> df[<span class="st">'Head_y'</span>] <span class="op">-</span> df[<span class="st">'RAnkle_y'</span>]</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'HeadRankleDistance_z'</span>] <span class="op">=</span> df[<span class="st">'Head_z'</span>] <span class="op">-</span> df[<span class="st">'RAnkle_z'</span>]</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get rid of superfluous columns</span></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop(columns<span class="op">=</span>[<span class="st">'left_back'</span>, <span class="st">'right_forward'</span>, <span class="st">'right_back'</span>, <span class="st">'left_forward'</span>, <span class="st">'COPXc'</span>, <span class="st">'COPYc'</span>, <span class="st">'FileInfo'</span>])</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># And we also don't need vocal features</span></span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>    cols <span class="op">=</span> df.columns</span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>    colstodrop <span class="op">=</span> [<span class="st">'envelope'</span>, <span class="st">'audio'</span>, <span class="st">'envelope_change'</span>, <span class="st">'audio'</span>, <span class="st">'f0'</span>, <span class="st">'f1'</span>, <span class="st">'f2'</span>, <span class="st">'f3'</span>, <span class="st">'env_'</span>, <span class="st">'CoG'</span>]</span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>    newcols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> cols <span class="cf">if</span> <span class="kw">not</span> <span class="bu">any</span>(x <span class="kw">in</span> col <span class="cf">for</span> x <span class="kw">in</span> colstodrop)]</span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[newcols]   </span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save it</span></span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>    df.to_csv(curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">TS_annotated</span><span class="ch">\\</span><span class="st">merged_anno_'</span> <span class="op">+</span> trialid <span class="op">+</span> <span class="st">'.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we are ready to create the training set for the logistic regression model.</p>
</section>
<section id="sumarizing-features-for-training-dataset" class="level1">
<h1>Sumarizing features for training dataset</h1>
<p>Now we will sample windows from movement and nomovement for each tier and summarize the available features in terms of mean, sd, min and max. Note that we will not create training data for each tier separately. Sometimes, it may be useful to predict movement of a specific body part with the information about other body part.</p>
<p>Each tier varies in the length of movement and non-movement chunk, but we will proceed in uniform way, setting threshold of 50 rows, i.e., 100 ms. In such a short period of time, it is anyway difficult to initiate any meaningful movement in any of the tiers of interest - head, arms, upper body, lower body.</p>
<p>We will sample the windows randomly, but also make sure there is enough border cases (i.e., windows that capture end or beginning of the movement). Our participants are ‘locking’ hands in the beginning and in the end of each performance. Our classifier should know that these are not ‘communicative’ movements per se.</p>
<p>(Note that this code takes a while to execute.)</p>
<div id="cell-15" class="cell" data-execution_count="28">
<details class="code-fold">
<summary>Custom functions</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to sample random consecutive rows from a df</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> select_random_consecutive_rows(df, change_col, threshold):</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group the DataFrame by the 'change' column</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    grouped <span class="op">=</span> df.groupby(change_col)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List to hold the selected rows</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    selected_rows <span class="op">=</span> []</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop over each group</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> group_df <span class="kw">in</span> grouped:</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get the first index</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        idx_start <span class="op">=</span> group_df[<span class="dv">1</span>].index[<span class="dv">0</span>]</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get the last index</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        idx_last <span class="op">=</span> group_df[<span class="dv">1</span>].index[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if the group is large enough to select 'threshold' rows</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(group_df[<span class="dv">1</span>]) <span class="op">&gt;=</span> threshold:</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Randomly choose a starting index for consecutive selection that is within the index range of the group</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>            start_idx <span class="op">=</span> np.random.randint(idx_start, idx_last <span class="op">-</span> threshold <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Select consecutive rows from that start index</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>            selected <span class="op">=</span> df.loc[start_idx:start_idx <span class="op">+</span> threshold <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>            selected_rows.append(selected)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Concatenate all selected rows into a single DataFrame</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    result_df <span class="op">=</span> pd.concat(selected_rows)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result_df</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Transforming the dictionary into a df</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dict_to_df(data):</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Flatten the dictionary into a format with keys like 'feature_mean', 'feature_std', etc.</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    flat_data <span class="op">=</span> {}</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature, stats <span class="kw">in</span> data.items():</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> stat, value <span class="kw">in</span> stats.items():</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>            flat_data[<span class="ss">f'</span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>stat<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> value</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the flat dictionary to a DataFrame with a single row</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(flat_data, index<span class="op">=</span>[<span class="dv">0</span>])</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set seed for reproducibility</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># These are our timeseries to be sampled from</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>samplingfolder <span class="op">=</span> os.path.join(curfolder <span class="op">+</span> <span class="st">'/TS_annotated/'</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>samplingfiles <span class="op">=</span> glob.glob(samplingfolder <span class="op">+</span> <span class="st">'*.csv'</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>tiers <span class="op">=</span> [<span class="st">'arms'</span>, <span class="st">'upper_body'</span>, <span class="st">'lower_body'</span>, <span class="st">'head_mov'</span>]</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>threshold_m <span class="op">=</span> <span class="dv">50</span> <span class="co"># threshold for movement (100 ms)</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>threshold_nm <span class="op">=</span> <span class="dv">50</span> <span class="co"># threshold for no movement</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> tierofinterest <span class="kw">in</span> tiers:</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    dataset_features <span class="op">=</span> pd.DataFrame()</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    summaries_m <span class="op">=</span> {}</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    summaries_nm <span class="op">=</span> {}</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    counter <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> samplingfiles:</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> pd.read_csv(<span class="bu">file</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the df doesn't have columns arms, upper_body, lower_body, head_mov, skip it</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'arms'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns <span class="kw">or</span> <span class="st">'upper_body'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns <span class="kw">or</span> <span class="st">'lower_body'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns <span class="kw">or</span> <span class="st">'head_mov'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'skipping '</span> <span class="op">+</span> <span class="bu">file</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># TrialID</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        trialid <span class="op">=</span> <span class="bu">file</span>.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Annotate unique movement/no movement chunks</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'row_change'</span>] <span class="op">=</span> df[tierofinterest].ne(df[tierofinterest].shift()).cumsum()</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sample random 5 samples of the threshold length in both movement and no movement in tier</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        tier_m <span class="op">=</span> df[df[tierofinterest] <span class="op">==</span> <span class="st">'movement'</span>]</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        tier_nm <span class="op">=</span> df[df[tierofinterest] <span class="op">==</span> <span class="st">'nomovement'</span>]</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> tier_m.empty:</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 10 samples</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>                tier_m_sample <span class="op">=</span> select_random_consecutive_rows(tier_m, <span class="st">'row_change'</span>, threshold_m)</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Get summaries for numerical columns</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>                num_cols <span class="op">=</span> df.select_dtypes(include<span class="op">=</span>np.number).columns</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>                num_cols <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> num_cols <span class="cf">if</span> x <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'time'</span>, <span class="st">'row_change'</span>]]</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> col <span class="kw">in</span> num_cols:</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Get stats and save them to dictionary</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>                    stats <span class="op">=</span> tier_m_sample[col].describe().to_dict()</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>                    summaries_m[col] <span class="op">=</span> stats</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Dictionary to df row</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>                summary_row_m <span class="op">=</span> dict_to_df(summaries_m)</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>                <span class="co"># We don't need count stats</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>                summary_row_m <span class="op">=</span> summary_row_m.loc[:, <span class="op">~</span>summary_row_m.columns.<span class="bu">str</span>.contains(<span class="st">'count|%'</span>, regex<span class="op">=</span><span class="va">True</span>)]</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add metainfo</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>                summary_row_m[<span class="st">'trialid'</span>] <span class="op">=</span> trialid</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>                summary_row_m[<span class="st">'eventid'</span>] <span class="op">=</span> trialid <span class="op">+</span> <span class="st">'_mov_'</span> <span class="op">+</span> <span class="bu">str</span>(counter)</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>                summary_row_m[<span class="st">'anno_value'</span>] <span class="op">=</span> <span class="st">'movement'</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add row to the main df</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>                dataset_features <span class="op">=</span> pd.concat([dataset_features, summary_row_m])</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>                counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>        counter <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> tier_nm.empty:</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>                tier_nm_sample <span class="op">=</span> select_random_consecutive_rows(tier_nm, <span class="st">'row_change'</span>, threshold_nm)</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Get summaries for numerical columns</span></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>                num_cols <span class="op">=</span> df.select_dtypes(include<span class="op">=</span>np.number).columns</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>                num_cols <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> num_cols <span class="cf">if</span> x <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'time'</span>, <span class="st">'row_change'</span>]]</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> col <span class="kw">in</span> num_cols:</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Get stats and save them to dictionary</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>                    stats <span class="op">=</span> tier_nm_sample[col].describe().to_dict()</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>                    summaries_nm[col] <span class="op">=</span> stats</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Dictionary to df row</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>                summary_row_nm <span class="op">=</span> dict_to_df(summaries_nm)</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>                summary_row_nm <span class="op">=</span> summary_row_nm.loc[:, <span class="op">~</span>summary_row_nm.columns.<span class="bu">str</span>.contains(<span class="st">'count|%'</span>, regex<span class="op">=</span><span class="va">True</span>)]</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add metainfo</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>                summary_row_nm[<span class="st">'trialid'</span>] <span class="op">=</span> trialid</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>                summary_row_nm[<span class="st">'eventid'</span>] <span class="op">=</span> trialid <span class="op">+</span> <span class="st">'_nonmov_'</span> <span class="op">+</span> <span class="bu">str</span>(counter)</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>                summary_row_nm[<span class="st">'anno_value'</span>] <span class="op">=</span> <span class="st">'nomovement'</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Add row to the main df</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>                dataset_features <span class="op">=</span> pd.concat([dataset_features, summary_row_nm])</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>                counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>        counter <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>        <span class="co">###################### Process border windows</span></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>        border_rows <span class="op">=</span> []</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Identify the rows where the tierofinterest changes</span></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>        change_points <span class="op">=</span> df[df[<span class="st">'row_change'</span>].diff().<span class="bu">abs</span>() <span class="op">&gt;</span> <span class="dv">0</span>].index</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx <span class="kw">in</span> change_points:</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get the window before the change</span></span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>            before_start <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, idx <span class="op">-</span> <span class="dv">25</span>)  <span class="co"># Ensure no negative index</span></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>            before_end <span class="op">=</span> idx  <span class="co"># Up to the change point</span></span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>            before_window <span class="op">=</span> df.iloc[before_start:before_end]</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get the annotation value</span></span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>            anno_value <span class="op">=</span> df.loc[idx, tierofinterest]</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get the window after the change</span></span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>            after_start <span class="op">=</span> idx</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>            after_end <span class="op">=</span> <span class="bu">min</span>(<span class="bu">len</span>(df), idx <span class="op">+</span> <span class="dv">25</span>)  <span class="co"># Ensure no index exceeds the DataFrame length</span></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>            after_window <span class="op">=</span> df.iloc[after_start:after_end]</span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Process the 'before' window in the same way like classic chunks above</span></span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> before_window.empty:</span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>                num_cols <span class="op">=</span> df.select_dtypes(include<span class="op">=</span>np.number).columns</span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>                num_cols <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> num_cols <span class="cf">if</span> x <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'time'</span>, <span class="st">'row_change'</span>]]</span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>                summaries_before <span class="op">=</span> {col: before_window[col].describe().to_dict() <span class="cf">for</span> col <span class="kw">in</span> num_cols}</span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>                summary_row_before <span class="op">=</span> dict_to_df(summaries_before)</span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>                summary_row_before <span class="op">=</span> summary_row_before.loc[:, <span class="op">~</span>summary_row_before.columns.<span class="bu">str</span>.contains(<span class="st">'count|%'</span>, regex<span class="op">=</span><span class="va">True</span>)]</span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>                summary_row_before[<span class="st">'trialid'</span>] <span class="op">=</span> trialid</span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> anno_value <span class="op">==</span> <span class="st">'movement'</span>:</span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>                    summary_row_before[<span class="st">'eventid'</span>] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>trialid<span class="sc">}</span><span class="ss">_border_mov_</span><span class="sc">{</span>counter<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>                    summary_row_before[<span class="st">'eventid'</span>] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>trialid<span class="sc">}</span><span class="ss">_border_nonmov_</span><span class="sc">{</span>counter<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>                summary_row_before[<span class="st">'anno_value'</span>] <span class="op">=</span> anno_value</span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>                dataset_features <span class="op">=</span> pd.concat([dataset_features, summary_row_before])</span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>                counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Process the 'after' window in the same way like classic chunks above</span></span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> after_window.empty:</span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>                summaries_after <span class="op">=</span> {col: after_window[col].describe().to_dict() <span class="cf">for</span> col <span class="kw">in</span> num_cols}</span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>                summary_row_after <span class="op">=</span> dict_to_df(summaries_after)</span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>                summary_row_after <span class="op">=</span> summary_row_after.loc[:, <span class="op">~</span>summary_row_after.columns.<span class="bu">str</span>.contains(<span class="st">'count|%'</span>, regex<span class="op">=</span><span class="va">True</span>)]</span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>                summary_row_after[<span class="st">'trialid'</span>] <span class="op">=</span> trialid</span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> anno_value <span class="op">==</span> <span class="st">'movement'</span>:</span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>                    summary_row_after[<span class="st">'eventid'</span>] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>trialid<span class="sc">}</span><span class="ss">_border_mov_</span><span class="sc">{</span>counter<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>                    summary_row_after[<span class="st">'eventid'</span>] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>trialid<span class="sc">}</span><span class="ss">_border_nonmov_</span><span class="sc">{</span>counter<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>                summary_row_after[<span class="st">'anno_value'</span>] <span class="op">=</span> anno_value</span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a>                dataset_features <span class="op">=</span> pd.concat([dataset_features, summary_row_after])</span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a>                counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop all columns with NaN values</span></span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>    dataset_features <span class="op">=</span> dataset_features.dropna(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save it</span></span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> <span class="st">'</span><span class="ch">\\</span><span class="st">dataset_'</span> <span class="op">+</span> tierofinterest <span class="op">+</span> <span class="st">'_features.csv'</span></span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a>    dataset_features.to_csv(datasetfolder <span class="op">+</span> filename, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a>        </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is how the dataset looks like</p>
<div id="cell-18" class="cell" data-execution_count="30">
<div class="cell-output cell-output-display" data-execution_count="30">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">COPc_mean</th>
<th data-quarto-table-cell-role="th">COPc_std</th>
<th data-quarto-table-cell-role="th">COPc_min</th>
<th data-quarto-table-cell-role="th">COPc_max</th>
<th data-quarto-table-cell-role="th">pelvis_tilt_moment_mean</th>
<th data-quarto-table-cell-role="th">pelvis_tilt_moment_std</th>
<th data-quarto-table-cell-role="th">pelvis_tilt_moment_min</th>
<th data-quarto-table-cell-role="th">pelvis_tilt_moment_max</th>
<th data-quarto-table-cell-role="th">pelvis_list_moment_mean</th>
<th data-quarto-table-cell-role="th">pelvis_list_moment_std</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">HeadRankleDistance_y_std</th>
<th data-quarto-table-cell-role="th">HeadRankleDistance_y_min</th>
<th data-quarto-table-cell-role="th">HeadRankleDistance_y_max</th>
<th data-quarto-table-cell-role="th">HeadRankleDistance_z_mean</th>
<th data-quarto-table-cell-role="th">HeadRankleDistance_z_std</th>
<th data-quarto-table-cell-role="th">HeadRankleDistance_z_min</th>
<th data-quarto-table-cell-role="th">HeadRankleDistance_z_max</th>
<th data-quarto-table-cell-role="th">trialid</th>
<th data-quarto-table-cell-role="th">eventid</th>
<th data-quarto-table-cell-role="th">anno_value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.001029</td>
<td>0.000353</td>
<td>0.000497</td>
<td>0.001539</td>
<td>11.916939</td>
<td>0.523783</td>
<td>10.259013</td>
<td>12.440273</td>
<td>40.593621</td>
<td>1.214134</td>
<td>...</td>
<td>0.388264</td>
<td>-47.812929</td>
<td>-46.498456</td>
<td>142.714523</td>
<td>0.264402</td>
<td>142.303580</td>
<td>143.190783</td>
<td>merged_anno_0_1_44_p0</td>
<td>merged_anno_0_1_44_p0_mov_1</td>
<td>movement</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.002310</td>
<td>0.000357</td>
<td>0.001384</td>
<td>0.002592</td>
<td>-5.251434</td>
<td>6.670124</td>
<td>-14.455521</td>
<td>6.433171</td>
<td>-43.388846</td>
<td>11.359658</td>
<td>...</td>
<td>0.951654</td>
<td>-46.226361</td>
<td>-43.045054</td>
<td>147.654005</td>
<td>0.819087</td>
<td>146.352625</td>
<td>149.044777</td>
<td>merged_anno_0_1_44_p0</td>
<td>merged_anno_0_1_44_p0_mov_2</td>
<td>movement</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.001229</td>
<td>0.000654</td>
<td>0.000325</td>
<td>0.002082</td>
<td>4.686266</td>
<td>1.693475</td>
<td>0.823981</td>
<td>6.247819</td>
<td>24.678865</td>
<td>12.110897</td>
<td>...</td>
<td>0.668766</td>
<td>-50.287726</td>
<td>-48.094340</td>
<td>139.471133</td>
<td>0.828517</td>
<td>138.035172</td>
<td>140.793319</td>
<td>merged_anno_0_1_44_p0</td>
<td>merged_anno_0_1_44_p0_mov_3</td>
<td>movement</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.010437</td>
<td>0.003827</td>
<td>0.005062</td>
<td>0.016617</td>
<td>9.534314</td>
<td>4.984207</td>
<td>1.780355</td>
<td>16.748078</td>
<td>-22.117817</td>
<td>12.681626</td>
<td>...</td>
<td>0.335743</td>
<td>-48.799024</td>
<td>-47.725756</td>
<td>143.580503</td>
<td>0.088882</td>
<td>143.457698</td>
<td>143.710256</td>
<td>merged_anno_0_1_44_p0</td>
<td>merged_anno_0_1_44_p0_mov_4</td>
<td>movement</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.001004</td>
<td>0.000326</td>
<td>0.000497</td>
<td>0.001522</td>
<td>11.714350</td>
<td>0.759333</td>
<td>9.564795</td>
<td>12.252050</td>
<td>40.096545</td>
<td>1.999604</td>
<td>...</td>
<td>0.406749</td>
<td>-47.938470</td>
<td>-46.575235</td>
<td>142.787307</td>
<td>0.272442</td>
<td>142.360696</td>
<td>143.261214</td>
<td>merged_anno_0_1_44_p0</td>
<td>merged_anno_0_1_44_p0_mov_5</td>
<td>movement</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0.001461</td>
<td>0.000432</td>
<td>0.000692</td>
<td>0.002762</td>
<td>13.462955</td>
<td>1.314506</td>
<td>12.131364</td>
<td>15.747833</td>
<td>48.942522</td>
<td>10.038141</td>
<td>...</td>
<td>0.266764</td>
<td>-46.886244</td>
<td>-46.003796</td>
<td>142.217696</td>
<td>0.202835</td>
<td>141.921413</td>
<td>142.578043</td>
<td>merged_anno_0_1_44_p0</td>
<td>merged_anno_0_1_44_p0_mov_6</td>
<td>movement</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>0.005301</td>
<td>0.000282</td>
<td>0.004481</td>
<td>0.005716</td>
<td>-9.424995</td>
<td>13.097252</td>
<td>-24.188497</td>
<td>14.602104</td>
<td>-123.839005</td>
<td>12.716710</td>
<td>...</td>
<td>0.598752</td>
<td>-26.614199</td>
<td>-24.623861</td>
<td>159.472153</td>
<td>0.330003</td>
<td>158.899835</td>
<td>160.012364</td>
<td>merged_anno_0_1_44_p0</td>
<td>merged_anno_0_1_44_p0_mov_7</td>
<td>movement</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>0.004990</td>
<td>0.000920</td>
<td>0.003090</td>
<td>0.007364</td>
<td>12.518248</td>
<td>2.241052</td>
<td>9.648455</td>
<td>15.750968</td>
<td>87.260236</td>
<td>6.093794</td>
<td>...</td>
<td>0.132448</td>
<td>-45.982839</td>
<td>-45.587361</td>
<td>141.964505</td>
<td>0.093210</td>
<td>141.876556</td>
<td>142.181769</td>
<td>merged_anno_0_1_44_p0</td>
<td>merged_anno_0_1_44_p0_mov_8</td>
<td>movement</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>0.003358</td>
<td>0.000680</td>
<td>0.002573</td>
<td>0.004292</td>
<td>14.285585</td>
<td>8.257143</td>
<td>-3.787133</td>
<td>23.009216</td>
<td>4.935150</td>
<td>15.441791</td>
<td>...</td>
<td>0.914203</td>
<td>-31.859550</td>
<td>-28.740297</td>
<td>156.858607</td>
<td>0.546987</td>
<td>155.927757</td>
<td>157.763944</td>
<td>merged_anno_0_1_44_p0</td>
<td>merged_anno_0_1_44_p0_mov_9</td>
<td>movement</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>0.000474</td>
<td>0.000222</td>
<td>0.000257</td>
<td>0.001104</td>
<td>7.607259</td>
<td>1.802191</td>
<td>3.210280</td>
<td>9.359289</td>
<td>-80.437708</td>
<td>8.600917</td>
<td>...</td>
<td>0.621470</td>
<td>-31.547830</td>
<td>-29.416171</td>
<td>158.248435</td>
<td>0.507886</td>
<td>157.346089</td>
<td>159.038608</td>
<td>merged_anno_0_1_44_p0</td>
<td>merged_anno_0_1_44_p0_mov_10</td>
<td>movement</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>0.000327</td>
<td>0.000172</td>
<td>0.000081</td>
<td>0.000551</td>
<td>1.142706</td>
<td>2.774018</td>
<td>-2.489563</td>
<td>6.568694</td>
<td>-59.022974</td>
<td>8.534245</td>
<td>...</td>
<td>0.808444</td>
<td>-22.051561</td>
<td>-20.066378</td>
<td>159.953388</td>
<td>0.388046</td>
<td>159.529543</td>
<td>160.445080</td>
<td>merged_anno_0_1_44_p0</td>
<td>merged_anno_0_1_44_p0_nonmov_1</td>
<td>nomovement</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>0.000859</td>
<td>0.000627</td>
<td>0.000175</td>
<td>0.001681</td>
<td>1.956649</td>
<td>2.745580</td>
<td>-1.319160</td>
<td>6.667728</td>
<td>-60.887893</td>
<td>1.757583</td>
<td>...</td>
<td>0.224639</td>
<td>-21.057542</td>
<td>-20.421462</td>
<td>160.343627</td>
<td>0.493233</td>
<td>159.797253</td>
<td>160.919489</td>
<td>merged_anno_0_1_44_p0</td>
<td>merged_anno_0_1_44_p0_nonmov_2</td>
<td>nomovement</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>0.000508</td>
<td>0.000227</td>
<td>0.000243</td>
<td>0.001041</td>
<td>1.658757</td>
<td>0.735249</td>
<td>0.017040</td>
<td>3.188685</td>
<td>-67.195356</td>
<td>6.031778</td>
<td>...</td>
<td>2.212455</td>
<td>-25.605054</td>
<td>-20.390822</td>
<td>160.404137</td>
<td>0.263193</td>
<td>159.981512</td>
<td>160.727456</td>
<td>merged_anno_0_1_44_p0</td>
<td>merged_anno_0_1_44_p0_nonmov_3</td>
<td>nomovement</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>0.000446</td>
<td>0.000291</td>
<td>0.000050</td>
<td>0.001093</td>
<td>2.139294</td>
<td>1.726763</td>
<td>-0.846748</td>
<td>6.088638</td>
<td>-62.201977</td>
<td>2.714513</td>
<td>...</td>
<td>0.336568</td>
<td>-21.325884</td>
<td>-20.390822</td>
<td>160.209853</td>
<td>0.453761</td>
<td>159.732042</td>
<td>160.736602</td>
<td>merged_anno_0_1_44_p0</td>
<td>merged_anno_0_1_44_p0_nonmov_4</td>
<td>nomovement</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>0.000276</td>
<td>0.000111</td>
<td>0.000125</td>
<td>0.000471</td>
<td>1.090214</td>
<td>1.638015</td>
<td>-1.945115</td>
<td>3.100118</td>
<td>-63.428529</td>
<td>5.286197</td>
<td>...</td>
<td>1.425956</td>
<td>-24.065452</td>
<td>-20.488453</td>
<td>160.027971</td>
<td>0.174932</td>
<td>159.755498</td>
<td>160.246507</td>
<td>merged_anno_0_1_44_p0</td>
<td>merged_anno_0_1_44_p0_nonmov_5</td>
<td>nomovement</td>
</tr>
</tbody>
</table>

<p>15 rows × 1263 columns</p>
</div>
</div>
</div>
</div>
</section>
<section id="preparing-timeseries-for-classifying" class="level1">
<h1>Preparing timeseries for classifying</h1>
<p>Now we also prepare data for the classifier. We will use the same features as in the previous step, but now we will summarize whole timeseries from beginning to the end. Every time, we take 100ms chunk, and slide with 25ms step, such that we have overlap between the chunks and can later assess more accurately when exactly is the movement onsent/offset.</p>
<div id="cell-20" class="cell" data-execution_count="31">
<details class="code-fold">
<summary>Custom functions</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to summarize every 50 rows with overlapping intervals, sliding by 12 rows</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summarize_consecutive_rows(df, trialid, num_cols, summary_interval<span class="op">=</span><span class="dv">50</span>, slide_step<span class="op">=</span><span class="dv">12</span>):</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    summary_df <span class="op">=</span> pd.DataFrame()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    counter <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> start_idx <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(df), slide_step):</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Select a slice of 50 rows (or fewer for the last chunk)</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        selected <span class="op">=</span> df.iloc[start_idx:start_idx <span class="op">+</span> summary_interval]</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stop if there are no more rows to process</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> selected.empty:</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        summary_stats <span class="op">=</span> {}</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate statistics for each numerical column</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> num_cols:</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>            stats <span class="op">=</span> selected[col].describe().to_dict()</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>            summary_stats[col] <span class="op">=</span> stats</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert to DataFrame row format</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        summary_row <span class="op">=</span> dict_to_df(summary_stats)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add start and end time for the chunk</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>        summary_row[<span class="st">'start_time'</span>] <span class="op">=</span> selected[<span class="st">'time'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>        summary_row[<span class="st">'end_time'</span>] <span class="op">=</span> selected[<span class="st">'time'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add chunk number</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>        summary_row[<span class="st">'eventid'</span>] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>trialid<span class="sc">}</span><span class="ss">_chunk_</span><span class="sc">{</span>counter<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get rid of all columns that contain 'count' or '%' in the name</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        summary_row <span class="op">=</span> summary_row.loc[:, <span class="op">~</span>summary_row.columns.<span class="bu">str</span>.contains(<span class="st">'count|%'</span>, regex<span class="op">=</span><span class="va">True</span>)]</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Append to the main DataFrame</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>        summary_df <span class="op">=</span> pd.concat([summary_df, summary_row], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>        counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the selected already contains time of the last row, finish</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> selected[<span class="st">'time'</span>].iloc[<span class="op">-</span><span class="dv">1</span>] <span class="op">==</span> df[<span class="st">'time'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> summary_df</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> summary_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-21" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Main df to store all summaries</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>summary_df <span class="op">=</span> pd.DataFrame()</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> samplingfiles:</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TrialID</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    trialid <span class="op">=</span> <span class="bu">file</span>.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(<span class="bu">file</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the df doesn't have columns arms, upper_body, lower_body, head_mov, skip it</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'arms'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns <span class="kw">or</span> <span class="st">'upper_body'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns <span class="kw">or</span> <span class="st">'lower_body'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns <span class="kw">or</span> <span class="st">'head_mov'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'skipping '</span> <span class="op">+</span> trialid)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'working on '</span> <span class="op">+</span> trialid)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define numerical columns (excluding 'time' and 'change' if present)</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    num_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.select_dtypes(include<span class="op">=</span>np.number).columns <span class="cf">if</span> col <span class="op">!=</span> <span class="st">'change'</span> <span class="kw">and</span> col <span class="op">!=</span> <span class="st">'time'</span>]</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Summarize data in intervals of 50 rows, sliding by 12 rows</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    summary_df <span class="op">=</span> summarize_consecutive_rows(df, trialid, num_cols, summary_interval<span class="op">=</span><span class="dv">50</span>, slide_step<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add trial ID </span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    summary_df[<span class="st">'trialid'</span>] <span class="op">=</span> trialid</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save it</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    summary_df.to_csv(chunked_folder <span class="op">+</span> trialid <span class="op">+</span> <span class="st">'_chunked.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'All done, now we can proceed with annotation with our classifier'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is an example file that contains timeseries processed into chunks</p>
<div id="cell-23" class="cell" data-execution_count="33">
<div class="cell-output cell-output-display" data-execution_count="33">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">COPc_mean</th>
<th data-quarto-table-cell-role="th">COPc_std</th>
<th data-quarto-table-cell-role="th">COPc_min</th>
<th data-quarto-table-cell-role="th">COPc_max</th>
<th data-quarto-table-cell-role="th">pelvis_tilt_moment_mean</th>
<th data-quarto-table-cell-role="th">pelvis_tilt_moment_std</th>
<th data-quarto-table-cell-role="th">pelvis_tilt_moment_min</th>
<th data-quarto-table-cell-role="th">pelvis_tilt_moment_max</th>
<th data-quarto-table-cell-role="th">pelvis_list_moment_mean</th>
<th data-quarto-table-cell-role="th">pelvis_list_moment_std</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">HeadRankleDistance_y_min</th>
<th data-quarto-table-cell-role="th">HeadRankleDistance_y_max</th>
<th data-quarto-table-cell-role="th">HeadRankleDistance_z_mean</th>
<th data-quarto-table-cell-role="th">HeadRankleDistance_z_std</th>
<th data-quarto-table-cell-role="th">HeadRankleDistance_z_min</th>
<th data-quarto-table-cell-role="th">HeadRankleDistance_z_max</th>
<th data-quarto-table-cell-role="th">start_time</th>
<th data-quarto-table-cell-role="th">end_time</th>
<th data-quarto-table-cell-role="th">eventid</th>
<th data-quarto-table-cell-role="th">trialid</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.000209</td>
<td>0.000104</td>
<td>0.000023</td>
<td>0.000360</td>
<td>-4.822713</td>
<td>0.329021</td>
<td>-5.373228</td>
<td>-4.274271</td>
<td>24.058442</td>
<td>0.542426</td>
<td>...</td>
<td>157.008942</td>
<td>157.158540</td>
<td>7.932183</td>
<td>0.016104</td>
<td>7.913146</td>
<td>7.966076</td>
<td>0.0</td>
<td>98.0</td>
<td>merged_anno_0_1_4_p0_chunk_1</td>
<td>merged_anno_0_1_4_p0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.000264</td>
<td>0.000098</td>
<td>0.000118</td>
<td>0.000380</td>
<td>-4.552120</td>
<td>0.326263</td>
<td>-5.103672</td>
<td>-4.004715</td>
<td>23.612342</td>
<td>0.537878</td>
<td>...</td>
<td>157.050898</td>
<td>157.187292</td>
<td>7.921748</td>
<td>0.009694</td>
<td>7.912271</td>
<td>7.944289</td>
<td>24.0</td>
<td>122.0</td>
<td>merged_anno_0_1_4_p0_chunk_2</td>
<td>merged_anno_0_1_4_p0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.000316</td>
<td>0.000073</td>
<td>0.000136</td>
<td>0.000390</td>
<td>-4.283394</td>
<td>0.326321</td>
<td>-4.834117</td>
<td>-3.735160</td>
<td>23.169319</td>
<td>0.537974</td>
<td>...</td>
<td>157.089436</td>
<td>157.213695</td>
<td>7.916291</td>
<td>0.004669</td>
<td>7.912271</td>
<td>7.928391</td>
<td>48.0</td>
<td>146.0</td>
<td>merged_anno_0_1_4_p0_chunk_3</td>
<td>merged_anno_0_1_4_p0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.000345</td>
<td>0.000029</td>
<td>0.000288</td>
<td>0.000403</td>
<td>-4.014668</td>
<td>0.326350</td>
<td>-4.564561</td>
<td>-3.465605</td>
<td>22.726297</td>
<td>0.538022</td>
<td>...</td>
<td>157.124298</td>
<td>157.237953</td>
<td>7.914763</td>
<td>0.002189</td>
<td>7.912271</td>
<td>7.919865</td>
<td>72.0</td>
<td>170.0</td>
<td>merged_anno_0_1_4_p0_chunk_4</td>
<td>merged_anno_0_1_4_p0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.000396</td>
<td>0.000097</td>
<td>0.000288</td>
<td>0.000649</td>
<td>-3.745942</td>
<td>0.326350</td>
<td>-4.295006</td>
<td>-3.196049</td>
<td>22.283274</td>
<td>0.538022</td>
<td>...</td>
<td>157.156162</td>
<td>157.260390</td>
<td>7.916547</td>
<td>0.004392</td>
<td>7.912271</td>
<td>7.926353</td>
<td>96.0</td>
<td>194.0</td>
<td>merged_anno_0_1_4_p0_chunk_5</td>
<td>merged_anno_0_1_4_p0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0.000463</td>
<td>0.000139</td>
<td>0.000288</td>
<td>0.000669</td>
<td>-3.477216</td>
<td>0.326321</td>
<td>-4.025450</td>
<td>-2.926494</td>
<td>21.840251</td>
<td>0.537974</td>
<td>...</td>
<td>157.185195</td>
<td>157.281624</td>
<td>7.920605</td>
<td>0.006376</td>
<td>7.912421</td>
<td>7.931427</td>
<td>120.0</td>
<td>218.0</td>
<td>merged_anno_0_1_4_p0_chunk_6</td>
<td>merged_anno_0_1_4_p0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>0.000517</td>
<td>0.000134</td>
<td>0.000288</td>
<td>0.000669</td>
<td>-3.208490</td>
<td>0.326263</td>
<td>-3.755895</td>
<td>-2.656938</td>
<td>21.397228</td>
<td>0.537878</td>
<td>...</td>
<td>157.211721</td>
<td>157.303893</td>
<td>7.923801</td>
<td>0.005444</td>
<td>7.914729</td>
<td>7.931427</td>
<td>144.0</td>
<td>242.0</td>
<td>merged_anno_0_1_4_p0_chunk_7</td>
<td>merged_anno_0_1_4_p0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>0.000596</td>
<td>0.000070</td>
<td>0.000380</td>
<td>0.000669</td>
<td>-2.939764</td>
<td>0.326176</td>
<td>-3.486340</td>
<td>-2.406044</td>
<td>20.954205</td>
<td>0.537735</td>
<td>...</td>
<td>157.236187</td>
<td>157.327390</td>
<td>7.920155</td>
<td>0.012288</td>
<td>7.885567</td>
<td>7.931427</td>
<td>168.0</td>
<td>266.0</td>
<td>merged_anno_0_1_4_p0_chunk_8</td>
<td>merged_anno_0_1_4_p0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>0.000629</td>
<td>0.000029</td>
<td>0.000576</td>
<td>0.000669</td>
<td>-2.672253</td>
<td>0.324061</td>
<td>-3.216784</td>
<td>-2.142126</td>
<td>20.510529</td>
<td>0.538635</td>
<td>...</td>
<td>157.258711</td>
<td>157.353423</td>
<td>7.906374</td>
<td>0.026949</td>
<td>7.853243</td>
<td>7.931427</td>
<td>192.0</td>
<td>290.0</td>
<td>merged_anno_0_1_4_p0_chunk_9</td>
<td>merged_anno_0_1_4_p0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>0.000612</td>
<td>0.000038</td>
<td>0.000488</td>
<td>0.000661</td>
<td>-2.419432</td>
<td>0.304439</td>
<td>-2.965890</td>
<td>-1.963964</td>
<td>20.058402</td>
<td>0.553000</td>
<td>...</td>
<td>157.278528</td>
<td>157.370746</td>
<td>7.888315</td>
<td>0.031005</td>
<td>7.848620</td>
<td>7.931427</td>
<td>216.0</td>
<td>314.0</td>
<td>merged_anno_0_1_4_p0_chunk_10</td>
<td>merged_anno_0_1_4_p0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>0.000570</td>
<td>0.000096</td>
<td>0.000373</td>
<td>0.000661</td>
<td>-2.185570</td>
<td>0.269905</td>
<td>-2.677673</td>
<td>-1.763470</td>
<td>19.591719</td>
<td>0.575306</td>
<td>...</td>
<td>157.302064</td>
<td>157.383235</td>
<td>7.878944</td>
<td>0.023500</td>
<td>7.848620</td>
<td>7.921558</td>
<td>240.0</td>
<td>338.0</td>
<td>merged_anno_0_1_4_p0_chunk_11</td>
<td>merged_anno_0_1_4_p0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>0.000520</td>
<td>0.000107</td>
<td>0.000373</td>
<td>0.000661</td>
<td>-1.971889</td>
<td>0.240694</td>
<td>-2.424706</td>
<td>-1.589662</td>
<td>19.105494</td>
<td>0.609702</td>
<td>...</td>
<td>157.325592</td>
<td>157.388509</td>
<td>7.893162</td>
<td>0.046331</td>
<td>7.848620</td>
<td>8.008189</td>
<td>264.0</td>
<td>362.0</td>
<td>merged_anno_0_1_4_p0_chunk_12</td>
<td>merged_anno_0_1_4_p0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>0.000524</td>
<td>0.000115</td>
<td>0.000373</td>
<td>0.000714</td>
<td>-1.779204</td>
<td>0.223516</td>
<td>-2.156786</td>
<td>-1.407064</td>
<td>18.598208</td>
<td>0.628551</td>
<td>...</td>
<td>157.351755</td>
<td>157.390481</td>
<td>7.941962</td>
<td>0.088600</td>
<td>7.848620</td>
<td>8.132930</td>
<td>288.0</td>
<td>386.0</td>
<td>merged_anno_0_1_4_p0_chunk_13</td>
<td>merged_anno_0_1_4_p0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>0.000518</td>
<td>0.000119</td>
<td>0.000373</td>
<td>0.000714</td>
<td>-1.599161</td>
<td>0.217004</td>
<td>-1.977071</td>
<td>-1.252625</td>
<td>18.074484</td>
<td>0.648964</td>
<td>...</td>
<td>157.369463</td>
<td>157.391156</td>
<td>8.024363</td>
<td>0.122492</td>
<td>7.858972</td>
<td>8.245924</td>
<td>312.0</td>
<td>410.0</td>
<td>merged_anno_0_1_4_p0_chunk_14</td>
<td>merged_anno_0_1_4_p0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>0.000479</td>
<td>0.000162</td>
<td>0.000197</td>
<td>0.000714</td>
<td>-1.426408</td>
<td>0.203184</td>
<td>-1.777833</td>
<td>-1.089737</td>
<td>17.541551</td>
<td>0.649080</td>
<td>...</td>
<td>157.382657</td>
<td>157.408323</td>
<td>8.126996</td>
<td>0.137761</td>
<td>7.915174</td>
<td>8.367000</td>
<td>336.0</td>
<td>434.0</td>
<td>merged_anno_0_1_4_p0_chunk_15</td>
<td>merged_anno_0_1_4_p0</td>
</tr>
</tbody>
</table>

<p>15 rows × 2080 columns</p>
</div>
</div>
</div>
</div>
<p>Now we are ready to train the logistic regression classifier.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-wittenburg_etal06" class="csl-entry" role="listitem">
Wittenburg, Peter, Hennie Brugman, Albert Russel, Alex Klassmann, and Han Sloetjes. 2006. <span>“<span>ELAN</span>: <span>A</span> Professional Framework for Multimodality Research.”</span> <em>Proceedings of the Fifth International Conference on Language Resources and Evaluation (LREC 2006)</em>, January.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>