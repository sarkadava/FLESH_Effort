<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.552">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Movement annotation III: Computing interrater agreement between manual and automatic annotation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../style.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
        <div class="quarto-navbar-tools tools-end">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/sarkadava/FLESH_Effort">
            Source Code
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/sarkadava/FLESH_Effort/issues">
            Report a Bug
            </a>
          </li>
      </ul>
    </div>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../04_TS_movementAnnotation/01_Classify_preparation.html">Time Series Annotation</a></li><li class="breadcrumb-item"><a href="../04_TS_movementAnnotation/03_InterAgreement.html">Movement annotation III: Computing interrater agreement between manual and automatic annotation</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../method.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview of Methods</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Processing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_XDF_processing/xdf_workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pre-Processing I: from XDF to raw files</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_MotionTracking_processing/01_Video_preparation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Motion tracking I: Preparation of videos</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_MotionTracking_processing/02_Track_OpenPose.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Motion tracking II: 2D pose estimation via OpenPose</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_MotionTracking_processing/03_Track_pose2sim.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Motion tracking III: Triangulation via Pose2sim</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_MotionTracking_processing/04_Track_InverseKinDyn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Motion tracking IV: Modeling inverse kinematics and dynamics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_TS_processing/01_TS_processing_motion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Processing I: Motion tracking and balance</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_TS_processing/02_TS_processing_acoustics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Processing II: Acoustics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_TS_processing/03_TS_merging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Processing III: Merging multimodal data</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Time Series Annotation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_TS_movementAnnotation/01_Classify_preparation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Movement annotation I: Preparing training data and data for classifier</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_TS_movementAnnotation/02_MovementClassifier.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Movement annotation II: Training movement classifier, and annotating timeseries data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_TS_movementAnnotation/03_InterAgreement.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Movement annotation III: Computing interrater agreement between manual and automatic annotation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../05_finalMerge/TS_mergeAnnotations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Final merge</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Analysis</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../06_ConceptSimilarity/ConceptNet_similarity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Computing concept similarity using ConceptNet word embeddings</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../07_TS_featureExtraction/TS_extraction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Extraction of effort-related features</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../08_Analysis_XGBoost/01_PCA_featureDimensions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exploratory Analysis I: Using PCA to identify effort dimensions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../08_Analysis_XGBoost/02_XGBoost_effortIndicators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exploratory Analysis II: Identifying effort-related features contributing to misunderstanding resolution via XGBoost</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../09_Analysis_Modeling/Modelling_syntheticData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statistical Analysis: Modelling the Effect of Communicative Attempt (H1) and Answer Similarity (H2) on Effort</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#sec-annoia" id="toc-sec-annoia" class="nav-link active" data-scroll-target="#sec-annoia">Overview</a></li>
  <li><a href="#preprocessing-annotations" id="toc-preprocessing-annotations" class="nav-link" data-scroll-target="#preprocessing-annotations">Preprocessing annotations</a></li>
  <li><a href="#creating-txt-files-for-easydiag" id="toc-creating-txt-files-for-easydiag" class="nav-link" data-scroll-target="#creating-txt-files-for-easydiag">Creating txt files for EasyDIAG</a></li>
  <li><a href="#interrater-agreement-results" id="toc-interrater-agreement-results" class="nav-link" data-scroll-target="#interrater-agreement-results">Interrater agreement: results</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../04_TS_movementAnnotation/01_Classify_preparation.html">Time Series Annotation</a></li><li class="breadcrumb-item"><a href="../04_TS_movementAnnotation/03_InterAgreement.html">Movement annotation III: Computing interrater agreement between manual and automatic annotation</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Movement annotation III: Computing interrater agreement between manual and automatic annotation</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="sec-annoia" class="level1">
<h1>Overview</h1>
<p>In this script, we prepare data to test the interrater agreement (IA) on movement annotation. To test the robustness, we compute interrater agreement between two human annotators (AC, GR) and between each human annotator and the automatic annotations created in the <a href="../04_TS_movementAnnotation/02_MovementClassifier.html#sec-annoclass">previous script</a>. We compute IA for each tier separately.</p>
<p>We use EasyDIAG <span class="citation" data-cites="holle_rein15">(<a href="#ref-holle_rein15" role="doc-biblioref">Holle and Rein 2015</a>)</span> to compute the IA, but document the results here in the table.</p>
<div id="cell-2" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code to prepare the environment</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xml.etree.ElementTree <span class="im">as</span> ET</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>curfolder <span class="op">=</span> os.getcwd()</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we store our merged processed files</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>processedfolder <span class="op">=</span> os.path.join(curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">..</span><span class="ch">\\</span><span class="st">03_TS_processing</span><span class="ch">\\</span><span class="st">TS_merged</span><span class="ch">\\</span><span class="st">'</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>processedfiles <span class="op">=</span> glob.glob(processedfolder <span class="op">+</span> <span class="st">'*.csv'</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we store annotations from the logreg model</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>annotatedfolder <span class="op">=</span> os.path.join(curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">TS_annotated_logreg</span><span class="ch">\\</span><span class="st">'</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>folders <span class="op">=</span> glob.glob(annotatedfolder <span class="op">+</span> <span class="st">'*</span><span class="ch">\\</span><span class="st">'</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>folders60 <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> folders <span class="cf">if</span> <span class="st">'0_6'</span> <span class="kw">in</span> x] <span class="co">#60percent confidence</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>folders80 <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> folders <span class="cf">if</span> <span class="st">'0_8'</span> <span class="kw">in</span> x] <span class="co">#80percent confidence</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we store manual annotations from R1 (AC)</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>manualfolder1 <span class="op">=</span> os.path.join(curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">ManualAnno</span><span class="ch">\\</span><span class="st">R1</span><span class="ch">\\</span><span class="st">'</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>manualfiles1 <span class="op">=</span> glob.glob(manualfolder1 <span class="op">+</span> <span class="st">'*.eaf'</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>manualfiles1 <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> manualfiles1 <span class="cf">if</span> <span class="st">'ELAN_tiers'</span> <span class="kw">in</span> x]</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we store manual annotations from R2 (GR)</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>manualfolder2 <span class="op">=</span> os.path.join(curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">ManualAnno</span><span class="ch">\\</span><span class="st">R3</span><span class="ch">\\</span><span class="st">'</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>manualfiles2 <span class="op">=</span> glob.glob(manualfolder2 <span class="op">+</span> <span class="st">'*.eaf'</span>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>manualfiles2 <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> manualfiles2 <span class="cf">if</span> <span class="st">'ELAN_tiers'</span> <span class="kw">in</span> x]</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we store the txt files we need for EasyDIAG</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>interfolder <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">InterAg</span><span class="ch">\\</span><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="preprocessing-annotations" class="level1">
<h1>Preprocessing annotations</h1>
<p>Now we need to get both manual and automatic annotations into format that EasyDIAG requires - so simple .txt files with timestamps and annotation values. For annotations that have been created by human annotators, we need to extract the timestamps and values from the .eaf files.</p>
<div id="cell-4" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Custom functions</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to parse ELAN file</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_eaf_file(eaf_file, rel_tiers):</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    tree <span class="op">=</span> ET.parse(eaf_file)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    root <span class="op">=</span> tree.getroot()</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    time_order <span class="op">=</span> root.find(<span class="st">'TIME_ORDER'</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    time_slots <span class="op">=</span> {time_slot.attrib[<span class="st">'TIME_SLOT_ID'</span>]: time_slot.attrib[<span class="st">'TIME_VALUE'</span>] <span class="cf">for</span> time_slot <span class="kw">in</span> time_order}</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    annotations <span class="op">=</span> []</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    relevant_tiers <span class="op">=</span> {rel_tiers}</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> tier <span class="kw">in</span> root.findall(<span class="st">'TIER'</span>):</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        tier_id <span class="op">=</span> tier.attrib[<span class="st">'TIER_ID'</span>]</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> tier_id <span class="kw">in</span> relevant_tiers:</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> annotation <span class="kw">in</span> tier.findall(<span class="st">'ANNOTATION/ALIGNABLE_ANNOTATION'</span>):</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Ensure required attributes are present</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="st">'TIME_SLOT_REF1'</span> <span class="kw">in</span> annotation.attrib <span class="kw">and</span> <span class="st">'TIME_SLOT_REF2'</span> <span class="kw">in</span> annotation.attrib:</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>                    ts_ref1 <span class="op">=</span> annotation.attrib[<span class="st">'TIME_SLOT_REF1'</span>]</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>                    ts_ref2 <span class="op">=</span> annotation.attrib[<span class="st">'TIME_SLOT_REF2'</span>]</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Get annotation ID if it exists, otherwise set to None</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>                    ann_id <span class="op">=</span> annotation.attrib.get(<span class="st">'ANNOTATION_ID'</span>, <span class="va">None</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>                    annotation_value <span class="op">=</span> annotation.find(<span class="st">'ANNOTATION_VALUE'</span>).text.strip()</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>                    annotations.append({</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'tier_id'</span>: tier_id,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'annotation_id'</span>: ann_id,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'start_time'</span>: time_slots[ts_ref1],</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'end_time'</span>: time_slots[ts_ref2],</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'annotation_value'</span>: annotation_value</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> annotations</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to write ELAN into txt file</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ELAN_into_txt(txtfile, raterID, foi, tier):</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(txtfile, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> foi:</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'working on '</span> <span class="op">+</span> <span class="bu">file</span>)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Filename</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>            filename <span class="op">=</span> <span class="bu">file</span>.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Parse ELAN file</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>            annotations <span class="op">=</span> parse_eaf_file(<span class="bu">file</span>, tier)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write annotations into txt file</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> annotation <span class="kw">in</span> annotations:</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>                f.write(<span class="ss">f"Anno_</span><span class="sc">{</span>raterID<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>annotation[<span class="st">'start_time'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>annotation[<span class="st">'end_time'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>annotation[<span class="st">'annotation_value'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>filename<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-5" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>foi <span class="op">=</span> manualfiles2  <span class="co"># here we store manual annotations that we want to convert into txt files</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>raterIDfile <span class="op">=</span> <span class="st">'R3'</span>  <span class="co"># this is the rater as we name it in the txt files</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>raterID <span class="op">=</span> <span class="st">'R2'</span>      <span class="co"># this is the ID we need for EasyDIAG (the software always needs R1 and R2)</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># These are the files we want to create</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>txtfile_head <span class="op">=</span> interfolder <span class="op">+</span> raterIDfile <span class="op">+</span> <span class="st">'_Manual_head.txt'</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>txtfile_upper <span class="op">=</span> interfolder <span class="op">+</span> raterIDfile <span class="op">+</span> <span class="st">'_Manual_upper.txt'</span>       <span class="co"># we add _2 for files where manual annotator 1 is R1, because we also want to compare with manual annotator 2 (R3)</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>txtfile_lower <span class="op">=</span> interfolder <span class="op">+</span> raterIDfile <span class="op">+</span> <span class="st">'_Manual_lower.txt'</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>txtfile_arms <span class="op">=</span> interfolder <span class="op">+</span> raterIDfile <span class="op">+</span> <span class="st">'_Manual_arms.txt'</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># For each tier, extract the annotations from ELAN file and save them in a txt file</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>ELAN_into_txt(txtfile_head, raterID, foi, <span class="st">'head_mov'</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>ELAN_into_txt(txtfile_upper, raterID, foi, <span class="st">'upper_body'</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>ELAN_into_txt(txtfile_lower, raterID, foi, <span class="st">'lower_body'</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>ELAN_into_txt(txtfile_arms, raterID, foi, <span class="st">'arms'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is how the files look like</p>
<div id="cell-7" class="cell" data-execution_count="7">
<div class="cell-output cell-output-display" data-execution_count="7">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Anno_R1</td>
<td>0</td>
<td>3116</td>
<td>nomovement</td>
<td>0_1_11_p1_ELAN_tiers.eaf</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Anno_R1</td>
<td>0</td>
<td>3629</td>
<td>nomovement</td>
<td>0_1_12_p1_ELAN_tiers.eaf</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Anno_R1</td>
<td>0</td>
<td>3388</td>
<td>nomovement</td>
<td>0_1_13_p1_ELAN_tiers.eaf</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Anno_R1</td>
<td>0</td>
<td>5120</td>
<td>nomovement</td>
<td>0_1_14_p1_ELAN_tiers.eaf</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Anno_R1</td>
<td>0</td>
<td>3978</td>
<td>nomovement</td>
<td>0_1_15_p1_ELAN_tiers.eaf</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Anno_R1</td>
<td>1620</td>
<td>1730</td>
<td>movement</td>
<td>0_1_16_p1_ELAN_tiers.eaf</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Anno_R1</td>
<td>0</td>
<td>1620</td>
<td>nomovement</td>
<td>0_1_16_p1_ELAN_tiers.eaf</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Anno_R1</td>
<td>1730</td>
<td>3524</td>
<td>nomovement</td>
<td>0_1_16_p1_ELAN_tiers.eaf</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Anno_R1</td>
<td>1650</td>
<td>3610</td>
<td>movement</td>
<td>0_1_17_p1_ELAN_tiers.eaf</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>Anno_R1</td>
<td>0</td>
<td>1650</td>
<td>nomovement</td>
<td>0_1_17_p1_ELAN_tiers.eaf</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>Anno_R1</td>
<td>3610</td>
<td>4263</td>
<td>nomovement</td>
<td>0_1_17_p1_ELAN_tiers.eaf</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>Anno_R1</td>
<td>930</td>
<td>3450</td>
<td>movement</td>
<td>0_1_20_p0_ELAN_tiers.eaf</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>Anno_R1</td>
<td>0</td>
<td>930</td>
<td>nomovement</td>
<td>0_1_20_p0_ELAN_tiers.eaf</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>Anno_R1</td>
<td>3450</td>
<td>3881</td>
<td>nomovement</td>
<td>0_1_20_p0_ELAN_tiers.eaf</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>Anno_R1</td>
<td>0</td>
<td>3595</td>
<td>nomovement</td>
<td>0_1_21_p0_ELAN_tiers.eaf</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>For automatic annotations, we need to extract the timestamps and values from the .csv files. Before doing that, we need to handle two issues that stem from the the fact that the classifier can create flickering annotations, as the confidence values continuously vary throughout each trial.</p>
<p>Similarly to <span class="citation" data-cites="pouw_etal21b">Pouw et al. (<a href="#ref-pouw_etal21b" role="doc-biblioref">2021</a>)</span>, we apply two rules to handle this flickering:<br><br> - Rule 1: If there is a nomovement event between two movement events that is shorter than 200 ms, this is considered as part of the movement event.<br> - Rule 2: If there is a movement event between two nomovement events that is shorter than 200 ms, this is considered as part of the nomovement event.<br></p>
<p>Afterwards, we take the first movement event and the very last movement event, and consider everything in between as a movement.</p>
<div id="cell-9" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Custom functions</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get chunks of annotations</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_chunks(anno_df):</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    anno_df[<span class="st">'chunk'</span>] <span class="op">=</span> (anno_df[<span class="st">'anno_values'</span>] <span class="op">!=</span> anno_df[<span class="st">'anno_values'</span>].shift()).cumsum()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    anno_df[<span class="st">'idx'</span>] <span class="op">=</span> anno_df.index</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate start and end of each chunk, grouped by anno_values, save also the first and last index</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> anno_df.groupby([<span class="st">'anno_values'</span>, <span class="st">'chunk'</span>]).agg(</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        time_ms_min<span class="op">=</span>(<span class="st">'time_ms'</span>, <span class="st">'first'</span>),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        time_ms_max<span class="op">=</span>(<span class="st">'time_ms'</span>, <span class="st">'last'</span>),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        idx_min<span class="op">=</span>(<span class="st">'idx'</span>, <span class="st">'first'</span>),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        idx_max<span class="op">=</span>(<span class="st">'idx'</span>, <span class="st">'last'</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Order the chunks</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> chunks.sort_values(<span class="st">'idx_min'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> chunks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-10" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>foi <span class="op">=</span> folders80 <span class="co"># set which folder (threshold) you want to process</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>threshold <span class="op">=</span> <span class="st">'80'</span> <span class="co"># set the threshold</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> folder <span class="kw">in</span> foi:</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get tierID</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    tier <span class="op">=</span> folder.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">2</span>].split(<span class="st">'_'</span>)[<span class="dv">0</span>]</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tier <span class="op">==</span> <span class="st">'head'</span>:</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        tier <span class="op">=</span> <span class="st">'head'</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> tier <span class="op">==</span> <span class="st">'upperBody'</span>:</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        tier <span class="op">=</span> <span class="st">'upper'</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> tier <span class="op">==</span> <span class="st">'lowerBody'</span>:</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        tier <span class="op">=</span> <span class="st">'lower'</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is the file we want to create</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    txtfile <span class="op">=</span> interfolder <span class="op">+</span> <span class="st">'AutoAnno_'</span> <span class="op">+</span> tier <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> threshold <span class="op">+</span> <span class="st">'.txt'</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List all files in the folder</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> glob.glob(folder <span class="op">+</span> <span class="st">'*.csv'</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'processing: '</span> <span class="op">+</span> <span class="bu">file</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Filename</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> <span class="bu">file</span>.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> filename.split(<span class="st">'_'</span>)[<span class="dv">2</span>:<span class="dv">6</span>]</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> <span class="st">'_'</span>.join(filename)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if we have manual file matching to this file, otherwise skip</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        manualfile <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> manualfiles1 <span class="cf">if</span> filename <span class="kw">in</span> x]</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(manualfile) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Now we process the annotations made by the logreg model</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        anno_df <span class="op">=</span> pd.read_csv(<span class="bu">file</span>)</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Chunk the df to see unique annotated chunks</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        chunks <span class="op">=</span> get_chunks(anno_df)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for fake pauses (i.e., nomovement annotation that last for less than 200ms)</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(chunks)<span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> chunks.loc[i, <span class="st">'anno_values'</span>] <span class="op">==</span> <span class="st">'no movement'</span> <span class="kw">and</span> chunks.loc[i<span class="op">-</span><span class="dv">1</span>, <span class="st">'anno_values'</span>] <span class="op">==</span> <span class="st">'movement'</span> <span class="kw">and</span> chunks.loc[i<span class="op">+</span><span class="dv">1</span>, <span class="st">'anno_values'</span>] <span class="op">==</span> <span class="st">'movement'</span>:</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> chunks.loc[i, <span class="st">'time_ms_max'</span>] <span class="op">-</span> chunks.loc[i, <span class="st">'time_ms_min'</span>] <span class="op">&lt;</span> <span class="dv">200</span>:</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="st">'found a chunk of no movement between two movement chunks that is shorter than 200 ms'</span>)</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Change the chunk into movement</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>                    anno_df.loc[chunks.loc[i, <span class="st">'idx_min'</span>]:chunks.loc[i, <span class="st">'idx_max'</span>], <span class="st">'anno_values'</span>] <span class="op">=</span> <span class="st">'movement'</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate new chunks</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>        chunks <span class="op">=</span> get_chunks(anno_df)</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Now check for fake movement (i.e., movement chunk that is shorter than 200ms)</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(chunks)<span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> chunks.loc[i, <span class="st">'anno_values'</span>] <span class="op">==</span> <span class="st">'movement'</span> <span class="kw">and</span> chunks.loc[i<span class="op">-</span><span class="dv">1</span>, <span class="st">'anno_values'</span>] <span class="op">==</span> <span class="st">'no movement'</span> <span class="kw">and</span> chunks.loc[i<span class="op">+</span><span class="dv">1</span>, <span class="st">'anno_values'</span>] <span class="op">==</span> <span class="st">'no movement'</span>:</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> chunks.loc[i, <span class="st">'time_ms_max'</span>] <span class="op">-</span> chunks.loc[i, <span class="st">'time_ms_min'</span>] <span class="op">&lt;</span> <span class="dv">200</span>:</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="st">'found a chunk of movement between two no movement chunks that is shorter than 250 ms'</span>)</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># change the chunk to no movement in the original df</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>                    anno_df.loc[chunks.loc[i, <span class="st">'idx_min'</span>]:chunks.loc[i, <span class="st">'idx_max'</span>], <span class="st">'anno_values'</span>] <span class="op">=</span> <span class="st">'no movement'</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Now, similarly to our human annotators, we consider movement anything from the very first movement to the very last movement</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'movement'</span> <span class="kw">in</span> anno_df[<span class="st">'anno_values'</span>].unique():</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get the first and last index of movement</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>            first_idx <span class="op">=</span> anno_df[anno_df[<span class="st">'anno_values'</span>] <span class="op">==</span> <span class="st">'movement'</span>].index[<span class="dv">0</span>]</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>            last_idx <span class="op">=</span> anno_df[anno_df[<span class="st">'anno_values'</span>] <span class="op">==</span> <span class="st">'movement'</span>].index[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Change all between to movement</span></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>            anno_df.loc[first_idx:last_idx, <span class="st">'anno_values'</span>] <span class="op">=</span> <span class="st">'movement'</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate new chunks</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>        chunks <span class="op">=</span> get_chunks(anno_df)</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rewrite "no movement" in anno_values to "nomovement" (to match the manual annotations)</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>        chunks[<span class="st">'anno_values'</span>] <span class="op">=</span> chunks[<span class="st">'anno_values'</span>].<span class="bu">apply</span>(</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: <span class="st">'nomovement'</span> <span class="cf">if</span> x <span class="op">==</span> <span class="st">'no movement'</span> <span class="cf">else</span> x</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add elanID to chunks (to match the manual annotations in EasyDIAG)</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>        chunks[<span class="st">'elanID'</span>]  <span class="op">=</span> <span class="bu">str</span>(filename <span class="op">+</span> <span class="st">'_ELAN_tiers.eaf'</span>)</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Write to the text file</span></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(txtfile, <span class="st">'a'</span>) <span class="im">as</span> f:</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _, row <span class="kw">in</span> chunks.iterrows():</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>                f.write(</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"Anno_R1</span><span class="ch">\t</span><span class="sc">{</span>row[<span class="st">'time_ms_min'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>row[<span class="st">'time_ms_max'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>row[<span class="st">'anno_values'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>row[<span class="st">'elanID'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>                )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="creating-txt-files-for-easydiag" class="level1">
<h1>Creating txt files for EasyDIAG</h1>
<p>EasyDIAG requires a txt file that contains all annotations of a tier from both annotators we wish to compare. We therefore need to merge the files we have created above into one file for each tier.</p>
<p>(Note that it is better to delete old files rather than let them overwrite because that can lead to some bugs in the files for which the agreement will be messy)</p>
<div id="cell-13" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># eval: false</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># These tiers we want to compare</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>toi <span class="op">=</span> [<span class="st">'arms'</span>, <span class="st">'head'</span>, <span class="st">'upper'</span>, <span class="st">'lower'</span>] </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># We want to compare</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">## auto60 with R1  </span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">## auto80 with R1 </span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">## auto60 with R3  </span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">## auto80 with R3 </span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co"># r1_2 with r3</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># For us R1 is the manual annotator, R3 is second manual annotator, R2 is the automatic annotator</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co"># But note that manual annotator is in the txt files always as R2, and automatic annotator is always R1 </span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>comp1 <span class="op">=</span> <span class="st">'R3'</span>    <span class="co"># change here who you want to compare</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>comp2 <span class="op">=</span> <span class="st">'R1'</span>    <span class="co"># with whom</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Add adding if necessary</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>adding <span class="op">=</span> <span class="st">'manual'</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> tier <span class="kw">in</span> toi:</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'working on '</span> <span class="op">+</span> tier)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    txtfile_auto60 <span class="op">=</span> interfolder <span class="op">+</span> <span class="st">'AutoAnno_'</span> <span class="op">+</span> tier <span class="op">+</span> <span class="st">'_60.txt'</span>        <span class="co"># this is the automatic annotator with threshold 60</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    txtfile_auto80 <span class="op">=</span> interfolder <span class="op">+</span> <span class="st">'AutoAnno_'</span> <span class="op">+</span> tier <span class="op">+</span> <span class="st">'_80.txt'</span>        <span class="co"># this is the automatic annotator with threshold 80</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    txtfile_manual_r1 <span class="op">=</span> interfolder <span class="op">+</span> <span class="st">'R1_Manual_'</span> <span class="op">+</span> tier <span class="op">+</span> <span class="st">'.txt'</span>  <span class="co"># this is manual annotator (AC) as R2</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    txtfile_manual_r3 <span class="op">=</span> interfolder <span class="op">+</span> <span class="st">'R3_Manual_'</span> <span class="op">+</span> tier <span class="op">+</span> <span class="st">'.txt'</span>  <span class="co"># this is manual annotator (GR) as R2</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    txtfile_manual_r1_2 <span class="op">=</span> interfolder <span class="op">+</span> <span class="st">'R1_Manual_'</span> <span class="op">+</span> tier <span class="op">+</span> <span class="st">'_2.txt'</span>  <span class="co"># this is manual annotator (AC) as R1</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read in the files we want to compare</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    r1_anno <span class="op">=</span> pd.read_csv(txtfile_manual_r3, sep<span class="op">=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, header<span class="op">=</span><span class="va">None</span>)         <span class="co"># change here who you want to compare</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    r2_anno <span class="op">=</span> pd.read_csv(txtfile_manual_r1_2, sep<span class="op">=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, header<span class="op">=</span><span class="va">None</span>)    <span class="co"># with whom</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check that both files have the same number of files (EasyDIAG will ignore this mismatch and lower the agreement)</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    files_to_check_r1 <span class="op">=</span> r1_anno[<span class="dv">4</span>].unique()</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    files_to_check_r2 <span class="op">=</span> r2_anno[<span class="dv">4</span>].unique()</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    files_to_check <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(files_to_check_r1) <span class="op">&amp;</span> <span class="bu">set</span>(files_to_check_r2))</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adapt both</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    rows_auto <span class="op">=</span> r1_anno[r1_anno[<span class="dv">4</span>].isin(files_to_check)]</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    rows_manual <span class="op">=</span> r2_anno[r2_anno[<span class="dv">4</span>].isin(files_to_check)]</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># And concatenate</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    concat_rows <span class="op">=</span> pd.concat([r1_anno, r2_anno])</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save as new file</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    txtfile_IA <span class="op">=</span> interfolder <span class="op">+</span> <span class="st">'IA_'</span> <span class="op">+</span> comp1 <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> comp2 <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> tier <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> adding <span class="op">+</span> <span class="st">'.txt'</span> <span class="co"># adapt the threshold based on what you work with</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(txtfile_IA, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> index, row <span class="kw">in</span> concat_rows.iterrows():</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>            f.write(<span class="ss">f"</span><span class="sc">{</span>row[<span class="dv">0</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>row[<span class="dv">1</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>row[<span class="dv">2</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>row[<span class="dv">3</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>row[<span class="dv">4</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="interrater-agreement-results" class="level1">
<h1>Interrater agreement: results</h1>
<p>Here we report the raw agreements together with kappa coefficients for interrater agreement between manual annotators (R1, R3) and automatic annotations (with threshold 60 and 80). Interrater agreement was computed using EasyDIAG <span class="citation" data-cites="holle_rein15">(<a href="#ref-holle_rein15" role="doc-biblioref">Holle and Rein 2015</a>)</span>, and the results have been saved in txt files. We will now extract relevant information to report in the table. The overlap was kept at default value of 60% for all tiers.</p>
<div id="cell-15" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_ia(lines):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extracting values</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    linked_units <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    raw_agreement <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    kappa <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    inside_section_2 <span class="op">=</span> <span class="va">False</span>  <span class="co"># Flag to track section 2</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> lines:</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"Percentage of linked units:"</span> <span class="kw">in</span> line:</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>            inside_section_2 <span class="op">=</span> <span class="va">False</span>  <span class="co"># Ensure we don't mistakenly extract from other parts</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">"linked"</span> <span class="kw">in</span> line <span class="kw">and</span> <span class="st">"="</span> <span class="kw">in</span> line:</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>            linked_units <span class="op">=</span> <span class="bu">float</span>(line.split(<span class="st">"="</span>)[<span class="op">-</span><span class="dv">1</span>].strip().replace(<span class="st">"%"</span>, <span class="st">""</span>))  <span class="co"># Extract linked %</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">"2) Overall agreement indicies (including no match):"</span> <span class="kw">in</span> line:</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>            inside_section_2 <span class="op">=</span> <span class="va">True</span>  <span class="co"># Activate flag when entering section 2</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> inside_section_2:</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">"Raw agreement"</span> <span class="kw">in</span> line <span class="kw">and</span> <span class="st">"="</span> <span class="kw">in</span> line:</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>                raw_agreement <span class="op">=</span> <span class="bu">float</span>(line.split(<span class="st">"="</span>)[<span class="op">-</span><span class="dv">1</span>].strip())  <span class="co"># Extract correct raw agreement</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="st">"kappa "</span> <span class="kw">in</span> line <span class="kw">and</span> <span class="st">"="</span> <span class="kw">in</span> line:</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>                kappa <span class="op">=</span> <span class="bu">float</span>(line.split(<span class="st">"="</span>)[<span class="op">-</span><span class="dv">1</span>].strip())  <span class="co"># Extract correct kappa</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="st">"3)"</span> <span class="kw">in</span> line:</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>                inside_section_2 <span class="op">=</span> <span class="va">False</span>  <span class="co"># Stop when reaching section 3</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> linked_units, raw_agreement, kappa</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>files <span class="op">=</span> glob.glob(interfolder <span class="op">+</span> <span class="st">'*EasyDIAG*'</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>IA_df <span class="op">=</span> pd.DataFrame()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> txtfile <span class="kw">in</span> files:</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(txtfile, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        lines <span class="op">=</span> f.readlines()</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    comparison <span class="op">=</span> txtfile.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">'.'</span>)[<span class="dv">0</span>].split(<span class="st">'_'</span>)[<span class="dv">1</span>]<span class="op">+</span><span class="st">'_'</span><span class="op">+</span>txtfile.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">'_'</span>)[<span class="dv">2</span>]</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'Auto'</span> <span class="kw">in</span> txtfile:</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        tier <span class="op">=</span> txtfile.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">'.'</span>)[<span class="dv">0</span>].split(<span class="st">'_'</span>)[<span class="op">-</span><span class="dv">2</span>]<span class="op">+</span><span class="st">'_'</span><span class="op">+</span>txtfile.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">'.'</span>)[<span class="dv">0</span>].split(<span class="st">'_'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        tier <span class="op">=</span> txtfile.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">'.'</span>)[<span class="dv">0</span>].split(<span class="st">'_'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    linked_units, raw_agreement, kappa <span class="op">=</span> extract_ia(lines)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    IA_row <span class="op">=</span> pd.DataFrame({</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'comparison'</span>: comparison,</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'tier'</span>: tier,</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'linked_units'</span>: linked_units,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'raw_agreement'</span>: raw_agreement,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'kappa'</span>: kappa</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    }, index<span class="op">=</span>[<span class="dv">0</span>])</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    IA_df <span class="op">=</span> pd.concat([IA_df, IA_row])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-17" class="cell" data-execution_count="37">
<div class="cell-output cell-output-display" data-execution_count="37">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">comparison</th>
<th data-quarto-table-cell-role="th">tier</th>
<th data-quarto-table-cell-role="th">linked_units</th>
<th data-quarto-table-cell-role="th">raw_agreement</th>
<th data-quarto-table-cell-role="th">kappa</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>R1_Auto</td>
<td>arms_60</td>
<td>0.81</td>
<td>0.81</td>
<td>0.65</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>R1_Auto</td>
<td>arms_80</td>
<td>0.81</td>
<td>0.81</td>
<td>0.64</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>R1_Auto</td>
<td>head_60</td>
<td>0.60</td>
<td>0.56</td>
<td>0.32</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>R1_Auto</td>
<td>head_80</td>
<td>0.63</td>
<td>0.58</td>
<td>0.34</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>R1_Auto</td>
<td>lower_60</td>
<td>0.80</td>
<td>0.79</td>
<td>0.59</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>R1_Auto</td>
<td>lower_80</td>
<td>0.75</td>
<td>0.73</td>
<td>0.50</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>R1_Auto</td>
<td>upper_60</td>
<td>0.67</td>
<td>0.66</td>
<td>0.44</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>R1_Auto</td>
<td>upper_80</td>
<td>0.67</td>
<td>0.67</td>
<td>0.43</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>R3_Auto</td>
<td>arms_60</td>
<td>0.75</td>
<td>0.75</td>
<td>0.58</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>R3_Auto</td>
<td>arms_80</td>
<td>0.73</td>
<td>0.72</td>
<td>0.53</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>R3_Auto</td>
<td>head_60</td>
<td>0.62</td>
<td>0.60</td>
<td>0.39</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>R3_Auto</td>
<td>head_80</td>
<td>0.64</td>
<td>0.61</td>
<td>0.39</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>R3_Auto</td>
<td>lower_60</td>
<td>0.66</td>
<td>0.64</td>
<td>0.38</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>R3_Auto</td>
<td>lower_80</td>
<td>0.70</td>
<td>0.68</td>
<td>0.41</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>R3_Auto</td>
<td>upper_60</td>
<td>0.67</td>
<td>0.66</td>
<td>0.44</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>R3_Auto</td>
<td>upper_80</td>
<td>0.63</td>
<td>0.61</td>
<td>0.37</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>R1_R3</td>
<td>arms</td>
<td>0.85</td>
<td>0.84</td>
<td>0.70</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>R1_R3</td>
<td>head</td>
<td>0.67</td>
<td>0.62</td>
<td>0.38</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>R1_R3</td>
<td>lower</td>
<td>0.74</td>
<td>0.71</td>
<td>0.46</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>R1_R3</td>
<td>upper</td>
<td>0.70</td>
<td>0.68</td>
<td>0.44</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p><br> From the table, we can observe few things:<br><br> - 60% and 80% thresholds for automatic annotations are yielding similar results both in terms of raw agreement and kappa coefficient.<br> - for arms, interrater agreement between automatic annotation and manual annotator R1 results in kappa coefficient 0.65, which is considered substantial agreement <span class="citation" data-cites="landis_koch77">(<a href="#ref-landis_koch77" role="doc-biblioref">Landis and Koch 1977</a>)</span>.<br> - for upper body and lower body - the kappa signifies moderate agreement, but the same drop we can see in the interrater agreement between manual annotators.<br> - for head, we see only fair agreement both between manual annotators and between automatic annotation and manual annotators.<br></p>
<p>Generally, interrater agreement between manual annotator R1 and automatic annotation is comparable to the agreement between the two human annotators across all tiers. This suggests that the automatic annotation is a reliable tool for movement annotation, especially for arms. It seems like head is the most difficult tier to annotate, which is also reflected in the interrater agreement between manual annotators.</p>
<p>To improve its predictions for head, upper body, and lower body, and to avoid the risk of overfitting the model on a specific type of behaviour generated by individuals in dyad 0, we will extend the training data by annotating 10% of behaviour per participant per dyad before the final analysis. If kappa does not result in minimum substantial agreement (k = 0.61), we will annotate a larger portion of the data</p>
<p>In the <a href="../05_finalMerge/TS_mergeAnnotations.html#@sec-merge">next script</a>, we will work with 60% threshold to annotate all the data.</p>
</section>
<section id="references" class="level1">
<h1>References</h1>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-holle_rein15" class="csl-entry" role="listitem">
Holle, Henning, and Robert Rein. 2015. <span>“<span>EasyDIAg</span>: <span>A</span> Tool for Easy Determination of Interrater Agreement.”</span> <em>Behavior Research Methods</em> 47 (3): 837–47. <a href="https://doi.org/10.3758/s13428-014-0506-7">https://doi.org/10.3758/s13428-014-0506-7</a>.
</div>
<div id="ref-landis_koch77" class="csl-entry" role="listitem">
Landis, J. R., and G. G. Koch. 1977. <span>“The Measurement of Observer Agreement for Categorical Data.”</span> <em>Biometrics</em> 33 (1). <a href="https://pubmed.ncbi.nlm.nih.gov/843571/">https://pubmed.ncbi.nlm.nih.gov/843571/</a>.
</div>
<div id="ref-pouw_etal21b" class="csl-entry" role="listitem">
Pouw, Wim, Jan de Wit, Sara Bögels, Marlou Rasenberg, Branka Milivojevic, and Asli Ozyurek. 2021. <span>“Semantically <span>Related Gestures Move Alike</span>: <span>Towards</span> a <span>Distributional Semantics</span> of <span>Gesture Kinematics</span>.”</span> In <em>Digital <span>Human Modeling</span> and <span>Applications</span> in <span>Health</span>, <span>Safety</span>, <span>Ergonomics</span> and <span>Risk Management</span>. <span>Human Body</span>, <span>Motion</span> and <span>Behavior</span></em>, edited by Vincent G. Duffy, 269–87. Cham: Springer International Publishing. <a href="https://doi.org/10.1007/978-3-030-77817-0_20">https://doi.org/10.1007/978-3-030-77817-0_20</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>