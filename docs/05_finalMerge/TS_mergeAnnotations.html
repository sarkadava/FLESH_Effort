<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.552">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Final merge</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar docked fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../05_finalMerge/TS_mergeAnnotations.html">Final Merge</a></li><li class="breadcrumb-item"><a href="../05_finalMerge/TS_mergeAnnotations.html">Final merge</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">XDF Processing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_XDF_processing/xdf_workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pre-Processing I: from XDF to raw files</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Motion Tracking Processing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
 <span class="menu-text">01_Video_preparation.ipynb</span>
  </li>
          <li class="sidebar-item">
 <span class="menu-text">02_Track_OpenPose.ipynb</span>
  </li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_MotionTracking_processing/03_Track_pose2sim.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Motion tracking III: Triangulation via Pose2sim</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_MotionTracking_processing/04_Track_InverseKinDyn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Motion tracking IV: Modeling inverse kinematics and dynamics</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Time Series Processing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_TS_processing/01_TS_processing_motion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Processing I: Motion tracking and balance</span></a>
  </div>
</li>
          <li class="sidebar-item">
 <span class="menu-text">03_TS_processing/02_TS_processing_acoustics.html</span>
  </li>
          <li class="sidebar-item">
 <span class="menu-text">03_TS_processing/03_TS_merging.html</span>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Time Series Annotation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_TS_movementAnnotation/01_Classify_preparation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Movement annotation I: Preparing training data and data for classifier</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_TS_movementAnnotation/02_MovementClassifier.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Movement annotation II: Training movement classifier, and annotating timeseries data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_TS_movementAnnotation/03_InterAgreement.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Movement annotation III: Computing interrater agreement between manual and automatic annotation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Final Merge</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../05_finalMerge/TS_mergeAnnotations.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Final merge</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Concept Similarity</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../06_ConceptSimilarity/ConceptNet_similarity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Computing concept similarity using ConceptNet word embeddings</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">Feature Extraction</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../07_TS_featureExtraction/TS_extraction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Extraction of effort-related features</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true">
 <span class="menu-text">Analysis: XGBoost</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../08_Analysis_XGBoost/01_PCA_featureDimensions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exploratory Analysis I: Using PCA to identify effort dimensions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../08_Analysis_XGBoost/02_XGBoost_effortIndicators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exploratory Analysis II: Identifying effort-related features contributing to misunderstanding resolution</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true">
 <span class="menu-text">Analysis: Modeling</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../09_Analysis_Modeling/Modelling_syntheticData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Statistical Analysis: Modelling the Effect of Communicative Attempt (H1) and Answer Similarity (H2) on Effort</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Summary</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../05_finalMerge/TS_mergeAnnotations.html">Final Merge</a></li><li class="breadcrumb-item"><a href="../05_finalMerge/TS_mergeAnnotations.html">Final merge</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Final merge</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="sec-merge" class="level1">
<h1>Overview</h1>
<p>In this notebook, we will merge all the data we have been preparing so far, i.e., timeseries data for acoustics and motion (see <strong>?@sec-procmerge</strong>), and annotations we have been working with in the previous notebook (<strong>?@sec-annoclass</strong>).</p>
<p>We will also add annotations of sounding/silence created in Praat (<span class="citation" data-cites="boersma_weenink25">Boersma and Weenink (<a href="#ref-boersma_weenink25" role="doc-biblioref">2025</a>)</span>).</p>
<div id="cell-2" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code to prepare the environment</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xml.etree.ElementTree <span class="im">as</span> ET</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>curfolder <span class="op">=</span> os.getcwd()</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we store the merged timeseries data</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>mergedfolder <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">..</span><span class="ch">\\</span><span class="st">03_TS_processing</span><span class="ch">\\</span><span class="st">TS_merged</span><span class="ch">\\</span><span class="st">'</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>mergedfiles <span class="op">=</span> glob.glob(mergedfolder <span class="op">+</span> <span class="st">'/merged*.csv'</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>mergedfiles <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> mergedfiles <span class="cf">if</span> <span class="st">'anno'</span> <span class="kw">not</span> <span class="kw">in</span> x]</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we store the predicted motion annotations</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>annofolder <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">..</span><span class="ch">\\</span><span class="st">04_TS_movementAnnotation</span><span class="ch">\\</span><span class="st">TS_annotated_logreg</span><span class="ch">\\</span><span class="st">'</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>annofolders <span class="op">=</span> glob.glob(annofolder <span class="op">+</span> <span class="st">'*0_6</span><span class="ch">\\</span><span class="st">'</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we store the annotations of vocalizations (from AC)</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>vocannofolder <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">..</span><span class="ch">\\</span><span class="st">04_TS_movementAnnotation</span><span class="ch">\\</span><span class="st">ManualAnno</span><span class="ch">\\</span><span class="st">R1</span><span class="ch">\\</span><span class="st">'</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>vocfiles <span class="op">=</span> glob.glob(vocannofolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">*ELAN_tiers.eaf'</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create folder for the txt annotations</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">Annotations_txt'</span>):</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    os.makedirs(curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">Annotations_txt'</span>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>txtannofolder <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">Annotations_txt</span><span class="ch">\\</span><span class="st">'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="getting-vocalization-annotations-from-elan-file" class="level1">
<h1>Getting vocalization annotations from ELAN file</h1>
<p>We have used Praat to annotate the sounding/silence in the trials and loaded it to ELAN file with the remaining annotations of movement to save all in a single file. Now we want to get the annotations of sounding/silence from the ELAN file and merge it with the rest of the data.</p>
<p>(Note that we are working on automatic annotator of speech that would allow to get the annotations of sounding/silence without the need for external software, similar to our movement annotation pipeline introduced in <strong>?@sec-annoclass</strong>.)</p>
<div id="cell-4" class="cell">
<details class="code-fold">
<summary>Custom functions</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to parse ELAN annotation</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_eaf_file(eaf_file, rel_tiers):</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    tree <span class="op">=</span> ET.parse(eaf_file)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    root <span class="op">=</span> tree.getroot()</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    time_order <span class="op">=</span> root.find(<span class="st">'TIME_ORDER'</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    time_slots <span class="op">=</span> {time_slot.attrib[<span class="st">'TIME_SLOT_ID'</span>]: time_slot.attrib[<span class="st">'TIME_VALUE'</span>] <span class="cf">for</span> time_slot <span class="kw">in</span> time_order}</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    annotations <span class="op">=</span> []</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    relevant_tiers <span class="op">=</span> {rel_tiers}</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> tier <span class="kw">in</span> root.findall(<span class="st">'TIER'</span>):</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        tier_id <span class="op">=</span> tier.attrib[<span class="st">'TIER_ID'</span>]</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> tier_id <span class="kw">in</span> relevant_tiers:</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> annotation <span class="kw">in</span> tier.findall(<span class="st">'ANNOTATION/ALIGNABLE_ANNOTATION'</span>):</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Ensure required attributes are present</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="st">'TIME_SLOT_REF1'</span> <span class="kw">in</span> annotation.attrib <span class="kw">and</span> <span class="st">'TIME_SLOT_REF2'</span> <span class="kw">in</span> annotation.attrib:</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>                    ts_ref1 <span class="op">=</span> annotation.attrib[<span class="st">'TIME_SLOT_REF1'</span>]</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>                    ts_ref2 <span class="op">=</span> annotation.attrib[<span class="st">'TIME_SLOT_REF2'</span>]</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Get annotation ID if it exists, otherwise set to None</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>                    ann_id <span class="op">=</span> annotation.attrib.get(<span class="st">'ANNOTATION_ID'</span>, <span class="va">None</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>                    annotation_value <span class="op">=</span> annotation.find(<span class="st">'ANNOTATION_VALUE'</span>).text.strip()</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>                    annotations.append({</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'tier_id'</span>: tier_id,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'annotation_id'</span>: ann_id,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'start_time'</span>: time_slots[ts_ref1],</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'end_time'</span>: time_slots[ts_ref2],</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'annotation_value'</span>: annotation_value</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> annotations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-5" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we store the vocalization annotations</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>vocal_anno <span class="op">=</span> txtannofolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">vocalization_annotations.txt'</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(vocal_anno, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> vocfiles:</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'working on '</span> <span class="op">+</span> <span class="bu">file</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Filename</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> <span class="bu">file</span>.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> filename.replace(<span class="st">'_ELAN_tiers.eaf'</span>, <span class="st">''</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parse the ELAN file</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        annotations <span class="op">=</span> parse_eaf_file(<span class="bu">file</span>, <span class="st">'vocalization'</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save it to the file</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> annotation <span class="kw">in</span> annotations:</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>            f.write(<span class="ss">f"</span><span class="sc">{</span>annotation[<span class="st">'start_time'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>annotation[<span class="st">'end_time'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>annotation[<span class="st">'annotation_value'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>filename<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="preparing-movement-annotations" class="level1">
<h1>Preparing movement annotations</h1>
<p>Similarly, we also want to get ready our movement annotations to simple txt file. We store all the predicted annotations separately per tier and per trial, so now we merge all the files into a single txt file, per each tier separately.</p>
<p>As already mentioned in previous script (<strong>?@sec-annoia</strong>), we need to handle two issues that stem from the the fact that the classifier can create flickering annotations, as the confidence values continuously vary throughout each trial.</p>
<p>Similarly to <span class="citation" data-cites="pouw_etal21b">Pouw et al. (<a href="#ref-pouw_etal21b" role="doc-biblioref">2021</a>)</span>, we apply two rules to handle this flickering: - Rule 1: If there is a nomovement event between two movement events that is shorter than 200 ms, this is considered as part of the movement event. - Rule 2: If there is a movement event between two nomovement events that is shorter than 200 ms, this is considered as part of the nomovement event.</p>
<p>Afterwards, we take the first movement event and the very last movement event, and consider everything in between as a movement.</p>
<p>Then we write the final movement annotations to a txt file.</p>
<div id="cell-7" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Custom functions</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get chunks of annotations</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_chunks(anno_df):</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    anno_df[<span class="st">'chunk'</span>] <span class="op">=</span> (anno_df[<span class="st">'anno_values'</span>] <span class="op">!=</span> anno_df[<span class="st">'anno_values'</span>].shift()).cumsum()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    anno_df[<span class="st">'idx'</span>] <span class="op">=</span> anno_df.index</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate start and end of each chunk, grouped by anno_values, save also the first and last index</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> anno_df.groupby([<span class="st">'anno_values'</span>, <span class="st">'chunk'</span>]).agg(</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        time_ms_min<span class="op">=</span>(<span class="st">'time_ms'</span>, <span class="st">'first'</span>),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        time_ms_max<span class="op">=</span>(<span class="st">'time_ms'</span>, <span class="st">'last'</span>),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        idx_min<span class="op">=</span>(<span class="st">'idx'</span>, <span class="st">'first'</span>),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        idx_max<span class="op">=</span>(<span class="st">'idx'</span>, <span class="st">'last'</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Order the chunks</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> chunks.sort_values(<span class="st">'idx_min'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> chunks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-8" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> folder <span class="kw">in</span> annofolders:</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get tierID</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    tier <span class="op">=</span> folder.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">2</span>].split(<span class="st">'_'</span>)[<span class="dv">0</span>]</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> tier <span class="op">==</span> <span class="st">'head'</span>:</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        tier <span class="op">=</span> <span class="st">'head'</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> tier <span class="op">==</span> <span class="st">'upperBody'</span>:</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        tier <span class="op">=</span> <span class="st">'upper'</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> tier <span class="op">==</span> <span class="st">'lowerBody'</span>:</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        tier <span class="op">=</span> <span class="st">'lower'</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is the file we want to create</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    txtfile <span class="op">=</span> txtannofolder <span class="op">+</span> <span class="st">'movement_'</span> <span class="op">+</span> tier <span class="op">+</span> <span class="st">'.txt'</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List all files in the folder</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> glob.glob(folder <span class="op">+</span> <span class="st">'*.csv'</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'processing: '</span> <span class="op">+</span> <span class="bu">file</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Filename</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> <span class="bu">file</span>.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> filename.split(<span class="st">'_'</span>)[<span class="dv">2</span>:<span class="dv">6</span>]</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        filename <span class="op">=</span> <span class="st">'_'</span>.join(filename)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Now we process the annotations made by the logreg model</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        anno_df <span class="op">=</span> pd.read_csv(<span class="bu">file</span>)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Chunk the df to see unique annotated chunks</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        chunks <span class="op">=</span> get_chunks(anno_df)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for fake pauses (i.e., nomovement annotation that last for less than 200ms)</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(chunks)<span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> chunks.loc[i, <span class="st">'anno_values'</span>] <span class="op">==</span> <span class="st">'no movement'</span> <span class="kw">and</span> chunks.loc[i<span class="op">-</span><span class="dv">1</span>, <span class="st">'anno_values'</span>] <span class="op">==</span> <span class="st">'movement'</span> <span class="kw">and</span> chunks.loc[i<span class="op">+</span><span class="dv">1</span>, <span class="st">'anno_values'</span>] <span class="op">==</span> <span class="st">'movement'</span>:</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> chunks.loc[i, <span class="st">'time_ms_max'</span>] <span class="op">-</span> chunks.loc[i, <span class="st">'time_ms_min'</span>] <span class="op">&lt;</span> <span class="dv">200</span>:</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="st">'found a chunk of no movement between two movement chunks that is shorter than 200 ms'</span>)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Change the chunk into movement</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>                    anno_df.loc[chunks.loc[i, <span class="st">'idx_min'</span>]:chunks.loc[i, <span class="st">'idx_max'</span>], <span class="st">'anno_values'</span>] <span class="op">=</span> <span class="st">'movement'</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate new chunks</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>        chunks <span class="op">=</span> get_chunks(anno_df)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Now check for fake movement (i.e., movement chunk that is shorter than 200ms)</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(chunks)<span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> chunks.loc[i, <span class="st">'anno_values'</span>] <span class="op">==</span> <span class="st">'movement'</span> <span class="kw">and</span> chunks.loc[i<span class="op">-</span><span class="dv">1</span>, <span class="st">'anno_values'</span>] <span class="op">==</span> <span class="st">'no movement'</span> <span class="kw">and</span> chunks.loc[i<span class="op">+</span><span class="dv">1</span>, <span class="st">'anno_values'</span>] <span class="op">==</span> <span class="st">'no movement'</span>:</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> chunks.loc[i, <span class="st">'time_ms_max'</span>] <span class="op">-</span> chunks.loc[i, <span class="st">'time_ms_min'</span>] <span class="op">&lt;</span> <span class="dv">200</span>:</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="st">'found a chunk of movement between two no movement chunks that is shorter than 250 ms'</span>)</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># change the chunk to no movement in the original df</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>                    anno_df.loc[chunks.loc[i, <span class="st">'idx_min'</span>]:chunks.loc[i, <span class="st">'idx_max'</span>], <span class="st">'anno_values'</span>] <span class="op">=</span> <span class="st">'no movement'</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Now, similarly to our human annotators, we consider movement anything from the very first movement to the very last movement</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'movement'</span> <span class="kw">in</span> anno_df[<span class="st">'anno_values'</span>].unique():</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get the first and last index of movement</span></span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>            first_idx <span class="op">=</span> anno_df[anno_df[<span class="st">'anno_values'</span>] <span class="op">==</span> <span class="st">'movement'</span>].index[<span class="dv">0</span>]</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>            last_idx <span class="op">=</span> anno_df[anno_df[<span class="st">'anno_values'</span>] <span class="op">==</span> <span class="st">'movement'</span>].index[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Change all between to movement</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>            anno_df.loc[first_idx:last_idx, <span class="st">'anno_values'</span>] <span class="op">=</span> <span class="st">'movement'</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate new chunks</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>        chunks <span class="op">=</span> get_chunks(anno_df)</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rewrite "no movement" in anno_values to "nomovement" (to match the manual annotations)</span></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>        chunks[<span class="st">'anno_values'</span>] <span class="op">=</span> chunks[<span class="st">'anno_values'</span>].<span class="bu">apply</span>(</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: <span class="st">'nomovement'</span> <span class="cf">if</span> x <span class="op">==</span> <span class="st">'no movement'</span> <span class="cf">else</span> x</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># TrialID</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>        chunks[<span class="st">'TrialID'</span>]  <span class="op">=</span> <span class="bu">str</span>(filename)</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Write to the text file</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(txtfile, <span class="st">'a'</span>) <span class="im">as</span> f:</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _, row <span class="kw">in</span> chunks.iterrows():</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>                f.write(</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"</span><span class="sc">{</span>row[<span class="st">'time_ms_min'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>row[<span class="st">'time_ms_max'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>row[<span class="st">'anno_values'</span>]<span class="sc">}</span><span class="ch">\t</span><span class="sc">{</span>row[<span class="st">'TrialID'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>                </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="final-merge" class="level1">
<h1>Final merge</h1>
<p>Now we take the merged timeseries with acoustic and movement data, and add columns for vocalization annotations and movement annotations. We will also add tier for general movement, concatenating the movement annotations from all tiers to see when a movement (of any articulator) starts and when it ends.</p>
<p>Finally, we save the merged data to a single csv file per each trial</p>
<div id="cell-10" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Custom functions</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to load annotations from txt file to timeseries</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> anno_to_df(df, anno, anno_col):</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> anno.iterrows():</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> row[<span class="dv">1</span>][<span class="dv">0</span>]</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        end <span class="op">=</span> row[<span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        value <span class="op">=</span> <span class="bu">str</span>(row[<span class="dv">1</span>][<span class="dv">2</span>])</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        df.loc[(df[<span class="st">'time'</span>] <span class="op">&gt;=</span> start) <span class="op">&amp;</span> (df[<span class="st">'time'</span>] <span class="op">&lt;=</span> end), anno_col] <span class="op">=</span> value</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-11" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we will store the merged timeseries with annotations</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>TSfinal <span class="op">=</span> curfolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">TS_final</span><span class="ch">\\</span><span class="st">'</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we store the annotations of vocalizations (from AC)</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>voc_anno <span class="op">=</span> txtannofolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">vocalization_annotations.txt'</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we store the annotations of the movement</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>head_anno <span class="op">=</span> txtannofolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">movement_head.txt'</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>upper_anno <span class="op">=</span> txtannofolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">movement_upper.txt'</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>lower_anno <span class="op">=</span> txtannofolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">movement_lower.txt'</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>arms_anno <span class="op">=</span> txtannofolder <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">movement_arms.txt'</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the annotatins</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>voc_df <span class="op">=</span> pd.read_csv(voc_anno, sep<span class="op">=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>head_df <span class="op">=</span> pd.read_csv(head_anno, sep<span class="op">=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>upper_df <span class="op">=</span> pd.read_csv(upper_anno, sep<span class="op">=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>lower_df <span class="op">=</span> pd.read_csv(lower_anno, sep<span class="op">=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>arms_df <span class="op">=</span> pd.read_csv(arms_anno, sep<span class="op">=</span><span class="st">'</span><span class="ch">\t</span><span class="st">'</span>, header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> mergedfiles:</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'working on '</span> <span class="op">+</span> <span class="bu">file</span>)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TrialID</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    trialid <span class="op">=</span> <span class="bu">file</span>.split(<span class="st">'</span><span class="ch">\\</span><span class="st">'</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">'.'</span>)[<span class="dv">0</span>]</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    trialid <span class="op">=</span> trialid.replace(<span class="st">'merged_'</span>, <span class="st">''</span>)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the file</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> pd.read_csv(<span class="bu">file</span>)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the annotations for this trialID</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    voc_anno_trial <span class="op">=</span> voc_df[voc_df[<span class="dv">3</span>] <span class="op">==</span> trialid]</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(voc_anno_trial)</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    head_anno_trial <span class="op">=</span> head_df[head_df[<span class="dv">3</span>] <span class="op">==</span> trialid]</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    upper_anno_trial <span class="op">=</span> upper_df[upper_df[<span class="dv">3</span>] <span class="op">==</span> trialid]</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    lower_anno_trial <span class="op">=</span> lower_df[lower_df[<span class="dv">3</span>] <span class="op">==</span> trialid]</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    arms_anno_trial <span class="op">=</span> arms_df[arms_df[<span class="dv">3</span>] <span class="op">==</span> trialid]</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare error log</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    error_log <span class="op">=</span> []</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If any of the annotations is empty, we skip this trial and save a message - these should be practice trials in our case</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">any</span>([voc_anno_trial.empty, head_anno_trial.empty, upper_anno_trial.empty, lower_anno_trial.empty, arms_anno_trial.empty]):</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'no annotations for '</span> <span class="op">+</span> trialid)</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>        error_log.append(<span class="st">'no annotations for '</span> <span class="op">+</span> trialid)</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'vocalization'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>        anno_to_df(merged, voc_anno_trial, <span class="st">'vocalization'</span>)</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'head_mov'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>        anno_to_df(merged, head_anno_trial, <span class="st">'head_mov'</span>)</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'upper_mov'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>        anno_to_df(merged, upper_anno_trial, <span class="st">'upper_mov'</span>)</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'lower_mov'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>        anno_to_df(merged, lower_anno_trial, <span class="st">'lower_mov'</span>)</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'arms_mov'</span>] <span class="op">=</span> <span class="st">''</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>        anno_to_df(merged, arms_anno_trial, <span class="st">'arms_mov'</span>)</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Also create a column 'movement_in_trial' that combines all movement annotations</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'movement_in_trial'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through rows and if any of the movement columns is 'movement', then fill the movement_in_trial column with 'movement'</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>        first_movement <span class="op">=</span> merged[(merged[<span class="st">'head_mov'</span>] <span class="op">==</span> <span class="st">'movement'</span>) <span class="op">|</span> (merged[<span class="st">'upper_mov'</span>] <span class="op">==</span> <span class="st">'movement'</span>) <span class="op">|</span> (merged[<span class="st">'lower_mov'</span>] <span class="op">==</span> <span class="st">'movement'</span>) <span class="op">|</span> (merged[<span class="st">'arms_mov'</span>] <span class="op">==</span> <span class="st">'movement'</span>)].index[<span class="dv">0</span>]</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>        last_movement <span class="op">=</span> merged[(merged[<span class="st">'head_mov'</span>] <span class="op">==</span> <span class="st">'movement'</span>) <span class="op">|</span> (merged[<span class="st">'upper_mov'</span>] <span class="op">==</span> <span class="st">'movement'</span>) <span class="op">|</span> (merged[<span class="st">'lower_mov'</span>] <span class="op">==</span> <span class="st">'movement'</span>) <span class="op">|</span> (merged[<span class="st">'arms_mov'</span>] <span class="op">==</span> <span class="st">'movement'</span>)].index[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">IndexError</span>:</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'no movement annotations for '</span> <span class="op">+</span> trialid)</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># fill the movement_in_trial column with 'nomovement'</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'movement_in_trial'</span>] <span class="op">=</span> <span class="st">'nomovement'</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fill the movement_in_trial column</span></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>    merged.loc[first_movement:last_movement, <span class="st">'movement_in_trial'</span>] <span class="op">=</span> <span class="st">'movement'</span></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fill the rest with 'nomovement'</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'movement_in_trial'</span>] <span class="op">=</span> merged[<span class="st">'movement_in_trial'</span>].fillna(<span class="st">'nomovement'</span>)</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the merged file</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>    merged.to_csv(TSfinal <span class="op">+</span> <span class="st">'/merged_anno_'</span> <span class="op">+</span> trialid <span class="op">+</span> <span class="st">'.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the error log</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(TSfinal <span class="op">+</span> <span class="st">'</span><span class="ch">\\</span><span class="st">error_log.txt'</span>, <span class="st">'a'</span>) <span class="im">as</span> f:</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> line <span class="kw">in</span> error_log:</span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>            f.write(line <span class="op">+</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is how our final multimodal dataset with annotation looks like for a single trial.</p>
<div id="cell-13" class="cell" data-execution_count="8">
<div class="cell-output cell-output-display" data-execution_count="8">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">time</th>
<th data-quarto-table-cell-role="th">left_back</th>
<th data-quarto-table-cell-role="th">right_forward</th>
<th data-quarto-table-cell-role="th">right_back</th>
<th data-quarto-table-cell-role="th">left_forward</th>
<th data-quarto-table-cell-role="th">COPXc</th>
<th data-quarto-table-cell-role="th">COPYc</th>
<th data-quarto-table-cell-role="th">COPc</th>
<th data-quarto-table-cell-role="th">TrialID</th>
<th data-quarto-table-cell-role="th">FileInfo</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">lowerbody_power</th>
<th data-quarto-table-cell-role="th">leg_power</th>
<th data-quarto-table-cell-role="th">head_power</th>
<th data-quarto-table-cell-role="th">arm_power</th>
<th data-quarto-table-cell-role="th">vocalization</th>
<th data-quarto-table-cell-role="th">head_mov</th>
<th data-quarto-table-cell-role="th">upper_mov</th>
<th data-quarto-table-cell-role="th">lower_mov</th>
<th data-quarto-table-cell-role="th">arms_mov</th>
<th data-quarto-table-cell-role="th">movement_in_trial</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.0</td>
<td>1.086809</td>
<td>0.830746</td>
<td>1.491993</td>
<td>1.384194</td>
<td>0.000019</td>
<td>-0.000184</td>
<td>0.000185</td>
<td>0_2_103_p1</td>
<td>p1_zout_geluiden_c1</td>
<td>...</td>
<td>23.657219</td>
<td>4.718786</td>
<td>2.372685</td>
<td>19.838907</td>
<td>silent</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2.0</td>
<td>1.087116</td>
<td>0.830946</td>
<td>1.492349</td>
<td>1.384381</td>
<td>0.000043</td>
<td>-0.000173</td>
<td>0.000178</td>
<td>0_2_103_p1</td>
<td>p1_zout_geluiden_c1</td>
<td>...</td>
<td>23.701134</td>
<td>4.724236</td>
<td>2.376751</td>
<td>19.895821</td>
<td>silent</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>4.0</td>
<td>1.087440</td>
<td>0.831186</td>
<td>1.492731</td>
<td>1.384605</td>
<td>0.000065</td>
<td>-0.000165</td>
<td>0.000178</td>
<td>0_2_103_p1</td>
<td>p1_zout_geluiden_c1</td>
<td>...</td>
<td>23.745049</td>
<td>4.729686</td>
<td>2.380816</td>
<td>19.952735</td>
<td>silent</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>6.0</td>
<td>1.087778</td>
<td>0.831459</td>
<td>1.493137</td>
<td>1.384858</td>
<td>0.000085</td>
<td>-0.000160</td>
<td>0.000181</td>
<td>0_2_103_p1</td>
<td>p1_zout_geluiden_c1</td>
<td>...</td>
<td>23.788964</td>
<td>4.735136</td>
<td>2.384881</td>
<td>20.009650</td>
<td>silent</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>8.0</td>
<td>1.088125</td>
<td>0.831761</td>
<td>1.493562</td>
<td>1.385137</td>
<td>0.000102</td>
<td>-0.000157</td>
<td>0.000188</td>
<td>0_2_103_p1</td>
<td>p1_zout_geluiden_c1</td>
<td>...</td>
<td>23.832878</td>
<td>4.740586</td>
<td>2.388947</td>
<td>20.066564</td>
<td>silent</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>10.0</td>
<td>1.088481</td>
<td>0.832086</td>
<td>1.494006</td>
<td>1.385435</td>
<td>0.000118</td>
<td>-0.000156</td>
<td>0.000196</td>
<td>0_2_103_p1</td>
<td>p1_zout_geluiden_c1</td>
<td>...</td>
<td>23.876793</td>
<td>4.746036</td>
<td>2.393012</td>
<td>20.123478</td>
<td>silent</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>12.0</td>
<td>1.088841</td>
<td>0.832430</td>
<td>1.494464</td>
<td>1.385748</td>
<td>0.000132</td>
<td>-0.000156</td>
<td>0.000204</td>
<td>0_2_103_p1</td>
<td>p1_zout_geluiden_c1</td>
<td>...</td>
<td>23.920708</td>
<td>4.751486</td>
<td>2.397077</td>
<td>20.180392</td>
<td>silent</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>14.0</td>
<td>1.089204</td>
<td>0.832789</td>
<td>1.494934</td>
<td>1.386073</td>
<td>0.000145</td>
<td>-0.000156</td>
<td>0.000213</td>
<td>0_2_103_p1</td>
<td>p1_zout_geluiden_c1</td>
<td>...</td>
<td>23.964623</td>
<td>4.756936</td>
<td>2.401143</td>
<td>20.237306</td>
<td>silent</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>16.0</td>
<td>1.089568</td>
<td>0.833159</td>
<td>1.495415</td>
<td>1.386406</td>
<td>0.000157</td>
<td>-0.000156</td>
<td>0.000222</td>
<td>0_2_103_p1</td>
<td>p1_zout_geluiden_c1</td>
<td>...</td>
<td>24.008538</td>
<td>4.762386</td>
<td>2.405208</td>
<td>20.294220</td>
<td>silent</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>18.0</td>
<td>1.089931</td>
<td>0.833538</td>
<td>1.495903</td>
<td>1.386744</td>
<td>0.000169</td>
<td>-0.000156</td>
<td>0.000230</td>
<td>0_2_103_p1</td>
<td>p1_zout_geluiden_c1</td>
<td>...</td>
<td>24.052452</td>
<td>4.767836</td>
<td>2.409273</td>
<td>20.351134</td>
<td>silent</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>20.0</td>
<td>1.090291</td>
<td>0.833922</td>
<td>1.496398</td>
<td>1.387084</td>
<td>0.000179</td>
<td>-0.000156</td>
<td>0.000238</td>
<td>0_2_103_p1</td>
<td>p1_zout_geluiden_c1</td>
<td>...</td>
<td>24.096367</td>
<td>4.773286</td>
<td>2.413339</td>
<td>20.408049</td>
<td>silent</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>22.0</td>
<td>1.090647</td>
<td>0.834309</td>
<td>1.496896</td>
<td>1.387423</td>
<td>0.000189</td>
<td>-0.000155</td>
<td>0.000245</td>
<td>0_2_103_p1</td>
<td>p1_zout_geluiden_c1</td>
<td>...</td>
<td>24.140282</td>
<td>4.778736</td>
<td>2.417404</td>
<td>20.464963</td>
<td>silent</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>24.0</td>
<td>1.090998</td>
<td>0.834698</td>
<td>1.497396</td>
<td>1.387761</td>
<td>0.000199</td>
<td>-0.000153</td>
<td>0.000251</td>
<td>0_2_103_p1</td>
<td>p1_zout_geluiden_c1</td>
<td>...</td>
<td>24.184197</td>
<td>4.784186</td>
<td>2.421469</td>
<td>20.521877</td>
<td>silent</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>26.0</td>
<td>1.091343</td>
<td>0.835085</td>
<td>1.497897</td>
<td>1.388096</td>
<td>0.000207</td>
<td>-0.000150</td>
<td>0.000256</td>
<td>0_2_103_p1</td>
<td>p1_zout_geluiden_c1</td>
<td>...</td>
<td>24.228112</td>
<td>4.789636</td>
<td>2.425535</td>
<td>20.578791</td>
<td>silent</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>28.0</td>
<td>1.091680</td>
<td>0.835471</td>
<td>1.498397</td>
<td>1.388425</td>
<td>0.000216</td>
<td>-0.000146</td>
<td>0.000261</td>
<td>0_2_103_p1</td>
<td>p1_zout_geluiden_c1</td>
<td>...</td>
<td>24.272027</td>
<td>4.795086</td>
<td>2.429600</td>
<td>20.635705</td>
<td>silent</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
<td>nomovement</td>
</tr>
</tbody>
</table>

<p>15 rows × 534 columns</p>
</div>
</div>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-boersma_weenink25" class="csl-entry" role="listitem">
Boersma, Paul, and David Weenink. 2025. <span>“Praat: Doing Phonetics by Computer.”</span> <a href="http://www.praat.org/">http://www.praat.org/</a>.
</div>
<div id="ref-pouw_etal21b" class="csl-entry" role="listitem">
Pouw, Wim, Jan de Wit, Sara Bögels, Marlou Rasenberg, Branka Milivojevic, and Asli Ozyurek. 2021. <span>“Semantically <span>Related Gestures Move Alike</span>: <span>Towards</span> a <span>Distributional Semantics</span> of <span>Gesture Kinematics</span>.”</span> In <em>Digital <span>Human Modeling</span> and <span>Applications</span> in <span>Health</span>, <span>Safety</span>, <span>Ergonomics</span> and <span>Risk Management</span>. <span>Human Body</span>, <span>Motion</span> and <span>Behavior</span></em>, edited by Vincent G. Duffy, 269–87. Cham: Springer International Publishing. <a href="https://doi.org/10.1007/978-3-030-77817-0_20">https://doi.org/10.1007/978-3-030-77817-0_20</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>